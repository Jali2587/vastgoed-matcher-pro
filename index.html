<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vastgoed Matcher Pro AI - Enhanced + CSV Upload</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- CSV Parser -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Configuration -->
    <script>
        // JOUW ECHTE FIREBASE CONFIGURATIE
        const firebaseConfig = {
            apiKey: "AIzaSyD5daKmpLUMcxmOiAXkPkmiJrZ5kDG3HMo",
            authDomain: "vastgoed-matcher-mvp.firebaseapp.com",
            projectId: "vastgoed-matcher-mvp",
            storageBucket: "vastgoed-matcher-mvp.appspot.com",
            messagingSenderId: "785479169064",
            appId: "1:785479169064:web:eb328415e1277241df311d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        console.log('üî• Firebase initialized successfully!');
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Simple icon components to avoid React errors
        const PlusIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M12 5v14M5 12h14' }));
        
        const UsersIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2' }), React.createElement('circle', { cx: '9', cy: '7', r: '4' }), React.createElement('path', { d: 'M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75' }));
        
        const BuildingIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z' }), React.createElement('path', { d: 'M6 12h4h4' }), React.createElement('path', { d: 'M6 20h4h4' }), React.createElement('path', { d: 'M10 4h4' }), React.createElement('path', { d: 'M10 8h4' }));
        
        const StarIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polygon', { points: '12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26' }));
        
        const FilterIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polygon', { points: '22,3 2,3 10,12.46 10,19 14,21 14,12.46' }));
        
        const MailIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z' }), React.createElement('polyline', { points: '22,6 12,13 2,6' }));
        
        const PhoneIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z' }));
        
        const MapPinIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z' }), React.createElement('circle', { cx: '12', cy: '10', r: '3' }));
        
        const EuroIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M18.5 6.5a9 9 0 0 0-9 9v0a9 9 0 0 0 9 9M6 12h9' }));
        
        const TrendingUpIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polyline', { points: '22,7 13.5,15.5 8.5,10.5 2,17' }), React.createElement('polyline', { points: '16,7 22,7 22,13' }));
        
        const CalendarIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('rect', { x: '3', y: '4', width: '18', height: '18', rx: '2', ry: '2' }), React.createElement('line', { x1: '16', y1: '2', x2: '16', y2: '6' }), React.createElement('line', { x1: '8', y1: '2', x2: '8', y2: '6' }), React.createElement('line', { x1: '3', y1: '10', x2: '21', y2: '10' }));
        
        const AlertCircleIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '12', r: '10' }), React.createElement('line', { x1: '12', y1: '8', x2: '12', y2: '12' }), React.createElement('line', { x1: '12', y1: '16', x2: '12.01', y2: '16' }));
        
        const LogOutIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4' }), React.createElement('polyline', { points: '16,17 21,12 16,7' }), React.createElement('line', { x1: '21', y1: '12', x2: '9', y2: '12' }));
        
        const UserIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2' }), React.createElement('circle', { cx: '12', cy: '7', r: '4' }));
        
        const BrainIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M12 2a3 3 0 0 0-3 3 3 3 0 0 0-3 3v1a3 3 0 0 0 3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0 3-3V8a3 3 0 0 0-3-3 3 3 0 0 0-3-3z' }));
        
        const SearchIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '11', cy: '11', r: '8' }), React.createElement('path', { d: 'M21 21l-4.35-4.35' }));
        
        const FileTextIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }), React.createElement('polyline', { points: '14,2 14,8 20,8' }), React.createElement('line', { x1: '16', y1: '13', x2: '8', y2: '13' }), React.createElement('line', { x1: '16', y1: '17', x2: '8', y2: '17' }), React.createElement('polyline', { points: '10,9 9,9 8,9' }));
        
        const TargetIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '12', r: '10' }), React.createElement('circle', { cx: '12', cy: '12', r: '6' }), React.createElement('circle', { cx: '12', cy: '12', r: '2' }));
        
        const ZapIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polygon', { points: '13,2 3,14 12,14 11,22 21,10 12,10' }));
        
        const DollarSignIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('line', { x1: '12', y1: '1', x2: '12', y2: '23' }), React.createElement('path', { d: 'M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6' }));
        
        const UserCheckIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2' }), React.createElement('circle', { cx: '8.5', cy: '7', r: '4' }), React.createElement('polyline', { points: '17,11 19,13 23,9' }));
        
        const AwardIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '8', r: '7' }), React.createElement('polyline', { points: '8.21,13.89 7,23 12,20 17,23 15.79,13.88' }));
        
        const SettingsIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '12', r: '3' }), React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z' }));
        
        const EditIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7' }), React.createElement('path', { d: 'M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z' }));
        
        const TrashIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polyline', { points: '3,6 5,6 21,6' }), React.createElement('path', { d: 'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2' }), React.createElement('line', { x1: '10', y1: '11', x2: '10', y2: '17' }), React.createElement('line', { x1: '14', y1: '11', x2: '14', y2: '17' }));

        const PercentIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('line', { x1: '19', y1: '5', x2: '5', y2: '19' }), React.createElement('circle', { cx: '6.5', cy: '6.5', r: '2.5' }), React.createElement('circle', { cx: '17.5', cy: '17.5', r: '2.5' }));

        const ExternalLinkIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6' }), React.createElement('polyline', { points: '15,3 21,3 21,9' }), React.createElement('line', { x1: '10', y1: '14', x2: '21', y2: '3' }));

        // üî• NEW: CSV Upload Icon
        const UploadIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4' }), React.createElement('polyline', { points: '7,10 12,15 17,10' }), React.createElement('line', { x1: '12', y1: '15', x2: '12', y2: '3' }));

        // üî• NEW: Contacts/Database Icon  
        const DatabaseIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('ellipse', { cx: '12', cy: '5', rx: '9', ry: '3' }), React.createElement('path', { d: 'M21 12c0 1.66-4 3-9 3s-9-1.34-9-3' }), React.createElement('path', { d: 'M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5' }));

        // üî• NEW: Convert/Transform Icon
        const RefreshIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polyline', { points: '23,4 23,10 17,10' }), React.createElement('polyline', { points: '1,20 1,14 7,14' }), React.createElement('path', { d: 'M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15' }));

        const VastgoedInvesteerderMatcher = () => {
          const [user, setUser] = useState(null);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [investors, setInvestors] = useState([]);
          const [deals, setDeals] = useState([]);
          const [transactions, setTransactions] = useState([]);
          const [users, setUsers] = useState([]);
          const [matches, setMatches] = useState([]);
          const [showAddInvestor, setShowAddInvestor] = useState(false);
          const [showAddDeal, setShowAddDeal] = useState(false);
          const [showAuth, setShowAuth] = useState(true);
          const [aiInsights, setAiInsights] = useState({});
          const [isLoadingAI, setIsLoadingAI] = useState(false);
          
          const [showCommissionEditor, setShowCommissionEditor] = useState(false);
          const [editingDealCommission, setEditingDealCommission] = useState(null);
          const [currentTransaction, setCurrentTransaction] = useState(null);

          const [editingInvestor, setEditingInvestor] = useState(null);
          const [editingDeal, setEditingDeal] = useState(null);
          const [showEditInvestor, setShowEditInvestor] = useState(false);
          const [showEditDeal, setShowEditDeal] = useState(false);

          // üî• NEW: Broker Management State
          const [brokers, setBrokers] = useState([]);
          const [showAddBroker, setShowAddBroker] = useState(false);
          const [editingBroker, setEditingBroker] = useState(null);
          const [showEditBroker, setShowEditBroker] = useState(false);
          const [contactFilter, setContactFilter] = useState('all'); // all, investors, brokers

          // üî• NEW: CSV Contacts Management State
          const [contacts, setContacts] = useState([]);
          const [csvData, setCsvData] = useState([]);
          const [showCsvUpload, setShowCsvUpload] = useState(false);
          const [isUploadingCsv, setIsUploadingCsv] = useState(false);
          const [csvFilter, setCsvFilter] = useState('all'); // all, converted, unconverted
          const [showConvertModal, setShowConvertModal] = useState(false);
          const [convertingContact, setConvertingContact] = useState(null);

          // üî• ENHANCED AI MATCHING WITH SEMANTIC ANALYSIS
          const callOpenAI = async (prompt, type = 'analysis', data = null) => {
            setIsLoadingAI(true);
            
            try {
              const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, type, data })
              });
              
              if (response.ok) {
                const result = await response.json();
                setIsLoadingAI(false);
                return result.data;
              }
            } catch (error) {
              console.log('OpenAI API niet beschikbaar, gebruik demo data:', error);
            }
            
            // Enhanced fallback with semantic matching simulation
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const mockResponses = {
              enhanced_matching: {
                semanticScore: 85,
                semanticReasons: [
                  'Sterke match: "stabiele huurinkomsten" ‚Üî "gegarandeerde huurder 5 jaar"',
                  'Perfecte match: "geen renovatie" ‚Üî "turn-key appartement"', 
                  'Goede match: "duurzaamheid belangrijk" ‚Üî "energielabel A"',
                  'Match: "ervaring met appartementen" ‚Üî "luxe appartement complex"'
                ],
                conflictAnalysis: [],
                overallCompatibility: 92,
                pitchRecommendations: [
                  'Benadruk de gegarandeerde huurinkomsten van 5 jaar',
                  'Vermeld turn-key voordeel: direct rendement zonder werk',
                  'Highlight duurzaamheid: energielabel A en lage kosten',
                  'Toon vergelijkbare succesvolle projecten in portfolio'
                ]
              },
              investor_analysis: {
                financialStrength: 'Hoog - Stabiele inkomstenbron via vastgoedbeleggingen',
                riskAppetite: 'Gemiddeld tot hoog - Ervaren investeerder met diversified portfolio',
                marketKnowledge: 'Goed - Actief in Nederlandse vastgoedmarkt sinds 2015',
                preferredSectors: ['Residentieel', 'Commercieel retail'],
                projectTypePreference: ['Turn-key', 'Renovatie'],
                investmentStrategy: 'Buy-and-hold met focus op cashflow generatie',
                recommendations: 'Geschikt voor deals met stabiele huurinkomsten en potentieel voor waardestijging',
                behaviorProfile: 'Voorzichtige beslisser, graag veel informatie vooraf',
                investmentTimeline: 'Zoekt deals voor Q2-Q3 2024',
                marketSentiment: 'Positief over vastgoedmarkt, maar voorzichtig met nieuwe projecten'
              },
              deal_analysis: {
                marketPosition: 'Aantrekkelijk - Locatie in groeiende wijk met goede bereikbaarheid',
                projectTypeAnalysis: 'Turn-key voordeel: Direct rendement, lagere ontwikkelingsrisico\'s',
                competitiveAnalysis: 'Vergelijkbare panden in de buurt hebben 5-7% rendement',
                riskFactors: [
                  'Mogelijke leegstand bij huurwisseling', 
                  'Onderhoudskosten oudere panden',
                  'Marktvolatiliteit in de regio'
                ],
                opportunities: [
                  'Huurverhoging mogelijk door renovatie', 
                  'Waardestijging door buurtverbetering',
                  'Turn-key voordeel: Direct rendement, lagere ontwikkelingsrisico\'s',
                  'Renovatie kansen: Waardecreatie door modernisering',
                  'Transformatie potentieel: Functiewijziging verhoogt marktwaarde'
                ],
                priceAnalysis: 'Marktconform geprijsd, kleine onderhandelingsruimte',
                recommendation: 'Aanbevolen voor conservatieve tot gemiddelde risico investeerders',
                marketTrends: 'Prijzen in dit gebied stijgen 3-5% per jaar',
                demographicAnalysis: 'Populair bij young professionals en small families',
                futureOutlook: 'Positieve ontwikkeling verwacht door infrastructuurprojecten'
              },
              // üî• NEW: Contact Classification Analysis
              contact_classification: {
                suggestedType: data?.position?.toLowerCase()?.includes('investment') || 
                               data?.position?.toLowerCase()?.includes('fund') ||
                               data?.position?.toLowerCase()?.includes('capital') ? 'investor' : 
                               data?.position?.toLowerCase()?.includes('broker') ||
                               data?.position?.toLowerCase()?.includes('agent') ||
                               data?.position?.toLowerCase()?.includes('makelaar') ? 'broker' : 'unknown',
                confidence: 0.75,
                reasoning: [
                  'Functietitel analyse gebaseerd op keywords',
                  'Bedrijfsnaam analyse voor type organisatie',
                  'LinkedIn profiel indicatoren'
                ],
                suggestions: [
                  'Verifieer rol via LinkedIn profiel',
                  'Check bedrijfswebsite voor meer context',
                  'Overweeg beide categorie√´n als onzeker'
                ]
              }
            };

          // üî• SIMPLIFIED INVESTOR FORM
          const InvestorForm = ({ onSubmit, onCancel, editData = null }) => {
            const [formData, setFormData] = useState(editData || {
              naam: '',
              email: '',
              telefoon: '',
              bedrijf: '',
              locatie: '',
              minBudget: '',
              maxBudget: '',
              // üî• SIMPLIFIED LOCATION FIELDS
              voorkeursRegio: [],
              voorkeursLanden: [],
              locatieDetails: '', // üî• NEW: Free text for location preferences
              vastgoedTypes: [],
              projectTypes: [],
              risicoprofiel: 'Gemiddeld',
              gewenstRendement: '',
              investeringshorizon: 'Middellang',
              ervaringLevel: 'Gemiddeld',
              // üî• ENHANCED WITH SEMANTIC FIELDS
              investmentMotivatie: '', // üî• ENHANCED: For semantic matching
              bijzonderheden: '', // üî• NEW: Additional notes for semantic matching
              communicatieVoorkeur: 'Email',
              beschikbaarheid: 'Direct'
            });

            // üî• SIMPLIFIED LOCATION OPTIONS
            const hoofdLanden = [
              'Nederland', 'Duitsland', 'Frankrijk', 'Spanje', 'Zwitserland', 
              'Belgi√´', 'Verenigd Koninkrijk', 'Itali√´', 'Oostenrijk', 
              'Tsjechi√´', 'Polen', 'Portugal', 'Scandinavi√´'
            ];

            const regios = ['West-Europa', 'Zuid-Europa', 'Noord-Europa', 'Oost-Europa'];

            const handleLandChange = (land) => {
              setFormData(prev => ({
                ...prev,
                voorkeursLanden: (prev.voorkeursLanden || []).includes(land)
                  ? (prev.voorkeursLanden || []).filter(l => l !== land)
                  : [...(prev.voorkeursLanden || []), land]
              }));
            };

            const handleRegioChange = (regio) => {
              setFormData(prev => ({
                ...prev,
                voorkeursRegio: (prev.voorkeursRegio || []).includes(regio)
                  ? (prev.voorkeursRegio || []).filter(r => r !== regio)
                  : [...(prev.voorkeursRegio || []), regio]
              }));
            };

            const handleProjectTypeChange = (type) => {
              setFormData(prev => ({
                ...prev,
                projectTypes: (prev.projectTypes || []).includes(type)
                  ? (prev.projectTypes || []).filter(t => t !== type)
                  : [...(prev.projectTypes || []), type]
              }));
            };

            const handleTypeChange = (type) => {
              setFormData(prev => ({
                ...prev,
                vastgoedTypes: (prev.vastgoedTypes || []).includes(type)
                  ? (prev.vastgoedTypes || []).filter(t => t !== type)
                  : [...(prev.vastgoedTypes || []), type]
              }));
            };

            const handleSubmit = (e) => {
              e.preventDefault();
              onSubmit(formData);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-4xl h-full max-h-[95vh] flex flex-col">
                  <div className="p-6 border-b">
                    <div className="flex items-center justify-between">
                      <h3 className="text-xl font-bold">
                        {editData ? '‚úèÔ∏è Investeerder Bewerken' : '‚ûï Nieuwe Investeerder Toevoegen'}
                      </h3>
                      <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <p className="text-sm text-purple-600 mt-2">
                      üî• Enhanced: Vereenvoudigde invoer met AI semantic matching
                    </p>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-6">
                    <form onSubmit={handleSubmit} id="investor-form">
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Basis Informatie</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Naam *</label>
                            <input
                              type="text"
                              value={formData.naam}
                              onChange={(e) => setFormData({...formData, naam: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Email *</label>
                            <input
                              type="email"
                              value={formData.email}
                              onChange={(e) => setFormData({...formData, email: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Telefoon</label>
                            <input
                              type="tel"
                              value={formData.telefoon}
                              onChange={(e) => setFormData({...formData, telefoon: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Bedrijf/Fonds</label>
                            <input
                              type="text"
                              value={formData.bedrijf}
                              onChange={(e) => setFormData({...formData, bedrijf: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Naam van bedrijf of fonds"
                            />
                          </div>
                          <div className="md:col-span-2">
                            <label className="block text-sm font-medium mb-1">Huidige Locatie/Hoofdkantoor</label>
                            <input
                              type="text"
                              value={formData.locatie}
                              onChange={(e) => setFormData({...formData, locatie: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Bijvoorbeeld: Amsterdam, Berlijn, etc."
                            />
                          </div>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Budget & Financi√´n</h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Min Budget (‚Ç¨) *</label>
                            <input
                              type="number"
                              value={formData.minBudget}
                              onChange={(e) => setFormData({...formData, minBudget: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Max Budget (‚Ç¨) *</label>
                            <input
                              type="number"
                              value={formData.maxBudget}
                              onChange={(e) => setFormData({...formData, maxBudget: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Gewenst Rendement (%) *</label>
                            <input
                              type="number"
                              step="0.1"
                              value={formData.gewenstRendement}
                              onChange={(e) => setFormData({...formData, gewenstRendement: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                        </div>
                      </div>

                      {/* üî• SIMPLIFIED LOCATION PREFERENCES */}
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">üó∫Ô∏è Locatie Voorkeuren (Vereenvoudigd)</h4>
                        
                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-2">Voorkeurs Regio's</label>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {regios.map(regio => (
                              <label key={regio} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.voorkeursRegio || []).includes(regio)}
                                  onChange={() => handleRegioChange(regio)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{regio}</span>
                              </label>
                            ))}
                          </div>
                        </div>

                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-2">Voorkeurs Landen</label>
                          <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto border rounded p-3">
                            {hoofdLanden.map(land => (
                              <label key={land} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.voorkeursLanden || []).includes(land)}
                                  onChange={() => handleLandChange(land)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{land}</span>
                              </label>
                            ))}
                          </div>
                        </div>

                        {/* üî• NEW: FREE TEXT LOCATION DETAILS */}
                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-2">
                            üî• Specifieke Locatie Eisen (Vrije Tekst)
                          </label>
                          <textarea
                            value={formData.locatieDetails}
                            onChange={(e) => setFormData({...formData, locatieDetails: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Amsterdam centrum, nabij openbaar vervoer, geen Zuidoost. Berlijn Mitte of Prenzlauer Berg. Goede bereikbaarheid belangrijk..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            üí° AI gebruikt deze tekst voor slimme matching met deal beschrijvingen
                          </p>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Vastgoed Voorkeuren</h4>
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Vastgoed Types</label>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {['Appartement', 'Kantoor', 'Retail', 'Industrie', 'Woning', 'Hotel', 'Studenten', 'Zorgvastgoed'].map(type => (
                              <label key={type} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.vastgoedTypes || []).includes(type)}
                                  onChange={() => handleTypeChange(type)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{type}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-2">Project Types</label>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                            {['Turn-key', 'Renovatie', 'Transformatie', 'Ontwikkeling', 'Gemengd'].map(type => (
                              <label key={type} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.projectTypes || []).includes(type)}
                                  onChange={() => handleProjectTypeChange(type)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{type}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                      </div>

                      {/* üî• ENHANCED SEMANTIC FIELDS */}
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">ü§ñ Investment Profiel (Voor AI Matching)</h4>
                        
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">
                            Investment Motivatie & Doelen
                          </label>
                          <textarea
                            value={formData.investmentMotivatie}
                            onChange={(e) => setFormData({...formData, investmentMotivatie: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Zoek stabiele huurinkomsten voor pensioenopbouw. Geen renovatie projecten, liever turn-key. Duurzaamheid steeds belangrijker. Ervaring met studentenhuisvesting..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            üí° AI matcht deze tekst met deal beschrijvingen voor betere matches
                          </p>
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">
                            Bijzonderheden & Voorkeuren
                          </label>
                          <textarea
                            value={formData.bijzonderheden}
                            onChange={(e) => setFormData({...formData, bijzonderheden: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Voorkeur voor energiezuinige panden. Geen ground floor retail. Ervaring met vastgoedbeheer. Snel beslissen bij goede deals..."
                          />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Risicoprofiel</label>
                            <select
                              value={formData.risicoprofiel}
                              onChange={(e) => setFormData({...formData, risicoprofiel: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="Conservatief">Conservatief</option>
                              <option value="Gemiddeld">Gemiddeld</option>
                              <option value="Agressief">Agressief</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Ervaring Level</label>
                            <select
                              value={formData.ervaringLevel}
                              onChange={(e) => setFormData({...formData, ervaringLevel: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="Beginner">Beginner</option>
                              <option value="Gemiddeld">Gemiddeld</option>
                              <option value="Ervaren">Ervaren</option>
                              <option value="Expert">Expert</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Beschikbaarheid</label>
                            <select
                              value={formData.beschikbaarheid}
                              onChange={(e) => setFormData({...formData, beschikbaarheid: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="Direct">Direct beschikbaar</option>
                              <option value="Binnen 1 maand">Binnen 1 maand</option>
                              <option value="Binnen 3 maanden">Binnen 3 maanden</option>
                              <option value="Flexibel">Flexibel</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                  
                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-end space-x-4">
                      <button
                        type="button"
                        onClick={onCancel}
                        className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                      >
                        Annuleren
                      </button>
                      <button
                        type="submit"
                        form="investor-form"
                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        {editData ? 'üíæ Opslaan' : '‚ûï Toevoegen'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // üî• NEW: BROKER FORM
          const BrokerForm = ({ onSubmit, onCancel, editData = null }) => {
            const [formData, setFormData] = useState(editData || {
              naam: '',
              email: '',
              telefoon: '',
              bedrijf: '',
              locatie: '',
              specialisaties: [],
              werkgebied: [],
              ervaringJaren: '',
              trackRecord: '',
              commissieStructuur: '',
              locatieDetails: '',
              werkwijze: '',
              bijzonderheden: ''
            });

            const specialisatieOpties = [
              'Commercieel', 'Residentieel', 'Industrie', 'Retail', 
              'Kantoren', 'Logistiek', 'Hotels', 'Zorgvastgoed'
            ];

            const werkgebiedOpties = [
              'Amsterdam', 'Rotterdam', 'Utrecht', 'Den Haag', 'Eindhoven',
              'Tilburg', 'Haarlem', 'Almere', 'Breda', 'Nijmegen',
              'Berlijn', 'M√ºnchen', 'Hamburg', 'Frankfurt', 'Parijs',
              'Madrid', 'Barcelona', 'Z√ºrich', 'Gen√®ve'
            ];

            const handleSpecialisatieChange = (specialisatie) => {
              setFormData(prev => ({
                ...prev,
                specialisaties: (prev.specialisaties || []).includes(specialisatie)
                  ? (prev.specialisaties || []).filter(s => s !== specialisatie)
                  : [...(prev.specialisaties || []), specialisatie]
              }));
            };

            const handleWerkgebiedChange = (gebied) => {
              setFormData(prev => ({
                ...prev,
                werkgebied: (prev.werkgebied || []).includes(gebied)
                  ? (prev.werkgebied || []).filter(g => g !== gebied)
                  : [...(prev.werkgebied || []), gebied]
              }));
            };

            const handleSubmit = (e) => {
              e.preventDefault();
              onSubmit(formData);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-4xl h-full max-h-[95vh] flex flex-col">
                  <div className="p-6 border-b">
                    <div className="flex items-center justify-between">
                      <h3 className="text-xl font-bold">
                        {editData ? '‚úèÔ∏è Broker Bewerken' : '‚ûï Nieuwe Broker Toevoegen'}
                      </h3>
                      <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <p className="text-sm text-blue-600 mt-2">
                      üè¢ Broker specialiseert in vastgoed deal sourcing en matching
                    </p>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-6">
                    <form onSubmit={handleSubmit} id="broker-form">
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Basis Informatie</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Naam *</label>
                            <input
                              type="text"
                              value={formData.naam}
                              onChange={(e) => setFormData({...formData, naam: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Email *</label>
                            <input
                              type="email"
                              value={formData.email}
                              onChange={(e) => setFormData({...formData, email: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Telefoon</label>
                            <input
                              type="tel"
                              value={formData.telefoon}
                              onChange={(e) => setFormData({...formData, telefoon: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Bedrijf/Kantoor</label>
                            <input
                              type="text"
                              value={formData.bedrijf}
                              onChange={(e) => setFormData({...formData, bedrijf: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Naam van makelaarskantoor"
                            />
                          </div>
                          <div className="md:col-span-2">
                            <label className="block text-sm font-medium mb-1">Huidige Locatie/Hoofdkantoor</label>
                            <input
                              type="text"
                              value={formData.locatie}
                              onChange={(e) => setFormData({...formData, locatie: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Bijvoorbeeld: Amsterdam, Berlijn, etc."
                            />
                          </div>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Professionele Details</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Ervaring (jaren)</label>
                            <input
                              type="number"
                              value={formData.ervaringJaren}
                              onChange={(e) => setFormData({...formData, ervaringJaren: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              min="0"
                              max="50"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Commissie Structuur</label>
                            <input
                              type="text"
                              value={formData.commissieStructuur}
                              onChange={(e) => setFormData({...formData, commissieStructuur: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Bijvoorbeeld: 2.5% koper, 2.5% verkoper"
                            />
                          </div>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Specialisaties</h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                          {specialisatieOpties.map(specialisatie => (
                            <label key={specialisatie} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                              <input
                                type="checkbox"
                                checked={(formData.specialisaties || []).includes(specialisatie)}
                                onChange={() => handleSpecialisatieChange(specialisatie)}
                                className="text-blue-600"
                              />
                              <span className="text-sm">{specialisatie}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Werkgebied</h4>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto border rounded p-3">
                          {werkgebiedOpties.map(gebied => (
                            <label key={gebied} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                              <input
                                type="checkbox"
                                checked={(formData.werkgebied || []).includes(gebied)}
                                onChange={() => handleWerkgebiedChange(gebied)}
                                className="text-blue-600"
                              />
                              <span className="text-sm">{gebied}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">ü§ñ Professioneel Profiel (Voor AI Matching)</h4>
                        
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Track Record & Ervaring</label>
                          <textarea
                            value={formData.trackRecord}
                            onChange={(e) => setFormData({...formData, trackRecord: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Gespecialiseerd in kantoorpanden ‚Ç¨1M+, 120+ deals afgelopen 5 jaar. Focus op Amsterdam Zuidas en Noord. Ervaring met internationale investeerders..."
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Werkwijze & Aanpak</label>
                          <textarea
                            value={formData.werkwijze}
                            onChange={(e) => setFormData({...formData, werkwijze: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Proactieve deal sourcing, uitgebreid netwerk investeerders. Snelle besluitvorming, transparante communicatie. Spreekt vloeiend Engels en Duits..."
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Locatie Details & Specialiteiten</label>
                          <textarea
                            value={formData.locatieDetails}
                            onChange={(e) => setFormData({...formData, locatieDetails: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Actief in Randstad, specialiteit Amsterdam Noord en Zuidas. Goede connecties in Berlijn Mitte. Focus op off-market deals..."
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Bijzonderheden</label>
                          <textarea
                            value={formData.bijzonderheden}
                            onChange={(e) => setFormData({...formData, bijzonderheden: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: RICS gecertificeerd. Ervaring met internationale investeerders. Netwerk van family offices. Specialiteit duurzame vastgoed projecten..."
                          />
                        </div>
                      </div>
                    </form>
                  </div>
                  
                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-end space-x-4">
                      <button
                        type="button"
                        onClick={onCancel}
                        className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                      >
                        Annuleren
                      </button>
                      <button
                        type="submit"
                        form="broker-form"
                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        {editData ? 'üíæ Opslaan' : '‚ûï Toevoegen'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          const DealForm = ({ onSubmit, onCancel, editData = null }) => {
            const [formData, setFormData] = useState(editData || {
              titel: '',
              locatie: '',
              type: '',
              projectType: '',
              prijs: '',
              verwachtRendement: '',
              risico: 'Gemiddeld',
              beschrijving: '',
              bijzonderheden: '', // üî• NEW: For semantic matching
              oppervlakte: '',
              bouwjaar: '',
              huurpotentie: '',
              status: 'Beschikbaar',
              bedrijfFonds: '',
              contactpersoon: '',
              telefoon: '',
              email: ''
            });

            const handleSubmit = (e) => {
              e.preventDefault();
              onSubmit(formData);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-4xl h-full max-h-[95vh] flex flex-col">
                  <div className="p-6 border-b">
                    <div className="flex items-center justify-between">
                      <h3 className="text-xl font-bold">
                        {editData ? '‚úèÔ∏è Deal Bewerken' : '‚ûï Nieuwe Deal Toevoegen'}
                      </h3>
                      <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <p className="text-sm text-purple-600 mt-2">
                      üî• Enhanced: Uitgebreide beschrijvingen voor AI semantic matching
                    </p>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-6">
                    <form onSubmit={handleSubmit} id="deal-form">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                          <label className="block text-sm font-medium mb-1">Titel *</label>
                          <input
                            type="text"
                            value={formData.titel}
                            onChange={(e) => setFormData({...formData, titel: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Bedrijf/Fonds</label>
                          <input
                            type="text"
                            value={formData.bedrijfFonds}
                            onChange={(e) => setFormData({...formData, bedrijfFonds: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Naam van bedrijf of fonds"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Contactpersoon</label>
                          <input
                            type="text"
                            value={formData.contactpersoon}
                            onChange={(e) => setFormData({...formData, contactpersoon: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Naam contactpersoon"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Telefoon</label>
                          <input
                            type="tel"
                            value={formData.telefoon}
                            onChange={(e) => setFormData({...formData, telefoon: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Telefoonnummer"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Email</label>
                          <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Email adres"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Locatie *</label>
                          <input
                            type="text"
                            value={formData.locatie}
                            onChange={(e) => setFormData({...formData, locatie: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Bijvoorbeeld: Amsterdam, Berlijn, etc."
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Type *</label>
                          <select
                            value={formData.type}
                            onChange={(e) => setFormData({...formData, type: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          >
                            <option value="">Selecteer type</option>
                            <option value="Appartement">Appartement</option>
                            <option value="Kantoor">Kantoor</option>
                            <option value="Retail">Retail</option>
                            <option value="Industrie">Industrie</option>
                            <option value="Woning">Woning</option>
                            <option value="Hotel">Hotel</option>
                            <option value="Studenten">Studenten</option>
                            <option value="Zorgvastgoed">Zorgvastgoed</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Project Type *</label>
                          <select
                            value={formData.projectType}
                            onChange={(e) => setFormData({...formData, projectType: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          >
                            <option value="">Selecteer project type</option>
                            <option value="Turn-key">Turn-key - Kant-en-klaar</option>
                            <option value="Renovatie">Renovatie - Opknappen</option>
                            <option value="Transformatie">Transformatie - Functiewijziging</option>
                            <option value="Ontwikkeling">Ontwikkeling - Nieuwbouw</option>
                            <option value="Gemengd">Gemengd - Combinatie</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Prijs (‚Ç¨) *</label>
                          <input
                            type="number"
                            value={formData.prijs}
                            onChange={(e) => setFormData({...formData, prijs: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Verwacht Rendement (%) *</label>
                          <input
                            type="number"
                            step="0.1"
                            value={formData.verwachtRendement}
                            onChange={(e) => setFormData({...formData, verwachtRendement: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Risico Level</label>
                          <select
                            value={formData.risico}
                            onChange={(e) => setFormData({...formData, risico: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="Laag">Laag</option>
                            <option value="Gemiddeld">Gemiddeld</option>
                            <option value="Hoog">Hoog</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Oppervlakte (m¬≤)</label>
                          <input
                            type="number"
                            value={formData.oppervlakte}
                            onChange={(e) => setFormData({...formData, oppervlakte: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Bouwjaar</label>
                          <input
                            type="number"
                            value={formData.bouwjaar}
                            onChange={(e) => setFormData({...formData, bouwjaar: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Huurpotentie (‚Ç¨/maand)</label>
                          <input
                            type="number"
                            value={formData.huurpotentie}
                            onChange={(e) => setFormData({...formData, huurpotentie: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                      </div>
                      
                      {/* üî• ENHANCED DESCRIPTIONS FOR SEMANTIC MATCHING */}
                      <div className="mb-6">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">ü§ñ Deal Beschrijving (Voor AI Matching)</h4>
                        
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-1">Hoofdbeschrijving</label>
                          <textarea
                            value={formData.beschrijving}
                            onChange={(e) => setFormData({...formData, beschrijving: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Kant-en-klaar nieuwbouw appartement in opkomende wijk. Energielabel A, zonnepanelen. Gegarandeerde huurder voor 5 jaar via corporatie. Nabij metro, 15 min naar centrum..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            üí° AI matcht deze tekst met investeerder motivaties
                          </p>
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-1">
                            üî• Bijzonderheden & USP's
                          </label>
                          <textarea
                            value={formData.bijzonderheden}
                            onChange={(e) => setFormData({...formData, bijzonderheden: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Duurzaam gebouwd, lage servicekosten. Professioneel beheer beschikbaar. Uitstekende buurt met goede voorzieningen. Turn-key: direct rendement, geen werk aan..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            üí° Extra details die AI gebruikt voor slimme matching
                          </p>
                        </div>
                      </div>
                    </form>
                  </div>
                  
                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-end space-x-4">
                      <button
                        type="button"
                        onClick={onCancel}
                        className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                      >
                        Annuleren
                      </button>
                      <button
                        type="submit"
                        form="deal-form"
                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        {editData ? 'üíæ Opslaan' : '‚ûï Toevoegen'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

            setIsLoadingAI(false);
            
            if (type === 'enhanced_matching') return mockResponses.enhanced_matching;
            if (type === 'investor_analysis') return mockResponses.investor_analysis;
            if (type === 'deal_analysis') return mockResponses.deal_analysis;
            if (type === 'contact_classification') return mockResponses.contact_classification;
            
            return mockResponses.enhanced_matching;
          };

          // üî• NEW: CSV Upload and Contact Management Functions
          const handleCsvUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              complete: function(results) {
                console.log('üìÑ CSV geparsed:', results.data);
                
                const processedData = results.data.map((row, index) => ({
                  id: `csv_${Date.now()}_${index}`,
                  firstName: row['First Name'] || row['first_name'] || row['naam'] || '',
                  lastName: row['Last Name'] || row['last_name'] || row['achternaam'] || '',
                  fullName: (row['First Name'] || '') + ' ' + (row['Last Name'] || ''),
                  email: row['Email Address'] || row['email'] || row['e-mail'] || '',
                  company: row['Company'] || row['company'] || row['bedrijf'] || '',
                  position: row['Position'] || row['position'] || row['functie'] || '',
                  linkedin: row['URL'] || row['linkedin'] || row['LinkedIn URL'] || '',
                  phone: row['Phone'] || row['phone'] || row['telefoon'] || '',
                  location: row['Location'] || row['location'] || row['locatie'] || '',
                  notes: row['Notes'] || row['notes'] || row['opmerkingen'] || '',
                  source: 'csv_upload',
                  uploadedAt: new Date().toISOString(),
                  isConverted: false,
                  convertedTo: null,
                  owner_id: user.id
                })).filter(contact => contact.firstName || contact.lastName || contact.email);
                
                setCsvData(processedData);
                setShowCsvUpload(true);
              },
              error: function(error) {
                console.error('‚ùå CSV parse error:', error);
                alert('Fout bij lezen CSV bestand: ' + error.message);
              }
            });
          };

          const uploadContactsToFirebase = async () => {
            if (!csvData.length) {
              alert('Geen contacten om te uploaden');
              return;
            }

            setIsUploadingCsv(true);
            
            try {
              console.log('üíæ Uploading contacts to Firebase...');
              
              const batch = db.batch();
              
              csvData.forEach(contact => {
                const docRef = db.collection('contacts').doc();
                batch.set(docRef, {
                  ...contact,
                  id: docRef.id,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              });
              
              await batch.commit();
              
              // Reload contacts
              await loadContacts();
              
              // Clear upload state
              setCsvData([]);
              setShowCsvUpload(false);
              
              console.log('‚úÖ Contacts uploaded to Firebase');
              alert(`‚úÖ ${csvData.length} contacten succesvol ge√ºpload!`);
            } catch (error) {
              console.error('‚ùå Error uploading contacts:', error);
              alert('Fout bij uploaden contacten: ' + error.message);
            } finally {
              setIsUploadingCsv(false);
            }
          };

          const loadContacts = async () => {
            if (!user) return;
            
            try {
              console.log('üìä Loading contacts from Firebase...');
              
              const contactsSnapshot = await db.collection('contacts').get();
              const contactsData = contactsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setContacts(contactsData);
              
              console.log('‚úÖ Contacts loaded from Firebase:', contactsData.length);
            } catch (error) {
              console.error('‚ùå Error loading contacts from Firebase:', error);
            }
          };

          const convertContactToInvestor = async (contact) => {
            try {
              console.log('üîÑ Converting contact to investor:', contact.id);
              
              const investorData = {
                naam: contact.fullName || `${contact.firstName} ${contact.lastName}`.trim(),
                email: contact.email,
                telefoon: contact.phone || '',
                bedrijf: contact.company || '',
                locatie: contact.location || '',
                minBudget: 0,
                maxBudget: 0,
                voorkeursRegio: [],
                voorkeursLanden: [],
                locatieDetails: '',
                vastgoedTypes: [],
                projectTypes: [],
                risicoprofiel: 'Gemiddeld',
                gewenstRendement: 0,
                investeringshorizon: 'Middellang',
                ervaringLevel: 'Gemiddeld',
                investmentMotivatie: contact.notes || '',
                bijzonderheden: `Geconverteerd van contact. Positie: ${contact.position}`,
                communicatieVoorkeur: 'Email',
                beschikbaarheid: 'Direct',
                owner_id: user.id,
                convertedFrom: contact.id,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('investors').add(investorData);
              
              // Update contact as converted
              await db.collection('contacts').doc(contact.id).update({
                isConverted: true,
                convertedTo: 'investor',
                convertedId: docRef.id,
                convertedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              // Update local state
              setInvestors(prev => [...prev, { id: docRef.id, ...investorData, created_at: new Date().toISOString() }]);
              setContacts(prev => prev.map(c => 
                c.id === contact.id ? { ...c, isConverted: true, convertedTo: 'investor' } : c
              ));
              
              console.log('‚úÖ Contact converted to investor:', docRef.id);
              alert('‚úÖ Contact succesvol geconverteerd naar investeerder!');
            } catch (error) {
              console.error('‚ùå Error converting contact to investor:', error);
              alert('Fout bij converteren naar investeerder: ' + error.message);
            }
          };

          const convertContactToBroker = async (contact) => {
            try {
              console.log('üîÑ Converting contact to broker:', contact.id);
              
              const brokerData = {
                naam: contact.fullName || `${contact.firstName} ${contact.lastName}`.trim(),
                email: contact.email,
                telefoon: contact.phone || '',
                bedrijf: contact.company || '',
                locatie: contact.location || '',
                specialisaties: [],
                werkgebied: [],
                ervaringJaren: 0,
                trackRecord: contact.notes || '',
                commissieStructuur: '',
                locatieDetails: '',
                werkwijze: `Geconverteerd van contact. Positie: ${contact.position}`,
                bijzonderheden: '',
                owner_id: user.id,
                convertedFrom: contact.id,
                import_source: 'contact_conversion',
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('brokers').add(brokerData);
              
              // Update contact as converted
              await db.collection('contacts').doc(contact.id).update({
                isConverted: true,
                convertedTo: 'broker',
                convertedId: docRef.id,
                convertedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              // Update local state
              setBrokers(prev => [...prev, { id: docRef.id, ...brokerData, created_at: new Date().toISOString() }]);
              setContacts(prev => prev.map(c => 
                c.id === contact.id ? { ...c, isConverted: true, convertedTo: 'broker' } : c
              ));
              
              console.log('‚úÖ Contact converted to broker:', docRef.id);
              alert('‚úÖ Contact succesvol geconverteerd naar broker!');
            } catch (error) {
              console.error('‚ùå Error converting contact to broker:', error);
              alert('Fout bij converteren naar broker: ' + error.message);
            }
          };

          const deleteContact = async (contactId) => {
            if (confirm('Weet je zeker dat je dit contact wilt verwijderen?')) {
              try {
                console.log('üóëÔ∏è Deleting contact from Firebase...');
                
                await db.collection('contacts').doc(contactId).delete();
                setContacts(prev => prev.filter(c => c.id !== contactId));
                
                console.log('‚úÖ Contact deleted from Firebase:', contactId);
                alert('‚úÖ Contact succesvol verwijderd!');
              } catch (error) {
                console.error('‚ùå Error deleting contact:', error);
                alert('Fout bij verwijderen contact: ' + error.message);
              }
            }
          };

          const getContactClassification = async (contact) => {
            const prompt = `
CONTACT CLASSIFICATIE ANALYSE:

CONTACT GEGEVENS:
- Naam: ${contact.fullName}
- Bedrijf: ${contact.company}
- Positie: ${contact.position}
- Email: ${contact.email}
- LinkedIn: ${contact.linkedin}
- Notities: ${contact.notes}

ANALYSEER en bepaal of dit contact:
1. INVESTOR is (vastgoedinvesteerder, fund manager, family office, etc.)
2. BROKER is (makelaar, vastgoed agent, deal sourcer, etc.)
3. BEIDE kan zijn
4. ONDUIDELIJK is

Geef aanbeveling met confidence score en redenering.
            `;
            
            return await callOpenAI(prompt, 'contact_classification', contact);
          };

          // FIREBASE DATABASE FUNCTIES (unchanged)
          const loadData = async () => {
            if (!user) return;
            
            try {
              console.log('üìä Loading data from Firebase...');
              
              const usersSnapshot = await db.collection('users').get();
              const usersData = usersSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setUsers(usersData);
              
              const investorsSnapshot = await db.collection('investors').get();
              const investorsData = investorsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setInvestors(investorsData);

              // üî• NEW: Load brokers
              const brokersSnapshot = await db.collection('brokers').get();
              const brokersData = brokersSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setBrokers(brokersData);
              
              const dealsSnapshot = await db.collection('deals').get();
              const dealsData = dealsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setDeals(dealsData);
              
              const transactionsSnapshot = await db.collection('transactions').get();
              const transactionsData = transactionsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setTransactions(transactionsData);

              // üî• NEW: Load contacts
              await loadContacts();
              
              console.log('‚úÖ Data loaded from Firebase:', {
                users: usersData.length,
                investors: investorsData.length,
                brokers: brokersData.length,
                deals: dealsData.length,
                transactions: transactionsData.length
              });
              
            } catch (error) {
              console.error('‚ùå Error loading data from Firebase:', error);
              console.log('üìã Loading demo data as fallback...');
              await loadDemoData();
            }
          };

          const loadDemoData = async () => {
            console.log('üé≠ Loading demo data...');
            
            const demoUsers = [
              { id: user.id, name: user.name, email: user.email, company: user.company, role: user.role || 'agent' }
            ];
            setUsers(demoUsers);
            
            const demoInvestors = [
              {
                id: 'demo1',
                naam: 'Peter van der Berg',
                email: 'peter@example.com',
                telefoon: '06-12345678',
                bedrijf: 'Berg Investments',
                locatie: 'Amsterdam',
                minBudget: 100000,
                maxBudget: 500000,
                // üî• SIMPLIFIED LOCATION FIELDS
                voorkeursLanden: ['Nederland', 'Duitsland'],
                voorkeursRegio: ['West-Europa'],
                locatieDetails: 'Amsterdam centrum bij de ring, nabij openbaar vervoer. Liever geen Zuidoost of Noord.',
                vastgoedTypes: ['Appartement', 'Kantoor'],
                projectTypes: ['Turn-key', 'Renovatie'],
                risicoprofiel: 'Gemiddeld',
                gewenstRendement: 6,
                investeringshorizon: 'Lang termijn',
                ervaringLevel: 'Ervaren',
                beschikbaarheid: 'Direct',
                communicatieVoorkeur: 'Telefoon',
                // üî• ENHANCED WITH SEMANTIC CONTENT
                investmentMotivatie: 'Zoek stabiele huurinkomsten voor pensioenopbouw. Geen renovatie projecten, liever turn-key appartementen. Ervaring met studentenhuisvesting. Duurzaamheid steeds belangrijker.',
                bijzonderheden: 'Heeft voorkeur voor energiezuinige panden. Geen ground floor retail. Ervaring met vastgoedbeheer.',
                owner_id: user.id,
                created_at: new Date().toISOString()
              }
            ];

            // üî• NEW: Demo Brokers
            const demoBrokers = [
              {
                id: 'broker1',
                naam: 'Sarah de Vries',
                email: 'sarah@vastgoedpro.nl',
                telefoon: '020-7654321',
                bedrijf: 'VastgoedPro Makelaars',
                locatie: 'Amsterdam',
                specialisaties: ['Commercieel', 'Kantoren', 'Retail'],
                werkgebied: ['Amsterdam', 'Haarlem', 'Almere'],
                ervaringJaren: 8,
                trackRecord: 'Gespecialiseerd in commercieel vastgoed ‚Ç¨500K-‚Ç¨5M. 120+ deals afgelopen 5 jaar. Focus op kantoorpanden en retail.',
                commissieStructuur: '2.5% koper, 2.5% verkoper. Exclusieve deals 3%.',
                locatieDetails: 'Actief in Randstad, specialiteit Amsterdam Noord en Zuidas.',
                werkwijze: 'Proactieve deal sourcing, uitgebreid netwerk van investeerders. Snelle besluitvorming, transparante communicatie.',
                bijzonderheden: 'Spreekt vloeiend Engels en Duits. Ervaring met internationale investeerders. RICS gecertificeerd.',
                import_source: 'manual',
                owner_id: user.id,
                created_at: new Date().toISOString()
              }
            ];

            // üî• NEW: Demo Contacts
            const demoContacts = [
              {
                id: 'contact1',
                firstName: 'Michael',
                lastName: 'Johnson',
                fullName: 'Michael Johnson',
                email: 'michael.johnson@realestatefund.com',
                company: 'European Real Estate Fund',
                position: 'Investment Director',
                linkedin: 'https://linkedin.com/in/michaeljohnson',
                phone: '+31-20-1234567',
                location: 'Amsterdam',
                notes: 'Focus on commercial real estate ‚Ç¨1M+, interested in Netherlands and Germany markets',
                source: 'demo_data',
                uploadedAt: new Date().toISOString(),
                isConverted: false,
                convertedTo: null,
                owner_id: user.id,
                created_at: new Date().toISOString()
              },
              {
                id: 'contact2',
                firstName: 'Emma',
                lastName: 'Schmidt',
                fullName: 'Emma Schmidt',
                email: 'emma@berlinproperties.de',
                company: 'Berlin Properties GmbH',
                position: 'Senior Real Estate Agent',
                linkedin: 'https://linkedin.com/in/emmaSchmidt',
                phone: '+49-30-9876543',
                location: 'Berlin',
                notes: 'Specializes in residential and mixed-use developments. Strong network of international investors.',
                source: 'demo_data',
                uploadedAt: new Date().toISOString(),
                isConverted: false,
                convertedTo: null,
                owner_id: user.id,
                created_at: new Date().toISOString()
              }
            ];
            
            const demoDeals = [
              {
                id: 'demo1',
                titel: 'Modern Appartement Amsterdam',
                locatie: 'Amsterdam',
                type: 'Appartement',
                projectType: 'Turn-key',
                prijs: 350000,
                verwachtRendement: 5.5,
                risico: 'Gemiddeld',
                // üî• ENHANCED DESCRIPTION FOR SEMANTIC MATCHING  
                beschrijving: 'Kant-en-klaar nieuwbouw appartement in opkomende wijk Noord. Energielabel A, zonnepanelen, warmtepomp. Gegarandeerde huurder voor 5 jaar via corporatie. Nabij metro, 15 min naar centrum. Turn-key: direct rendement, geen werk aan.',
                oppervlakte: 85,
                bouwjaar: 2020,
                huurpotentie: 1800,
                status: 'Beschikbaar',
                bedrijfFonds: 'Demo Vastgoed B.V.',
                bijzonderheden: 'Duurzaam gebouwd, lage servicekosten. Professioneel beheer beschikbaar. Uitstekende buurt met goede voorzieningen.',
                contactpersoon: 'Maria Janssen',
                telefoon: '020-1234567',
                email: 'maria@demovastgoed.nl',
                isRelevant: true,
                ourScore: 8.5,
                aiAnalyzed: false,
                owner_id: user.id,
                created_at: new Date().toISOString(),
                commissionStructure: {
                  total_rate: 0.025,
                  participants: [
                    { 
                      role: 'deal_owner', 
                      user_id: user.id, 
                      percentage: 60, 
                      fixed_amount: 0, 
                      type: 'percentage',
                      name: user.name,
                      is_external: false
                    }
                  ]
                }
              }
            ];
            
            setInvestors(demoInvestors);
            setBrokers(demoBrokers);
            setContacts(demoContacts); // üî• NEW
            setDeals(demoDeals);
            setTransactions([]);
            
            try {
              await saveDemoDataToFirebase(demoInvestors, demoBrokers, demoDeals, demoContacts);
            } catch (error) {
              console.log('Could not save demo data to Firebase:', error);
            }
          };
          
          const saveDemoDataToFirebase = async (investors, brokers, deals, contacts) => {
            try {
              for (const investor of investors) {
                await db.collection('investors').doc(investor.id).set({
                  ...investor,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              }

              // üî• NEW: Save brokers
              for (const broker of brokers) {
                await db.collection('brokers').doc(broker.id).set({
                  ...broker,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              }

              // üî• NEW: Save contacts
              for (const contact of contacts) {
                await db.collection('contacts').doc(contact.id).set({
                  ...contact,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
              
              for (const deal of deals) {
                await db.collection('deals').doc(deal.id).set({
                  ...deal,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
              
              console.log('‚úÖ Demo data saved to Firebase');
            } catch (error) {
              console.error('‚ùå Error saving demo data:', error);
            }
          };

          const getUserById = (id) => {
            return users.find(u => u.id === id) || { name: 'Onbekend', email: '' };
          };

          const testAIConnection = async () => {
            setIsLoadingAI(true);
            try {
              const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  prompt: "Test connectie", 
                  type: 'connection_test', 
                  data: { test: true } 
                })
              });
              
              if (response.ok) {
                const result = await response.json();
                alert('‚úÖ AI Connectie ACTIEF!\n\nOpenAI Response ontvangen:\n' + (result.data?.fullAnalysis || result.data?.analysis || 'Connectie werkt!'));
                return true;
              } else {
                alert('‚ùå AI Connectie FAILED!\n\nStatus: ' + response.status + '\nFallback naar demo data actief.');
                return false;
              }
            } catch (error) {
              alert('‚ùå AI Connectie ERROR!\n\nFout: ' + error.message + '\nFallback naar demo data actief.');
              return false;
            } finally {
              setIsLoadingAI(false);
            }
          };

          const getInvestorInsights = async (investorId) => {
            const investor = investors.find(i => i.id === investorId);
            if (!investor) return;
            
            setIsLoadingAI(true);
            
            const detailedPrompt = `
DIEPGAANDE INVESTEERDER ANALYSE voor ${investor.naam}:

BASISGEGEVENS:
- Naam: ${investor.naam}
- Bedrijf: ${investor.bedrijf}
- Budget: ‚Ç¨${investor.minBudget.toLocaleString()} - ‚Ç¨${investor.maxBudget.toLocaleString()}
- Gewenst rendement: ${investor.gewenstRendement}%
- Risicoprofiel: ${investor.risicoprofiel}
- Ervaring: ${investor.ervaringLevel}
- Voorkeursregio's: ${investor.voorkeursRegio?.join(', ')}
- Voorkeurslanden: ${investor.voorkeursLanden?.join(', ')}
- Locatie details: ${investor.locatieDetails || 'Niet opgegeven'}
- Vastgoedtypes: ${investor.vastgoedTypes?.join(', ')}
- Project types: ${investor.projectTypes?.join(', ')}
- Communicatie voorkeur: ${investor.communicatieVoorkeur}
- Beschikbaarheid: ${investor.beschikbaarheid}

MOTIVATIE & BIJZONDERHEDEN:
- Investment motivatie: ${investor.investmentMotivatie || 'Niet opgegeven'}
- Bijzonderheden: ${investor.bijzonderheden || 'Niet opgegeven'}

ANALYSEER DIEPGAAND:
1. Financi√´le sterkte en capaciteit
2. Psychologisch profiel en gedrag op basis van motivatie
3. Optimale deal karakteristieken
4. Risico tolerantie analyse
5. Onderhandelingsstrategie
6. Timing en marktsentiment
7. Concrete actie aanbevelingen

Geef een professionele, gedetailleerde analyse in Nederlandse taal.
            `;
            
            const insights = await callOpenAI(detailedPrompt, 'investor_analysis', investor);
            setAiInsights(prev => ({
              ...prev,
              [`investor_${investorId}`]: insights
            }));
          };

          const getDealInsights = async (dealId) => {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            setIsLoadingAI(true);
            
            const detailedPrompt = `
DIEPGAANDE VASTGOED DEAL ANALYSE voor ${deal.titel}:

DEAL GEGEVENS:
- Titel: ${deal.titel}
- Bedrijf/Fonds: ${deal.bedrijfFonds || 'Niet opgegeven'}
- Locatie: ${deal.locatie}
- Type: ${deal.type}
- Project type: ${deal.projectType}
- Prijs: ‚Ç¨${deal.prijs.toLocaleString()}
- Verwacht rendement: ${deal.verwachtRendement}%
- Risico: ${deal.risico}
- Oppervlakte: ${deal.oppervlakte}m¬≤
- Bouwjaar: ${deal.bouwjaar}
- Huurpotentie: ‚Ç¨${deal.huurpotentie}

BESCHRIJVING & DETAILS:
- Beschrijving: ${deal.beschrijving}
- Bijzonderheden: ${deal.bijzonderheden || 'Niet opgegeven'}
- Contactpersoon: ${deal.contactpersoon || 'Niet opgegeven'}

ANALYSEER DIEPGAAND:
1. Marktpositie en concurrentie analyse
2. Financi√´le projectie en cashflow
3. Risicofactoren en mitigation
4. Groei- en waardecreatiekansen
5. Locatie trends en demografische analyse
6. Vergelijking met vergelijkbare objecten
7. Aanbevelingen voor potenti√´le kopers
8. Optimale verkoop- en marketingstrategie

Geef een professionele, gedetailleerde analyse in Nederlandse taal met concrete cijfers en aanbevelingen.
            `;
            
            const insights = await callOpenAI(detailedPrompt, 'deal_analysis', deal);
            setAiInsights(prev => ({
              ...prev,
              [`deal_${dealId}`]: insights
            }));
          };

          // üî• ENHANCED MATCHING WITH SEMANTIC ANALYSIS
          const getSmartMatchingInsights = async (dealId, investorId) => {
            const deal = deals.find(d => d.id === dealId);
            const investor = investors.find(i => i.id === investorId);
            if (!deal || !investor) return;
            
            setIsLoadingAI(true);
            
            const detailedPrompt = `
ü§ñ GEAVANCEERDE AI SEMANTIC MATCHING ANALYSE:

DEAL: ${deal.titel}
- Bedrijf/Fonds: ${deal.bedrijfFonds || 'Niet opgegeven'}
- Locatie: ${deal.locatie}
- Type: ${deal.type} (${deal.projectType})
- Prijs: ‚Ç¨${deal.prijs.toLocaleString()}
- Rendement: ${deal.verwachtRendement}%
- Risico: ${deal.risico}
- Deal beschrijving: "${deal.beschrijving}"
- Deal bijzonderheden: "${deal.bijzonderheden || 'Geen'}"

INVESTEERDER: ${investor.naam}
- Bedrijf: ${investor.bedrijf || 'Niet opgegeven'}
- Budget: ‚Ç¨${investor.minBudget.toLocaleString()} - ‚Ç¨${investor.maxBudget.toLocaleString()}
- Gewenst rendement: ${investor.gewenstRendement}%
- Risicoprofiel: ${investor.risicoprofiel}
- Ervaring: ${investor.ervaringLevel}
- Voorkeuren: ${investor.vastgoedTypes?.join(', ')}
- Locatie details: "${investor.locatieDetails || 'Geen specifieke eisen'}"
- Investment motivatie: "${investor.investmentMotivatie || 'Niet opgegeven'}"
- Bijzonderheden: "${investor.bijzonderheden || 'Geen'}"

üéØ VOER SEMANTIC MATCHING UIT:

1. SEMANTIC ANALYSE van deal beschrijving vs investeerder motivatie
   - Zoek naar overlappende concepten, synoniemen, gerelateerde termen
   - Bijvoorbeeld: "stabiele huurinkomsten" ‚Üî "gegarandeerde huurder"
   - Bijvoorbeeld: "geen renovatie" ‚Üî "turn-key" 
   - Bijvoorbeeld: "duurzaamheid" ‚Üî "energielabel A"

2. CONFLICT DETECTIE
   - Zoek naar tegenstrijdigheden tussen wensen en aanbod
   - Bijvoorbeeld: "geen renovatie" vs "renovatie project"

3. COMPATIBILITY SCORE (0-100)
   - Combineer traditionele factoren + semantic matching
   - Geef uitleg per component

4. GEPERSONALISEERDE PITCH STRATEGIE
   - Welke aspecten van de deal benadrukken?
   - Hoe deal presenteren aan deze specifieke investeerder?
   - Welke voordelen matchen met hun motivatie?

5. SUCCESS PROBABILITY & TIMING
   - Kans op succesvolle deal
   - Optimaal moment voor approach

Geef concrete, actionable aanbevelingen voor deze specifieke match.
            `;
            
            const insights = await callOpenAI(detailedPrompt, 'enhanced_matching', { deal, investor });
            setAiInsights(prev => ({
              ...prev,
              [`enhanced_match_${dealId}_${investorId}`]: insights
            }));
          };

          // FIREBASE AUTHENTICATION FUNCTIES (unchanged)
          const handleLogin = async (credentials) => {
            try {
              console.log('üîê Firebase login poging voor:', credentials.email);
              
              const userCredential = await auth.signInWithEmailAndPassword(
                credentials.email, 
                credentials.password
              );
              
              const firebaseUser = userCredential.user;
              const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
              
              if (userDoc.exists) {
                const userData = { id: firebaseUser.uid, ...userDoc.data() };
                setUser(userData);
                setShowAuth(false);
                console.log('‚úÖ Login succesvol voor:', userData.name);
                await loadData();
              } else {
                throw new Error('User profile not found');
              }
              
            } catch (error) {
              console.error('‚ùå Login error:', error);
              let errorMessage = 'Er ging iets mis bij het inloggen.';
              
              switch (error.code) {
                case 'auth/user-not-found':
                  errorMessage = 'Geen account gevonden met dit email adres.';
                  break;
                case 'auth/wrong-password':
                  errorMessage = 'Onjuist wachtwoord.';
                  break;
                case 'auth/invalid-email':
                  errorMessage = 'Ongeldig email adres.';
                  break;
                case 'auth/too-many-requests':
                  errorMessage = 'Te veel login pogingen. Probeer later opnieuw.';
                  break;
              }
              
              alert(errorMessage);
            }
          };

          const handleRegister = async (userData) => {
            try {
              console.log('üìù Firebase registratie voor:', userData.email);
              
              const userCredential = await auth.createUserWithEmailAndPassword(
                userData.email,
                userData.password
              );
              
              const firebaseUser = userCredential.user;
              
              const userProfile = {
                name: userData.name,
                email: userData.email,
                company: userData.company,
                role: 'agent',
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('users').doc(firebaseUser.uid).set(userProfile);
              
              const newUser = { id: firebaseUser.uid, ...userProfile };
              setUser(newUser);
              setShowAuth(false);
              await loadData();
              
              console.log('‚úÖ Nieuw account aangemaakt voor:', userData.email);
            } catch (error) {
              console.error('‚ùå Register error:', error);
              let errorMessage = 'Er ging iets mis bij het registreren.';
              
              switch (error.code) {
                case 'auth/email-already-in-use':
                  errorMessage = 'Dit email adres is al in gebruik.';
                  break;
                case 'auth/weak-password':
                  errorMessage = 'Wachtwoord is te zwak. Gebruik minimaal 6 karakters.';
                  break;
                case 'auth/invalid-email':
                  errorMessage = 'Ongeldig email adres.';
                  break;
              }
              
              alert(errorMessage);
            }
          };

          const handleLogout = async () => {
            try {
              await auth.signOut();
              setUser(null);
              setShowAuth(true);
              setInvestors([]);
              setBrokers([]);
              setContacts([]); // üî• NEW
              setDeals([]);
              setTransactions([]);
              setUsers([]);
              setAiInsights({});
              setActiveTab('dashboard');
              console.log('‚úÖ Uitgelogd van Firebase');
            } catch (error) {
              console.error('‚ùå Logout error:', error);
            }
          };

          useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
              if (firebaseUser && !user) {
                try {
                  const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                  if (userDoc.exists) {
                    const userData = { id: firebaseUser.uid, ...userDoc.data() };
                    setUser(userData);
                    setShowAuth(false);
                    await loadData();
                  }
                } catch (error) {
                  console.error('Error loading user profile:', error);
                }
              } else if (!firebaseUser && user) {
                setUser(null);
                setShowAuth(true);
              }
            });

            return () => unsubscribe();
          }, [user]);

          useEffect(() => {
            if (user) {
              loadData();
            }
          }, [user]);

          // üî• ENHANCED MATCHING ALGORITHM WITH SEMANTIC ANALYSIS
          const calculateMatchScore = (investor, deal) => {
            let score = 0;
            let maxScore = 0;
            let reasoningFactors = [];

            // Budget matching (20% - reduced to make room for semantic)
            maxScore += 20;
            if (deal.prijs >= investor.minBudget && deal.prijs <= investor.maxBudget) {
              score += 20;
              reasoningFactors.push(`‚úì Budget perfect match (‚Ç¨${deal.prijs.toLocaleString()} binnen ‚Ç¨${investor.minBudget.toLocaleString()}-‚Ç¨${investor.maxBudget.toLocaleString()} range)`);
            } else if (deal.prijs < investor.minBudget) {
              const budgetScore = Math.max(0, 20 - ((investor.minBudget - deal.prijs) / investor.minBudget * 20));
              score += budgetScore;
              reasoningFactors.push(`‚ö† Deal prijs onder minimum budget (${budgetScore.toFixed(1)}/20 punten)`);
            } else {
              reasoningFactors.push(`‚úó Deal prijs boven maximum budget`);
            }

            // üî• SIMPLIFIED LOCATION MATCHING (15% - reduced)
            maxScore += 15;
            let locationScore = 0;
            
            // Check country match
            if ((investor.voorkeursLanden || []).some(land => 
              deal.locatie.toLowerCase().includes(land.toLowerCase())
            )) {
              locationScore = 15;
              reasoningFactors.push(`‚úì Land match gevonden in locatie`);
            }
            // Check region match 
            else if ((investor.voorkeursRegio || []).length > 0) {
              locationScore = 8;
              reasoningFactors.push(`~ Regio voorkeur aanwezig`);
            }
            // Default geographic scope
            else {
              locationScore = 5;
              reasoningFactors.push(`~ Geen specifieke locatie eisen`);
            }
            
            score += locationScore;

            // Type vastgoed matching (15%)
            maxScore += 15;
            if ((investor.vastgoedTypes || []).includes(deal.type)) {
              score += 15;
              reasoningFactors.push(`‚úì Vastgoed type match (${deal.type})`);
            } else if ((investor.vastgoedTypes || []).length === 0) {
              score += 7;
              reasoningFactors.push(`~ Geen specifieke vastgoed type voorkeur`);
            } else {
              reasoningFactors.push(`‚úó Vastgoed type niet in voorkeuren`);
            }

            // Project type matching (10%)
            maxScore += 10;
            if ((investor.projectTypes || []).includes(deal.projectType)) {
              score += 10;
              reasoningFactors.push(`‚úì Project type match (${deal.projectType})`);
            } else if ((investor.projectTypes || []).length === 0) {
              score += 5;
              reasoningFactors.push(`~ Geen specifieke project type voorkeur`);
            } else {
              reasoningFactors.push(`‚úó Project type niet in voorkeuren`);
            }

            // Rendement matching (15%)
            maxScore += 15;
            if (deal.verwachtRendement >= investor.gewenstRendement) {
              score += 15;
              reasoningFactors.push(`‚úì Rendement boven verwachting (${deal.verwachtRendement}% vs ${investor.gewenstRendement}%)`);
            } else {
              const rendementScore = Math.max(0, 15 - ((investor.gewenstRendement - deal.verwachtRendement) / investor.gewenstRendement * 15));
              score += rendementScore;
              reasoningFactors.push(`‚ö† Rendement onder verwachting (${rendementScore.toFixed(1)}/15 punten)`);
            }

            // Risico matching (10%)
            maxScore += 10;
            const risicoMatch = {
              'Conservatief': { 'Laag': 10, 'Gemiddeld': 6, 'Hoog': 2 },
              'Gemiddeld': { 'Laag': 8, 'Gemiddeld': 10, 'Hoog': 7 },
              'Agressief': { 'Laag': 5, 'Gemiddeld': 8, 'Hoog': 10 }
            };
            const risicoScore = risicoMatch[investor.risicoprofiel]?.[deal.risico] || 0;
            score += risicoScore;
            reasoningFactors.push(`${risicoScore >= 8 ? '‚úì' : '‚ö†'} Risico match (${investor.risicoprofiel} profiel, ${deal.risico} risico)`);

            // üî• NEW: SEMANTIC MATCHING (15% - new powerful feature)
            maxScore += 15;
            let semanticScore = 0;
            let semanticReasons = [];
            
            const investorText = [
              investor.investmentMotivatie || '',
              investor.bijzonderheden || '',
              investor.locatieDetails || ''
            ].join(' ').toLowerCase();
            
            const dealText = [
              deal.beschrijving || '',
              deal.bijzonderheden || ''
            ].join(' ').toLowerCase();

            // Semantic keyword matching
            const semanticMatches = [
              { investor: ['stabiel', 'huurinkomst', 'gegarandeerd'], deal: ['gegarandeerd', 'huurder', 'corporatie'], points: 5, desc: 'Stabiele huurinkomsten match' },
              { investor: ['turn-key', 'geen renovatie', 'kant-en-klaar'], deal: ['turn-key', 'kant-en-klaar', 'direct'], points: 4, desc: 'Turn-key voorkeur match' },
              { investor: ['duurzaam', 'energie', 'milieu'], deal: ['energielabel', 'duurzaam', 'zonnepanel', 'warmtepomp'], points: 3, desc: 'Duurzaamheid match' },
              { investor: ['student', 'universiteit'], deal: ['student', 'universiteit', 'campus'], points: 3, desc: 'Studenten segment match' },
              { investor: ['centrum', 'bereikbaar', 'transport'], deal: ['centrum', 'metro', 'transport', 'bereikbaar'], points: 2, desc: 'Locatie bereikbaarheid match' }
            ];

            semanticMatches.forEach(match => {
              const investorHasKeywords = match.investor.some(keyword => investorText.includes(keyword));
              const dealHasKeywords = match.deal.some(keyword => dealText.includes(keyword));
              
              if (investorHasKeywords && dealHasKeywords) {
                semanticScore += match.points;
                semanticReasons.push(`‚úì ${match.desc}`);
              }
            });

            // Conflict detection
            const conflicts = [
              { investor: ['geen renovatie', 'turn-key'], deal: ['renovatie', 'opknappen'], desc: 'Renovatie conflict' },
              { investor: ['centrum'], deal: ['buitenwijk', 'periferie'], desc: 'Locatie voorkeur conflict' }
            ];

            conflicts.forEach(conflict => {
              const investorWants = conflict.investor.some(keyword => investorText.includes(keyword));
              const dealOffers = conflict.deal.some(keyword => dealText.includes(keyword));
              
              if (investorWants && dealOffers) {
                semanticScore -= 3;
                semanticReasons.push(`‚ö† ${conflict.desc} gedetecteerd`);
              }
            });

            score += Math.max(0, Math.min(15, semanticScore));
            reasoningFactors.push(...semanticReasons);

            const finalScore = Math.round((score / maxScore) * 100);
            
            return {
              score: finalScore,
              reasoning: reasoningFactors,
              maxScore,
              actualScore: score,
              semanticScore: semanticScore,
              semanticReasons: semanticReasons
            };
          };

          const findMatches = (dealId) => {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return [];

            return investors.map(investor => {
              const matchResult = calculateMatchScore(investor, deal);
              return {
                investor,
                deal,
                matchScore: matchResult.score,
                reasoning: matchResult.reasoning,
                semanticScore: matchResult.semanticScore,
                semanticReasons: matchResult.semanticReasons,
                aiInsights: null
              };
            }).sort((a, b) => b.matchScore - a.matchScore);
          };

          // Commission Management Functions (unchanged)
          const openCommissionEditor = (deal) => {
            setEditingDealCommission(deal);
            setShowCommissionEditor(true);
          };

          const saveCommissionStructure = async (dealId, commissionStructure) => {
            try {
              console.log('üíæ Saving commission structure for deal:', dealId);
              
              await db.collection('deals').doc(dealId).update({
                commissionStructure: commissionStructure,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              setDeals(prev => prev.map(deal => 
                deal.id === dealId ? { ...deal, commissionStructure } : deal
              ));
              
              console.log('‚úÖ Commission structure saved');
              alert('‚úÖ Commissie structuur succesvol opgeslagen!');
            } catch (error) {
              console.error('‚ùå Error saving commission structure:', error);
              alert('Fout bij opslaan commissie structuur: ' + error.message);
            }
          };

          const createTransaction = async (dealId, investorId) => {
            const deal = deals.find(d => d.id === dealId);
            const investor = investors.find(i => i.id === investorId);
            
            if (!deal || !investor) return;

            const commissionStructure = deal.commissionStructure || {
              total_rate: 0.025,
              participants: [
                { 
                  role: 'deal_owner', 
                  user_id: deal.owner_id, 
                  percentage: 60, 
                  fixed_amount: 0, 
                  type: 'percentage',
                  name: getUserById(deal.owner_id).name,
                  is_external: false
                },
                { 
                  role: 'investor_referral', 
                  user_id: investor.owner_id, 
                  percentage: 40, 
                  fixed_amount: 0, 
                  type: 'percentage',
                  name: getUserById(investor.owner_id).name,
                  is_external: false
                }
              ]
            };

            const totalCommission = deal.prijs * commissionStructure.total_rate;
            
            const participantCommissions = commissionStructure.participants.map(participant => {
              let commission = 0;
              if (participant.type === 'percentage') {
                commission = totalCommission * (participant.percentage / 100);
              } else if (participant.type === 'fixed') {
                commission = participant.fixed_amount;
              }
              return {
                ...participant,
                commission_amount: commission
              };
            });

            const transactionData = {
              id: Date.now().toString(),
              deal_id: dealId,
              investor_id: investorId,
              deal_owner_id: deal.owner_id,
              investor_owner_id: investor.owner_id,
              transaction_amount: deal.prijs,
              commission_rate: commissionStructure.total_rate,
              total_commission: totalCommission,
              commission_structure: JSON.stringify(commissionStructure),
              participant_commissions: JSON.stringify(participantCommissions),
              status: 'pending',
              closed_date: null,
              created_at: new Date().toISOString()
            };

            try {
              await db.collection('transactions').add(transactionData);
              setTransactions(prev => [...prev, transactionData]);
              
              console.log('‚úÖ Transaction created:', transactionData);
              alert('‚úÖ Transactie succesvol aangemaakt! Ga naar "Transacties" tab om de details te bekijken.');
              setActiveTab('transactions');
            } catch (error) {
              console.error('‚ùå Error creating transaction:', error);
              alert('Fout bij aanmaken transactie: ' + error.message);
            }
          };

          // Edit Functions (unchanged)
          const handleEditInvestor = (investor) => {
            setEditingInvestor(investor);
            setShowEditInvestor(true);
          };

          const handleEditDeal = (deal) => {
            setEditingDeal(deal);
            setShowEditDeal(true);
          };

          // üî• NEW: Broker CRUD Functions
          const handleEditBroker = (broker) => {
            setEditingBroker(broker);
            setShowEditBroker(true);
          };

          const handleAddBroker = async (brokerData) => {
            try {
              console.log('üíæ Adding broker to Firebase...');
              
              const newBroker = {
                ...brokerData,
                ervaringJaren: parseInt(brokerData.ervaringJaren) || 0,
                owner_id: user.id,
                import_source: 'manual',
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('brokers').add(newBroker);
              
              const brokerWithId = {
                id: docRef.id,
                ...newBroker,
                created_at: new Date().toISOString()
              };
              
              setBrokers(prev => [...prev, brokerWithId]);
              setShowAddBroker(false);
              
              console.log('‚úÖ Broker added to Firebase:', docRef.id);
              alert('‚úÖ Broker succesvol toegevoegd!');
            } catch (error) {
              console.error('‚ùå Error adding broker:', error);
              alert('Fout bij toevoegen broker: ' + error.message);
            }
          };

          const handleUpdateBroker = async (brokerData) => {
            try {
              console.log('üíæ Updating broker in Firebase...', editingBroker.id);
              
              const updatedBroker = {
                ...brokerData,
                ervaringJaren: parseInt(brokerData.ervaringJaren) || 0,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('brokers').doc(editingBroker.id).update(updatedBroker);
              
              setBrokers(prev => prev.map(broker => 
                broker.id === editingBroker.id ? { ...broker, ...updatedBroker } : broker
              ));
              
              setShowEditBroker(false);
              setEditingBroker(null);
              
              console.log('‚úÖ Broker updated in Firebase:', editingBroker.id);
              alert('‚úÖ Broker succesvol bijgewerkt!');
            } catch (error) {
              console.error('‚ùå Error updating broker:', error);
              alert('Fout bij bijwerken broker: ' + error.message);
            }
          };

          const handleDeleteBroker = async (brokerId) => {
            if (confirm('Weet je zeker dat je deze broker wilt verwijderen?')) {
              try {
                console.log('üóëÔ∏è Deleting broker from Firebase...');
                
                await db.collection('brokers').doc(brokerId).delete();
                setBrokers(prev => prev.filter(b => b.id !== brokerId));
                
                console.log('‚úÖ Broker deleted from Firebase:', brokerId);
                alert('‚úÖ Broker succesvol verwijderd!');
              } catch (error) {
                console.error('‚ùå Error deleting broker:', error);
                alert('Fout bij verwijderen broker: ' + error.message);
              }
            }
          };

          const handleUpdateInvestor = async (investorData) => {
            try {
              console.log('üíæ Updating investor in Firebase...', editingInvestor.id);
              
              const updatedInvestor = {
                ...investorData,
                minBudget: parseInt(investorData.minBudget) || 0,
                maxBudget: parseInt(investorData.maxBudget) || 0,
                gewenstRendement: parseFloat(investorData.gewenstRendement) || 0,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('investors').doc(editingInvestor.id).update(updatedInvestor);
              
              setInvestors(prev => prev.map(inv => 
                inv.id === editingInvestor.id ? { ...inv, ...updatedInvestor } : inv
              ));
              
              setShowEditInvestor(false);
              setEditingInvestor(null);
              
              console.log('‚úÖ Investor updated in Firebase:', editingInvestor.id);
              alert('‚úÖ Investeerder succesvol bijgewerkt!');
            } catch (error) {
              console.error('‚ùå Error updating investor:', error);
              alert('Fout bij bijwerken investeerder: ' + error.message);
            }
          };

          const handleUpdateDeal = async (dealData) => {
            try {
              console.log('üíæ Updating deal in Firebase...', editingDeal.id);
              
              const updatedDeal = {
                ...dealData,
                prijs: parseInt(dealData.prijs) || 0,
                verwachtRendement: parseFloat(dealData.verwachtRendement) || 0,
                oppervlakte: parseInt(dealData.oppervlakte) || 0,
                bouwjaar: parseInt(dealData.bouwjaar) || 0,
                huurpotentie: parseInt(dealData.huurpotentie) || 0,
                commissionStructure: editingDeal.commissionStructure,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('deals').doc(editingDeal.id).update(updatedDeal);
              
              setDeals(prev => prev.map(deal => 
                deal.id === editingDeal.id ? { ...deal, ...updatedDeal } : deal
              ));
              
              setShowEditDeal(false);
              setEditingDeal(null);
              
              console.log('‚úÖ Deal updated in Firebase:', editingDeal.id);
              alert('‚úÖ Deal succesvol bijgewerkt!');
            } catch (error) {
              console.error('‚ùå Error updating deal:', error);
              alert('Fout bij bijwerken deal: ' + error.message);
            }
          };

          const handleAddInvestor = async (investorData) => {
            try {
              console.log('üíæ Adding investor to Firebase...');
              
              const newInvestor = {
                ...investorData,
                minBudget: parseInt(investorData.minBudget) || 0,
                maxBudget: parseInt(investorData.maxBudget) || 0,
                gewenstRendement: parseFloat(investorData.gewenstRendement) || 0,
                owner_id: user.id,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('investors').add(newInvestor);
              
              const investorWithId = {
                id: docRef.id,
                ...newInvestor,
                created_at: new Date().toISOString()
              };
              
              setInvestors(prev => [...prev, investorWithId]);
              setShowAddInvestor(false);
              
              console.log('‚úÖ Investor added to Firebase:', docRef.id);
            } catch (error) {
              console.error('‚ùå Error adding investor:', error);
              alert('Fout bij toevoegen investeerder: ' + error.message);
            }
          };

          const handleAddDeal = async (dealData) => {
            try {
              console.log('üíæ Adding deal to Firebase...');
              
              const newDeal = {
                ...dealData,
                prijs: parseInt(dealData.prijs) || 0,
                verwachtRendement: parseFloat(dealData.verwachtRendement) || 0,
                oppervlakte: parseInt(dealData.oppervlakte) || 0,
                bouwjaar: parseInt(dealData.bouwjaar) || 0,
                huurpotentie: parseInt(dealData.huurpotentie) || 0,
                owner_id: user.id,
                commissionStructure: {
                  total_rate: 0.025,
                  participants: [
                    { 
                      role: 'deal_owner', 
                      user_id: user.id, 
                      percentage: 100, 
                      fixed_amount: 0, 
                      type: 'percentage',
                      name: user.name,
                      is_external: false
                    }
                  ]
                },
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('deals').add(newDeal);
              
              const dealWithId = {
                id: docRef.id,
                ...newDeal,
                created_at: new Date().toISOString()
              };
              
              setDeals(prev => [...prev, dealWithId]);
              setShowAddDeal(false);
              
              console.log('‚úÖ Deal added to Firebase:', docRef.id);
            } catch (error) {
              console.error('‚ùå Error adding deal:', error);
              alert('Fout bij toevoegen deal: ' + error.message);
            }
          };

          const handleDeleteInvestor = async (investorId) => {
            if (confirm('Weet je zeker dat je deze investeerder wilt verwijderen?')) {
              try {
                console.log('üóëÔ∏è Deleting investor from Firebase...');
                
                await db.collection('investors').doc(investorId).delete();
                setInvestors(prev => prev.filter(i => i.id !== investorId));
                
                console.log('‚úÖ Investor deleted from Firebase:', investorId);
              } catch (error) {
                console.error('‚ùå Error deleting investor:', error);
                alert('Fout bij verwijderen investeerder: ' + error.message);
              }
            }
          };

          const handleDeleteDeal = async (dealId) => {
            if (confirm('Weet je zeker dat je deze deal wilt verwijderen?\n\nLet op: Gerelateerde transacties worden ook verwijderd.')) {
              try {
                console.log('üóëÔ∏è Deleting deal from Firebase...');
                
                const relatedTransactions = transactions.filter(t => t.deal_id === dealId);
                for (const transaction of relatedTransactions) {
                  await db.collection('transactions').doc(transaction.id).delete();
                }
                
                await db.collection('deals').doc(dealId).delete();
                
                setDeals(prev => prev.filter(d => d.id !== dealId));
                setTransactions(prev => prev.filter(t => t.deal_id !== dealId));
                
                console.log('‚úÖ Deal deleted from Firebase:', dealId);
                alert('‚úÖ Deal succesvol verwijderd!');
              } catch (error) {
                console.error('‚ùå Error deleting deal:', error);
                alert('Fout bij verwijderen deal: ' + error.message);
              }
            }
          };

          const getMatchColor = (score) => {
            if (score >= 80) return 'text-green-600 bg-green-100';
            if (score >= 60) return 'text-yellow-600 bg-yellow-100';
            return 'text-red-600 bg-red-100';
          };

          const calculateCommissionSummary = () => {
            const userTransactions = transactions.filter(t => {
              if (t.participant_commissions) {
                const participants = JSON.parse(t.participant_commissions);
                return participants.some(p => p.user_id === user.id);
              }
              return t.deal_owner_id === user.id || t.investor_owner_id === user.id;
            });
            
            const totalCommission = userTransactions.reduce((sum, t) => {
              if (t.participant_commissions) {
                const participants = JSON.parse(t.participant_commissions);
                const userParticipant = participants.find(p => p.user_id === user.id);
                return sum + (userParticipant ? userParticipant.commission_amount : 0);
              }
              const userCommission = t.deal_owner_id === user.id ? (t.deal_owner_commission || 0) : (t.investor_owner_commission || 0);
              return sum + userCommission;
            }, 0);

            const completedTransactions = userTransactions.filter(t => t.status === 'completed');
            const pendingTransactions = userTransactions.filter(t => t.status === 'pending');

            return {
              totalCommission,
              completedTransactions: completedTransactions.length,
              pendingTransactions: pendingTransactions.length,
              totalVolume: userTransactions.reduce((sum, t) => sum + t.transaction_amount, 0)
            };
          };

          // üî• NEW: CSV Upload Modal Component
          const CsvUploadModal = () => {
            if (!showCsvUpload) return null;

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-6xl max-h-[90vh] overflow-y-auto">
                  <div className="p-6 border-b">
                    <div className="flex items-center justify-between">
                      <h3 className="text-xl font-bold flex items-center space-x-2">
                        <UploadIcon size={20} />
                        <span>üìÑ CSV Contacten Upload Preview</span>
                      </h3>
                      <button 
                        onClick={() => {
                          setShowCsvUpload(false);
                          setCsvData([]);
                        }}
                        className="text-gray-400 hover:text-gray-600"
                      >
                        ‚úï
                      </button>
                    </div>
                    <p className="text-sm text-blue-600 mt-2">
                      {csvData.length} contacten geladen ‚Ä¢ Review en upload naar Firebase
                    </p>
                  </div>
                  
                  <div className="p-6">
                    {csvData.length > 0 && (
                      <div className="mb-6">
                        <h4 className="font-semibold mb-3">Preview van eerste 10 contacten:</h4>
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm border-collapse border border-gray-300">
                            <thead>
                              <tr className="bg-gray-50">
                                <th className="border border-gray-300 p-2 text-left">Naam</th>
                                <th className="border border-gray-300 p-2 text-left">Email</th>
                                <th className="border border-gray-300 p-2 text-left">Bedrijf</th>
                                <th className="border border-gray-300 p-2 text-left">Positie</th>
                                <th className="border border-gray-300 p-2 text-left">LinkedIn</th>
                                <th className="border border-gray-300 p-2 text-left">Status</th>
                              </tr>
                            </thead>
                            <tbody>
                              {csvData.slice(0, 10).map((contact, index) => (
                                <tr key={index} className="hover:bg-gray-50">
                                  <td className="border border-gray-300 p-2">{contact.fullName}</td>
                                  <td className="border border-gray-300 p-2">{contact.email}</td>
                                  <td className="border border-gray-300 p-2">{contact.company}</td>
                                  <td className="border border-gray-300 p-2">{contact.position}</td>
                                  <td className="border border-gray-300 p-2">
                                    {contact.linkedin && (
                                      <a href={contact.linkedin} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">
                                        LinkedIn
                                      </a>
                                    )}

              {activeTab === 'investors' && (
                <div>
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <div>
                      <h2 className="text-2xl font-bold">üî• Investeerders & Brokers</h2>
                      <p className="text-gray-600 text-sm">Beheer investeerders en brokers in √©√©n overzicht</p>
                    </div>
                    <div className="flex space-x-2">
                      <button
                        onClick={() => setShowAddInvestor(true)}
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
                      >
                        <PlusIcon size={20} />
                        <span>üè¶ Investeerder</span>
                      </button>
                      <button
                        onClick={() => setShowAddBroker(true)}
                        className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-green-700 transition-colors"
                      >
                        <PlusIcon size={20} />
                        <span>üè¢ Broker</span>
                      </button>
                    </div>
                  </div>

                  {/* Contact Filters */}
                  <div className="mb-6 bg-white p-4 rounded-lg shadow border">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                      <div className="flex space-x-2">
                        <button
                          onClick={() => setContactFilter('all')}
                          className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                            contactFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          <UsersIcon size={16} />
                          <span>Alle Contacten ({investors.length + brokers.length})</span>
                        </button>
                        <button
                          onClick={() => setContactFilter('investors')}
                          className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                            contactFilter === 'investors' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          <span>üè¶</span>
                          <span>Investeerders ({investors.length})</span>
                        </button>
                        <button
                          onClick={() => setContactFilter('brokers')}
                          className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                            contactFilter === 'brokers' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          <span>üè¢</span>
                          <span>Brokers ({brokers.length})</span>
                        </button>
                      </div>
                      
                      <div className="text-sm text-gray-600">
                        {contactFilter === 'all' && `${investors.length} investeerders ‚Ä¢ ${brokers.length} brokers`}
                        {contactFilter === 'investors' && `${investors.filter(i => i.owner_id === user.id).length} mijn investeerders ‚Ä¢ ${investors.length} totaal`}
                        {contactFilter === 'brokers' && `${brokers.filter(b => b.owner_id === user.id).length} mijn brokers ‚Ä¢ ${brokers.length} totaal`}
                      </div>
                    </div>
                  </div>

                  {/* UNIFIED CONTACTS GRID */}
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {/* Show Investors */}
                    {(contactFilter === 'all' || contactFilter === 'investors') && 
                      investors.map(investor => (
                        <div key={`investor-${investor.id}`} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-2">
                              <span className="text-blue-600 text-lg">üè¶</span>
                              <h3 className="text-xl font-semibold text-gray-900">{investor.naam}</h3>
                            </div>
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                              investor.risicoprofiel === 'Conservatief' ? 'bg-green-100 text-green-800' :
                              investor.risicoprofiel === 'Gemiddeld' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {investor.risicoprofiel}
                            </span>
                          </div>

                          <div className="space-y-2 text-sm mb-4">
                            <div className="flex items-center space-x-2">
                              <UserCheckIcon size={16} className="text-gray-500" />
                              <span>Eigenaar: {getUserById(investor.owner_id).name}</span>
                            </div>
                            {investor.bedrijf && (
                              <div className="flex items-center space-x-2">
                                <BuildingIcon size={16} className="text-gray-500" />
                                <span className="font-medium">{investor.bedrijf}</span>
                              </div>
                            )}
                            {investor.locatie && (
                              <div className="flex items-center space-x-2">
                                <MapPinIcon size={16} className="text-gray-500" />
                                <span>Gevestigd in: {investor.locatie}</span>
                              </div>
                            )}
                            <div className="flex items-center space-x-2">
                              <MailIcon size={16} className="text-gray-500" />
                              <span>{investor.email}</span>
                            </div>
                            <div className="flex items-center space-x-2">
                              <EuroIcon size={16} className="text-gray-500" />
                              <span>‚Ç¨{investor.minBudget.toLocaleString()} - ‚Ç¨{investor.maxBudget.toLocaleString()}</span>
                            </div>
                          </div>

                          {investor.locatieDetails && (
                            <div className="mt-4 p-3 bg-purple-50 rounded border border-purple-200">
                              <p className="text-sm text-purple-800 font-medium mb-1">üó∫Ô∏è Locatie Details:</p>
                              <p className="text-xs text-purple-700">{investor.locatieDetails}</p>
                            </div>
                          )}

                          {investor.investmentMotivatie && (
                            <div className="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                              <p className="text-sm text-blue-800 font-medium mb-1">üéØ Investment Motivatie:</p>
                              <p className="text-xs text-blue-700">{investor.investmentMotivatie}</p>
                            </div>
                          )}

                          <div className="mt-4">
                            <p className="text-sm text-gray-600 mb-2">Interessegebieden:</p>
                            <div className="flex flex-wrap gap-1">
                              {(investor.vastgoedTypes || []).slice(0, 3).map(type => (
                                <span key={type} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                  {type}
                                </span>
                              ))}
                              {(investor.vastgoedTypes || []).length > 3 && (
                                <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                  +{(investor.vastgoedTypes || []).length - 3} meer
                                </span>
                              )}
                            </div>
                          </div>

                          <div className="mt-4 pt-4 border-t space-y-2">
                            <button
                              onClick={() => getInvestorInsights(investor.id)}
                              disabled={isLoadingAI}
                              className="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                            >
                              <BrainIcon size={16} />
                              <span>{isLoadingAI ? 'AI Analyseert...' : 'AI Analyse'}</span>
                            </button>
                            
                            {(user.role === 'beheerder' || investor.owner_id === user.id) && (
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => handleEditInvestor(investor)}
                                  className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <EditIcon size={16} />
                                  <span>Bewerken</span>
                                </button>
                                <button
                                  onClick={() => handleDeleteInvestor(investor.id)}
                                  className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <TrashIcon size={16} />
                                  <span>Verwijderen</span>
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      ))
                    }

                    {/* Show Brokers */}
                    {(contactFilter === 'all' || contactFilter === 'brokers') && 
                      brokers.map(broker => (
                        <div key={`broker-${broker.id}`} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow border-l-4 border-l-green-500">
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-2">
                              <span className="text-green-600 text-lg">üè¢</span>
                              <h3 className="text-xl font-semibold text-gray-900">{broker.naam}</h3>
                            </div>
                            {broker.ervaringJaren && (
                              <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                                {broker.ervaringJaren} jaar ervaring
                              </span>
                            )}
                          </div>

                          <div className="space-y-2 text-sm mb-4">
                            <div className="flex items-center space-x-2">
                              <UserCheckIcon size={16} className="text-gray-500" />
                              <span>Eigenaar: {getUserById(broker.owner_id).name}</span>
                            </div>
                            {broker.bedrijf && (
                              <div className="flex items-center space-x-2">
                                <BuildingIcon size={16} className="text-gray-500" />
                                <span className="font-medium">{broker.bedrijf}</span>
                              </div>
                            )}
                            {broker.locatie && (
                              <div className="flex items-center space-x-2">
                                <MapPinIcon size={16} className="text-gray-500" />
                                <span>Kantoor: {broker.locatie}</span>
                              </div>
                            )}
                            <div className="flex items-center space-x-2">
                              <MailIcon size={16} className="text-gray-500" />
                              <span>{broker.email}</span>
                            </div>
                            {broker.commissieStructuur && (
                              <div className="flex items-center space-x-2">
                                <PercentIcon size={16} className="text-gray-500" />
                                <span>{broker.commissieStructuur}</span>
                              </div>
                            )}
                          </div>

                          {broker.specialisaties && broker.specialisaties.length > 0 && (
                            <div className="mt-4">
                              <p className="text-sm text-gray-600 mb-2">Specialisaties:</p>
                              <div className="flex flex-wrap gap-1">
                                {broker.specialisaties.slice(0, 3).map(spec => (
                                  <span key={spec} className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    {spec}
                                  </span>
                                ))}
                                {broker.specialisaties.length > 3 && (
                                  <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    +{broker.specialisaties.length - 3} meer
                                  </span>
                                )}
                              </div>
                            </div>
                          )}

                          {broker.werkgebied && broker.werkgebied.length > 0 && (
                            <div className="mt-3">
                              <p className="text-sm text-gray-600 mb-2">Werkgebied:</p>
                              <div className="flex flex-wrap gap-1">
                                {broker.werkgebied.slice(0, 3).map(gebied => (
                                  <span key={gebied} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                    {gebied}
                                  </span>
                                ))}
                                {broker.werkgebied.length > 3 && (
                                  <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    +{broker.werkgebied.length - 3} meer
                                  </span>
                                )}
                              </div>
                            </div>
                          )}

                          {broker.trackRecord && (
                            <div className="mt-4 p-3 bg-green-50 rounded border border-green-200">
                              <p className="text-sm text-green-800 font-medium mb-1">üìà Track Record:</p>
                              <p className="text-xs text-green-700">{broker.trackRecord}</p>
                            </div>
                          )}

                          {broker.werkwijze && (
                            <div className="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                              <p className="text-sm text-blue-800 font-medium mb-1">üéØ Werkwijze:</p>
                              <p className="text-xs text-blue-700">{broker.werkwijze}</p>
                            </div>
                          )}

                          <div className="mt-4 pt-4 border-t space-y-2">
                            <button
                              onClick={() => alert(`Contacteer ${broker.naam} via email: ${broker.email}`)}
                              className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                            >
                              <MailIcon size={16} />
                              <span>Contact Opnemen</span>
                            </button>
                            
                            {(user.role === 'beheerder' || broker.owner_id === user.id) && (
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => handleEditBroker(broker)}
                                  className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <EditIcon size={16} />
                                  <span>Bewerken</span>
                                </button>
                                <button
                                  onClick={() => handleDeleteBroker(broker.id)}
                                  className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <TrashIcon size={16} />
                                  <span>Verwijderen</span>
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      ))
                    }
                  </div>

                  {/* Empty state */}
                  {((contactFilter === 'all' && investors.length === 0 && brokers.length === 0) ||
                    (contactFilter === 'investors' && investors.length === 0) ||
                    (contactFilter === 'brokers' && brokers.length === 0)) && (
                    <div className="text-center py-12">
                      <UsersIcon size={48} className="text-gray-400 mx-auto mb-4" />
                      <div className="space-y-2">
                        <p className="text-gray-600 text-lg">
                          {contactFilter === 'brokers' ? 'Nog geen brokers toegevoegd' : 
                           contactFilter === 'investors' ? 'Nog geen investeerders toegevoegd' :
                           'Nog geen contacten toegevoegd'}
                        </p>
                        <p className="text-sm text-gray-500">
                          {contactFilter === 'brokers' ? 'Voeg brokers toe om je deal sourcing te verbeteren' :
                           contactFilter === 'investors' ? 'Voeg investeerders toe om matches te kunnen maken' :
                           'Voeg investeerders en brokers toe om te beginnen'}
                        </p>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'deals' && (
                <div>
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <h2 className="text-2xl font-bold">Deals</h2>
                    <button
                      onClick={() => setShowAddDeal(true)}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
                    >
                      <PlusIcon size={20} />
                      <span>Nieuwe Deal</span>
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {deals.map(deal => (
                      <div key={deal.id} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="text-xl font-semibold text-gray-900">{deal.titel}</h3>
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            deal.risico === 'Laag' ? 'bg-green-100 text-green-800' :
                            deal.risico === 'Gemiddeld' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>
                            {deal.risico} risico
                          </span>
                        </div>

                        <div className="space-y-2 text-sm mb-4">
                          <div className="flex items-center space-x-2">
                            <UserCheckIcon size={16} className="text-gray-500" />
                            <span>Eigenaar: {getUserById(deal.owner_id).name}</span>
                          </div>
                          {deal.bedrijfFonds && (
                            <div className="flex items-center space-x-2">
                              <BuildingIcon size={16} className="text-gray-500" />
                              <span className="font-medium">{deal.bedrijfFonds}</span>
                            </div>
                          )}
                          {deal.contactpersoon && (
                            <div className="flex items-center space-x-2">
                              <UserIcon size={16} className="text-gray-500" />
                              <span>{deal.contactpersoon}</span>
                            </div>
                          )}
                          {deal.telefoon && (
                            <div className="flex items-center space-x-2">
                              <PhoneIcon size={16} className="text-gray-500" />
                              <span>{deal.telefoon}</span>
                            </div>
                          )}
                          {deal.email && (
                            <div className="flex items-center space-x-2">
                              <MailIcon size={16} className="text-gray-500" />
                              <span>{deal.email}</span>
                            </div>
                          )}
                          <div className="flex items-center space-x-2">
                            <MapPinIcon size={16} className="text-gray-500" />
                            <span>{deal.locatie}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <BuildingIcon size={16} className="text-gray-500" />
                            <span>{deal.type}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <TargetIcon size={16} className="text-gray-500" />
                            <span>{deal.projectType}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <EuroIcon size={16} className="text-gray-500" />
                            <span className="font-semibold">‚Ç¨{deal.prijs.toLocaleString()}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <TrendingUpIcon size={16} className="text-gray-500" />
                            <span className="font-semibold text-green-600">{deal.verwachtRendement}% rendement</span>
                          </div>
                        </div>

                        {deal.commissionStructure && (
                          <div className="mb-4 p-3 bg-gray-50 rounded border">
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm font-medium text-gray-700">Commissie Structuur</span>
                              <span className="text-sm text-gray-600">
                                {(deal.commissionStructure.total_rate * 100).toFixed(2)}%
                              </span>
                            </div>
                            <div className="text-xs text-gray-600">
                              {deal.commissionStructure.participants?.length || 0} deelnemers geconfigureerd
                            </div>
                          </div>
                        )}

                        <p className="text-sm text-gray-600 mb-4">{deal.beschrijving}</p>

                        {/* Enhanced: Show semantic fields */}
                        {deal.bijzonderheden && (
                          <div className="mb-4 p-3 bg-purple-50 rounded border border-purple-200">
                            <p className="text-sm text-purple-800 font-medium mb-1">üî• Bijzonderheden:</p>
                            <p className="text-xs text-purple-700">{deal.bijzonderheden}</p>
                          </div>
                        )}

                        <div className="space-y-2">
                          <button
                            onClick={() => {
                              setMatches(findMatches(deal.id));
                              setActiveTab('matching');
                            }}
                            className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                          >
                            <StarIcon size={16} />
                            <span>üî• Enhanced Matches</span>
                          </button>
                          
                          <div className="flex space-x-2">
                            <button
                              onClick={() => getDealInsights(deal.id)}
                              disabled={isLoadingAI}
                              className="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                            >
                              <BrainIcon size={16} />
                              <span>{isLoadingAI ? 'AI...' : 'AI Analyse'}</span>
                            </button>
                            
                            <button
                              onClick={() => openCommissionEditor(deal)}
                              className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2"
                            >
                              <PercentIcon size={16} />
                              <span>Commissie</span>
                            </button>
                          </div>

                          {(user.role === 'beheerder' || deal.owner_id === user.id) && (
                            <div className="flex space-x-2">
                              <button
                                onClick={() => handleEditDeal(deal)}
                                className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                              >
                                <EditIcon size={16} />
                                <span>Bewerken</span>
                              </button>
                              <button
                                onClick={() => handleDeleteDeal(deal.id)}
                                className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                              >
                                <TrashIcon size={16} />
                                <span>Verwijderen</span>
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {activeTab === 'matching' && (
                <div>
                  <div className="mb-6">
                    <h2 className="text-2xl font-bold mb-4">üî• Enhanced AI-Powered Matching</h2>
                    
                    {matches.length === 0 ? (
                      <div className="text-center py-12">
                        <AlertCircleIcon size={48} className="text-gray-400 mx-auto mb-4" />
                        <div className="space-y-2">
                          <p className="text-gray-600 text-lg">Selecteer een deal om enhanced AI-powered matches te vinden</p>
                          <p className="text-sm text-gray-500">
                            üî• Enhanced Features: Semantic matching van beschrijvingen, vrije tekst analyse, conflict detectie
                          </p>
                        </div>
                      </div>
                    ) : (
                      <div>
                        <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
                          <h4 className="font-semibold text-purple-800 mb-3">üî• Enhanced AI Matching Features:</h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-purple-700">
                            <div className="space-y-2">
                              <p>‚Ä¢ üó∫Ô∏è Vereenvoudigde locatie matching</p>
                              <p>‚Ä¢ ü§ñ Semantic text analyse van beschrijvingen</p>
                              <p>‚Ä¢ üí¨ Vrije tekst input matching</p>
                              <p>‚Ä¢ ‚ö†Ô∏è Conflict detectie tussen wensen en aanbod</p>
                            </div>
                            <div className="space-y-2">
                              <p>‚Ä¢ üéØ Intelligente keyword matching</p>
                              <p>‚Ä¢ üìù Investment motivatie vs deal beschrijving</p>
                              <p>‚Ä¢ üöÄ Enhanced compatibility scoring</p>
                              <p>‚Ä¢ üí∞ Flexibele commissie structuren</p>
                            </div>
                          </div>
                        </div>

                        <div className="bg-blue-50 p-6 rounded-lg mb-6">
                          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center">
                            <div className="mb-4 lg:mb-0">
                              <h3 className="font-semibold text-lg mb-2">üéØ Deal: {matches[0].deal.titel}</h3>
                              <p className="text-sm text-gray-600 mb-2">{matches[0].deal.beschrijving}</p>
                              {matches[0].deal.bijzonderheden && (
                                <p className="text-sm text-purple-600 mb-2">üî• {matches[0].deal.bijzonderheden}</p>
                              )}
                              <div className="flex flex-wrap items-center gap-4 text-sm">
                                <span className="text-blue-600 font-medium">Deal eigenaar: {getUserById(matches[0].deal.owner_id).name}</span>
                                {matches[0].deal.bedrijfFonds && (
                                  <span className="text-gray-600">Bedrijf/Fonds: {matches[0].deal.bedrijfFonds}</span>
                                )}
                                <span className="text-gray-600">Type: {matches[0].deal.type}</span>
                                <span className="text-gray-600">Project: {matches[0].deal.projectType}</span>
                              </div>
                            </div>
                            <div className="text-center lg:text-right">
                              <div className="text-3xl font-bold text-blue-600">{matches.length}</div>
                              <div className="text-sm text-gray-600">Enhanced Matches</div>
                            </div>
                          </div>
                        </div>

                        <div className="space-y-6">
                          {matches.map((match, index) => (
                            <div key={match.investor.id} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                              <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4">
                                <div className="flex items-center space-x-4 mb-4 lg:mb-0">
                                  <div className="flex items-center space-x-2">
                                    <span className={`text-2xl font-bold ${
                                      index === 0 ? 'text-yellow-500' : 
                                      index === 1 ? 'text-gray-400' : 
                                      index === 2 ? 'text-orange-400' : 'text-gray-600'
                                    }`}>
                                      #{index + 1}
                                    </span>
                                    <div>
                                      <h3 className="text-xl font-semibold">{match.investor.naam}</h3>
                                      <p className="text-sm text-gray-600">{match.investor.bedrijf}</p>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                  <span className={`px-4 py-2 rounded-full text-lg font-bold ${getMatchColor(match.matchScore)}`}>
                                    {match.matchScore}% match
                                  </span>
                                  {match.semanticScore > 0 && (
                                    <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                                      üî• +{match.semanticScore} semantic
                                    </span>
                                  )}
                                  <button
                                    onClick={() => createTransaction(match.deal.id, match.investor.id)}
                                    className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
                                  >
                                    <DollarSignIcon size={16} />
                                    <span>Start Deal</span>
                                  </button>
                                </div>
                              </div>

                              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                  <h4 className="font-semibold mb-3">üî• Enhanced Match Analyse:</h4>
                                  <div className="space-y-2">
                                    {match.reasoning.map((reason, idx) => (
                                      <div key={idx} className="text-sm p-2 bg-gray-50 rounded">
                                        {reason}
                                      </div>
                                    ))}
                                    {match.semanticReasons && match.semanticReasons.length > 0 && (
                                      <div className="mt-3">
                                        <p className="text-sm font-medium text-purple-700 mb-2">ü§ñ Semantic Matches:</p>
                                        {match.semanticReasons.map((reason, idx) => (
                                          <div key={idx} className="text-sm p-2 bg-purple-50 rounded border border-purple-200">
                                            {reason}
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                </div>
                                <div>
                                  <h4 className="font-semibold mb-3">Investeerder Details:</h4>
                                  <div className="space-y-2 text-sm">
                                    {match.investor.bedrijf && <p>Bedrijf: {match.investor.bedrijf}</p>}
                                    <p>Budget: ‚Ç¨{match.investor.minBudget.toLocaleString()} - ‚Ç¨{match.investor.maxBudget.toLocaleString()}</p>
                                    <p>Gewenst rendement: {match.investor.gewenstRendement}%</p>
                                    <p>Risicoprofiel: {match.investor.risicoprofiel}</p>
                                    <p>Ervaring: {match.investor.ervaringLevel}</p>
                                    <p>Beschikbaarheid: {match.investor.beschikbaarheid}</p>
                                    {match.investor.locatieDetails && (
                                      <div className="mt-2 p-2 bg-blue-50 rounded border border-blue-200">
                                        <p className="font-medium text-blue-800">Locatie Details:</p>
                                        <p className="text-blue-700">{match.investor.locatieDetails}</p>
                                      </div>
                                    )}
                                    {match.investor.investmentMotivatie && (
                                      <div className="mt-2 p-2 bg-green-50 rounded border border-green-200">
                                        <p className="font-medium text-green-800">Investment Motivatie:</p>
                                        <p className="text-green-700">{match.investor.investmentMotivatie}</p>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>

                              <div className="mt-6 flex flex-wrap gap-2">
                                <button
                                  onClick={() => getSmartMatchingInsights(match.deal.id, match.investor.id)}
                                  disabled={isLoadingAI}
                                  className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center space-x-2"
                                >
                                  <BrainIcon size={16} />
                                  <span>{isLoadingAI ? 'AI Analyseert...' : 'üî• Enhanced AI Analyse'}</span>
                                </button>
                                <button
                                  onClick={() => alert(`Contacteer ${match.investor.naam} via ${match.investor.communicatieVoorkeur.toLowerCase()}: ${match.investor.email}`)}
                                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2"
                                >
                                  <MailIcon size={16} />
                                  <span>Contact</span>
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeTab === 'transactions' && (
                <div>
                  <div className="mb-6">
                    <h2 className="text-2xl font-bold mb-4">Transacties & Commissies</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                      <div className="bg-white p-4 rounded-lg shadow border">
                        <h3 className="font-semibold text-gray-700">Totale Commissie</h3>
                        <p className="text-2xl font-bold text-green-600">
                          ‚Ç¨{calculateCommissionSummary().totalCommission.toLocaleString()}
                        </p>
                      </div>
                      <div className="bg-white p-4 rounded-lg shadow border">
                        <h3 className="font-semibold text-gray-700">Afgeronde Deals</h3>
                        <p className="text-2xl font-bold text-blue-600">
                          {calculateCommissionSummary().completedTransactions}
                        </p>
                      </div>
                      <div className="bg-white p-4 rounded-lg shadow border">
                        <h3 className="font-semibold text-gray-700">Pending Deals</h3>
                        <p className="text-2xl font-bold text-yellow-600">
                          {calculateCommissionSummary().pendingTransactions}
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-6">
                    {transactions.map(transaction => {
                      const deal = deals.find(d => d.id === transaction.deal_id);
                      const investor = investors.find(i => i.id === transaction.investor_id);
                      
                      let participantCommissions = [];
                      try {
                        participantCommissions = transaction.participant_commissions ? 
                          JSON.parse(transaction.participant_commissions) : [];
                      } catch (e) {
                        console.error('Error parsing participant commissions:', e);
                      }

                      return (
                        <div key={transaction.id} className="bg-white rounded-lg shadow-md p-6 border">
                          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4">
                            <div>
                              <h3 className="text-xl font-semibold mb-2">
                                {deal?.titel || 'Onbekende Deal'}
                              </h3>
                              <div className="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                                <span>Investeerder: {investor?.naam || 'Onbekend'}</span>
                                <span>Waarde: ‚Ç¨{transaction.transaction_amount.toLocaleString()}</span>
                                <span>Commissie: ‚Ç¨{transaction.total_commission.toLocaleString()}</span>
                              </div>
                            </div>
                            <div className="mt-4 lg:mt-0">
                              <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                transaction.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                              }`}>
                                {transaction.status === 'completed' ? 'Afgerond' : 'Pending'}
                              </span>
                            </div>
                          </div>

                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                              <h4 className="font-semibold mb-3">Deal Details:</h4>
                              <div className="space-y-2 text-sm">
                                {deal?.bedrijfFonds && <p>Bedrijf/Fonds: {deal.bedrijfFonds}</p>}
                                <p>Locatie: {deal?.locatie || 'Onbekend'}</p>
                                <p>Type: {deal?.type || 'Onbekend'}</p>
                                <p>Project: {deal?.projectType || 'Onbekend'}</p>
                                <p>Verwacht rendement: {deal?.verwachtRendement || 0}%</p>
                              </div>
                            </div>
                            <div>
                              <h4 className="font-semibold mb-3">Commissie Verdeling:</h4>
                              <div className="space-y-2">
                                {participantCommissions.map((participant, index) => {
                                  const userName = participant.is_external 
                                    ? participant.name 
                                    : getUserById(participant.user_id).name;
                                  
                                  return (
                                    <div key={index} className="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                                      <span className="flex items-center space-x-2">
                                        <span>{userName} ({participant.role})</span>
                                        {participant.is_external && (
                                          <span className="px-1 py-0.5 bg-green-100 text-green-800 text-xs rounded">
                                            Extern
                                          </span>
                                        )}
                                      </span>
                                      <span className="font-semibold">
                                        ‚Ç¨{participant.commission_amount.toLocaleString()}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                              
                              {participantCommissions.some(p => p.is_external) && (
                                <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded">
                                  <h5 className="font-medium text-green-800 mb-2">Externe Partners:</h5>
                                  <div className="space-y-2 text-sm">
                                    {participantCommissions
                                      .filter(p => p.is_external)
                                      .map((participant, index) => (
                                        <div key={index} className="flex flex-col space-y-1">
                                          <span className="font-medium">{participant.name}</span>
                                          {participant.email && (
                                            <span className="text-gray-600">üìß {participant.email}</span>
                                          )}
                                          {participant.company && (
                                            <span className="text-gray-600">üè¢ {participant.company}</span>
                                          )}
                                        </div>
                                      ))
                                    }
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              {Object.keys(aiInsights).length > 0 && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                      <h4 className="text-xl font-bold flex items-center space-x-2">
                        <BrainIcon size={20} />
                        <span>üî• Enhanced AI Analyse</span>
                      </h4>
                      <button
                        onClick={() => setAiInsights({})}
                        className="text-gray-400 hover:text-gray-600 text-xl"
                      >
                        ‚úï
                      </button>
                    </div>
                    <div className="p-6">
                      {Object.entries(aiInsights).slice(-1).map(([key, insight]) => (
                        <div key={key} className="space-y-6">
                          <div className="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                            <h3 className="font-bold text-lg mb-2 text-purple-900">
                              {key.includes('enhanced_match') ? 'üî• Enhanced Smart Match Analyse' :
                              key.includes('investor') ? 'üë§ Investeerder Analyse' :
                              key.includes('deal') ? 'üè¢ Deal Analyse' :
                              'üìä Markt Inzichten'}
                            </h3>
                            <p className="text-sm text-purple-700">
                              Gegenereerd op {new Date().toLocaleString('nl-NL')} | Enhanced met semantic analysis
                            </p>
                          </div>
                          
                          {typeof insight === 'object' && insight.semanticScore !== undefined ? (
                            <div className="space-y-4">
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h4 className="font-semibold text-purple-800 mb-3">üî• Enhanced Semantic Analysis:</h4>
                                {insight.semanticReasons && insight.semanticReasons.map((reason, idx) => (
                                  <div key={idx} className="bg-white p-3 rounded border border-purple-200 mb-2">
                                    <p className="text-purple-700">{reason}</p>
                                  </div>
                                ))}
                                <div className="mt-3 p-3 bg-white rounded border border-purple-300">
                                  <p className="font-medium text-purple-900">
                                    Semantic Score: <span className="text-2xl">{insight.semanticScore || 0}</span> punten
                                  </p>
                                  <p className="text-purple-700 text-sm">
                                    Based on AI analysis of investment motivatie vs deal beschrijving
                                  </p>
                                </div>
                              </div>
                              
                              {insight.pitchRecommendations && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                  <h4 className="font-semibold text-green-800 mb-3">üí° Pitch Aanbevelingen:</h4>
                                  <ul className="space-y-2">
                                    {insight.pitchRecommendations.map((rec, idx) => (
                                      <li key={idx} className="flex items-start space-x-2">
                                        <span className="text-green-600 font-bold">‚Ä¢</span>
                                        <span className="text-green-700">{rec}</span>
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {insight.overallCompatibility && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                  <h4 className="font-semibold text-blue-800 mb-3">üìà Overall Compatibility:</h4>
                                  <div className="flex items-center space-x-4">
                                    <div className="text-3xl font-bold text-blue-600">
                                      {insight.overallCompatibility}%
                                    </div>
                                    <div className="flex-1">
                                      <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                          className="bg-blue-600 h-3 rounded-full transition-all duration-500"
                                          style={{ width: `${insight.overallCompatibility}%` }}
                                        ></div>
                                      </div>
                                      <p className="text-blue-700 text-sm mt-1">
                                        Enhanced score including semantic matching
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          ) : typeof insight === 'object' && insight.fullAnalysis ? (
                            <div className="space-y-4">
                              <div className="bg-white border rounded-lg p-4">
                                <h4 className="font-semibold text-gray-800 mb-3">ü§ñ AI Analyse:</h4>
                                <div className="prose prose-sm max-w-none">
                                  {insight.fullAnalysis.split('\n').map((line, idx) => (
                                    <p key={idx} className="mb-2 text-gray-700 leading-relaxed">
                                      {line}
                                    </p>
                                  ))}
                                </div>
                              </div>
                              
                              {insight.aiRecommendations && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                  <h4 className="font-semibold text-green-800 mb-3">üí° Aanbevelingen:</h4>
                                  <ul className="space-y-2">
                                    {insight.aiRecommendations.map((rec, idx) => (
                                      <li key={idx} className="flex items-start space-x-2">
                                        <span className="text-green-600 font-bold">‚Ä¢</span>
                                        <span className="text-green-700">{rec}</span>
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                            </div>
                          ) : (
                            <div className="bg-gray-50 border rounded-lg p-4">
                              <p className="text-gray-700">
                                {typeof insight === 'string' ? insight : JSON.stringify(insight, null, 2)}
                              </p>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                    <div className="sticky bottom-0 bg-white border-t p-4 flex justify-between items-center">
                      <div className="text-sm text-gray-500">
                        üî• Enhanced: Analyse includes semantic matching van teksten en beschrijvingen
                      </div>
                      <button
                        onClick={() => setAiInsights({})}
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                      >
                        Sluiten
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modals */}
              <CsvUploadModal />
              <ContactConversionModal />

              {showAddInvestor && (
                <InvestorForm
                  onSubmit={handleAddInvestor}
                  onCancel={() => setShowAddInvestor(false)}
                />
              )}

              {showEditInvestor && editingInvestor && (
                <InvestorForm
                  editData={editingInvestor}
                  onSubmit={handleUpdateInvestor}
                  onCancel={() => {
                    setShowEditInvestor(false);
                    setEditingInvestor(null);
                  }}
                />
              )}

              {showAddDeal && (
                <DealForm
                  onSubmit={handleAddDeal}
                  onCancel={() => setShowAddDeal(false)}
                />
              )}

              {showEditDeal && editingDeal && (
                <DealForm
                  editData={editingDeal}
                  onSubmit={handleUpdateDeal}
                  onCancel={() => {
                    setShowEditDeal(false);
                    setEditingDeal(null);
                  }}
                />
              )}

              {showAddBroker && (
                <BrokerForm
                  onSubmit={handleAddBroker}
                  onCancel={() => setShowAddBroker(false)}
                />
              )}

              {showEditBroker && editingBroker && (
                <BrokerForm
                  editData={editingBroker}
                  onSubmit={handleUpdateBroker}
                  onCancel={() => {
                    setShowEditBroker(false);
                    setEditingBroker(null);
                  }}
                />
              )}

              <CommissionEditor />
            </div>
          );
        };

        // Initialize the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(VastgoedInvesteerderMatcher));

        console.log('üöÄ Vastgoed Matcher Pro AI - Enhanced + CSV Upload geladen!');
        console.log('üî• Firebase Authentication & Database ge√Øntegreerd');
        console.log('üî• NIEUWE CSV UPLOAD FEATURES:');
        console.log('   ‚Ä¢ üìÑ CSV CONTACTEN UPLOAD');
        console.log('     - Upload LinkedIn exports of andere CSV contactenlijsten');
        console.log('     - Preview van contacten voor upload naar Firebase');
        console.log('     - Ondersteuning voor verschillende CSV formaten en kolom namen');
        console.log('     - Automatische detectie van First Name, Last Name, Email, Company, Position, etc.');
        console.log('   ‚Ä¢ üîÑ CONTACT CONVERSIE SYSTEEM');
        console.log('     - Handmatige conversie van contacten naar investeerders of brokers');
        console.log('     - AI classificatie suggesties gebaseerd op functietitel en bedrijf');
        console.log('     - Tracking van conversie status per contact');
        console.log('     - Overzicht van geconverteerde vs nieuwe contacten');
        console.log('   ‚Ä¢ ü§ñ AI CONTACT ANALYSE');
        console.log('     - AI analyseert functietitels en bedrijfsnamen');
        console.log('     - Suggesteert of contact investeerder of broker is');
        console.log('     - Confidence scoring voor AI suggesties');
        console.log('     - Hulp bij besluitvorming voor conversie');
        console.log('   ‚Ä¢ üìä CONTACTEN MANAGEMENT TAB');
        console.log('     - Dedicated tab voor alle ge√ºploade contacten');
        console.log('     - Filter opties: Alle / Nieuw / Geconverteerd');
        console.log('     - Contact details en conversie status');
        console.log('     - Bulk import en individual conversion workflows');
        console.log('   ‚Ä¢ üîó INTEGRATIE MET BESTAANDE SYSTEEM');
        console.log('     - Contacten collectie in Firebase naast investors en brokers');
        console.log('     - Geconverteerde contacten gekoppeld aan originele contact record');
        console.log('     - Audit trail van conversies en owner tracking');
        console.log('     - Dashboard stats met contact activiteit');
        console.log('üíæ DATABASE STRUCTUUR UITGEBREID:');
        console.log('   ‚Ä¢ contacts collection met alle CSV upload data');
        console.log('   ‚Ä¢ convertedFrom veld in investors/brokers voor traceability');
        console.log('   ‚Ä¢ isConverted en convertedTo status tracking');
        console.log('   ‚Ä¢ owner_id voor team collaboration op contacten');
        console.log('üåü ALLE BESTAANDE FEATURES BEHOUDEN:');
        console.log('   ‚Ä¢ ‚úÖ Enhanced AI semantic matching');
        console.log('   ‚Ä¢ ‚úÖ Vereenvoudigde locatie invoer');
        console.log('   ‚Ä¢ ‚úÖ Broker management');
        console.log('   ‚Ä¢ ‚úÖ Commissie structuren');
        console.log('   ‚Ä¢ ‚úÖ Edit functionaliteit');
        console.log('   ‚Ä¢ ‚úÖ Firebase integratie');
        console.log('   ‚Ä¢ ‚úÖ Team collaboration');
        console.log('   ‚Ä¢ ‚úÖ Transactie tracking');
        console.log('üéØ WORKFLOW VERBETERING:');
        console.log('   1. Upload CSV bestand via Contacten tab');
        console.log('   2. Preview en bevestig contacten data');
        console.log('   3. Upload naar Firebase contacten database');
        console.log('   4. Filter en bekijk nieuwe contacten');
        console.log('   5. Gebruik AI suggesties voor classificatie');
        console.log('   6. Converteer handmatig naar investeerder of broker');
        console.log('   7. Gebruik in normale matching workflows');
        console.log('üìã CSV FORMAAT ONDERSTEUNING:');
        console.log('   ‚Ä¢ First Name, Last Name, Email Address, Company, Position');
        console.log('   ‚Ä¢ URL (LinkedIn), Phone, Location, Notes');
        console.log('   ‚Ä¢ Alternative namen: first_name, naam, achternaam, email, bedrijf, etc.');
        console.log('   ‚Ä¢ Flexible parsing met Papa Parse library');
        console.log('   ‚Ä¢ Skip empty lines en header detection');
    </script>
</body>
</html>
                                  </td>
                                  <td className="border border-gray-300 p-2">
                                    <span className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                      Nieuw
                                    </span>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                        {csvData.length > 10 && (
                          <p className="text-sm text-gray-600 mt-2">
                            ... en nog {csvData.length - 10} meer contacten
                          </p>
                        )}
                      </div>
                    )}
                  </div>

                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-between items-center">
                      <div className="text-sm text-gray-600">
                        {csvData.length} contacten klaar voor upload naar Firebase
                      </div>
                      <div className="flex space-x-4">
                        <button
                          onClick={() => {
                            setShowCsvUpload(false);
                            setCsvData([]);
                          }}
                          className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                        >
                          Annuleren
                        </button>
                        <button
                          onClick={uploadContactsToFirebase}
                          disabled={isUploadingCsv}
                          className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 flex items-center space-x-2"
                        >
                          {isUploadingCsv ? (
                            <>
                              <div className="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                              <span>Uploading...</span>
                            </>
                          ) : (
                            <>
                              <UploadIcon size={16} />
                              <span>üìÑ Upload naar Firebase</span>
                            </>
                          )}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // üî• NEW: Contact Conversion Modal
          const ContactConversionModal = () => {
            if (!showConvertModal || !convertingContact) return null;

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-2xl">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold flex items-center space-x-2">
                      <RefreshIcon size={20} />
                      <span>üîÑ Contact Converteren</span>
                    </h3>
                    <p className="text-sm text-gray-600 mt-2">
                      Converteer "{convertingContact.fullName}" naar een investeerder of broker
                    </p>
                  </div>
                  
                  <div className="p-6">
                    <div className="mb-6 p-4 bg-gray-50 rounded border">
                      <h4 className="font-semibold mb-2">Contact Details:</h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="font-medium">Naam:</span> {convertingContact.fullName}
                        </div>
                        <div>
                          <span className="font-medium">Email:</span> {convertingContact.email}
                        </div>
                        <div>
                          <span className="font-medium">Bedrijf:</span> {convertingContact.company}
                        </div>
                        <div>
                          <span className="font-medium">Positie:</span> {convertingContact.position}
                        </div>
                      </div>
                      {convertingContact.notes && (
                        <div className="mt-2">
                          <span className="font-medium">Notities:</span> {convertingContact.notes}
                        </div>
                      )}
                    </div>

                    <div className="text-center">
                      <p className="text-lg font-semibold mb-4">Converteer naar:</p>
                      <div className="flex justify-center space-x-4">
                        <button
                          onClick={() => {
                            convertContactToInvestor(convertingContact);
                            setShowConvertModal(false);
                            setConvertingContact(null);
                          }}
                          className="flex flex-col items-center p-6 border-2 border-blue-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors"
                        >
                          <span className="text-4xl mb-2">üè¶</span>
                          <span className="font-semibold text-blue-600">Investeerder</span>
                          <span className="text-sm text-gray-600 mt-1">Vastgoedinvesteerder of fonds</span>
                        </button>
                        <button
                          onClick={() => {
                            convertContactToBroker(convertingContact);
                            setShowConvertModal(false);
                            setConvertingContact(null);
                          }}
                          className="flex flex-col items-center p-6 border-2 border-green-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors"
                        >
                          <span className="text-4xl mb-2">üè¢</span>
                          <span className="font-semibold text-green-600">Broker</span>
                          <span className="text-sm text-gray-600 mt-1">Makelaar of vastgoed agent</span>
                        </button>
                      </div>
                    </div>
                  </div>

                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-end space-x-4">
                      <button
                        onClick={() => {
                          setShowConvertModal(false);
                          setConvertingContact(null);
                        }}
                        className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                      >
                        Annuleren
                      </button>
                      <button
                        onClick={async () => {
                          const insights = await getContactClassification(convertingContact);
                          alert(`AI Suggestie:\n\nType: ${insights.suggestedType}\nConfidence: ${(insights.confidence * 100).toFixed(0)}%\n\nRedenering:\n${insights.reasoning.join('\n')}`);
                        }}
                        disabled={isLoadingAI}
                        className="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 flex items-center space-x-2"
                      >
                        <BrainIcon size={16} />
                        <span>{isLoadingAI ? 'AI...' : 'ü§ñ AI Suggestie'}</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // Commission Editor Component (unchanged)
          const CommissionEditor = () => {
            if (!showCommissionEditor || !editingDealCommission) return null;

            const [commissionStructure, setCommissionStructure] = useState(
              editingDealCommission.commissionStructure || {
                total_rate: 0.025,
                participants: [
                  { 
                    role: 'deal_owner', 
                    user_id: editingDealCommission.owner_id, 
                    percentage: 100, 
                    fixed_amount: 0, 
                    type: 'percentage',
                    name: getUserById(editingDealCommission.owner_id).name,
                    is_external: false
                  }
                ]
              }
            );

            const totalCommission = editingDealCommission.prijs * commissionStructure.total_rate;

            const updateParticipant = (index, field, value) => {
              const newParticipants = [...commissionStructure.participants];
              newParticipants[index] = { ...newParticipants[index], [field]: value };
              
              if (field === 'user_id' && !newParticipants[index].is_external) {
                const user = getUserById(value);
                newParticipants[index].name = user.name;
              }
              
              setCommissionStructure({ ...commissionStructure, participants: newParticipants });
            };

            const addParticipant = (isExternal = false) => {
              setCommissionStructure({
                ...commissionStructure,
                participants: [
                  ...commissionStructure.participants,
                  { 
                    role: 'referral', 
                    user_id: null, 
                    percentage: 0, 
                    fixed_amount: 0, 
                    type: 'percentage',
                    name: '',
                    email: '',
                    company: '',
                    is_external: isExternal
                  }
                ]
              });
            };

            const removeParticipant = (index) => {
              if (commissionStructure.participants.length > 1) {
                const newParticipants = commissionStructure.participants.filter((_, i) => i !== index);
                setCommissionStructure({ ...commissionStructure, participants: newParticipants });
              }
            };

            const handleSave = async () => {
              const totalPercentage = commissionStructure.participants
                .filter(p => p.type === 'percentage')
                .reduce((sum, p) => sum + (p.percentage || 0), 0);
              
              if (totalPercentage > 100) {
                alert('Totaal percentage kan niet meer dan 100% zijn!');
                return;
              }

              await saveCommissionStructure(editingDealCommission.id, commissionStructure);
              setShowCommissionEditor(false);
              setEditingDealCommission(null);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-y-auto">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold flex items-center space-x-2">
                      <PercentIcon size={20} />
                      <span>Commissie Structuur Beheren</span>
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">
                      Deal: {editingDealCommission.titel} - ‚Ç¨{editingDealCommission.prijs.toLocaleString()}
                    </p>
                  </div>
                  
                  <div className="p-6">
                    <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <label className="block text-sm font-medium mb-2">Totale Commissie Rate (%)</label>
                      <div className="flex items-center space-x-4">
                        <input
                          type="number"
                          step="0.001"
                          value={commissionStructure.total_rate * 100}
                          onChange={(e) => setCommissionStructure({
                            ...commissionStructure,
                            total_rate: parseFloat(e.target.value) / 100
                          })}
                          className="w-32 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <span className="text-lg font-semibold text-blue-600">
                          = ‚Ç¨{totalCommission.toLocaleString()}
                        </span>
                        <span className="text-sm text-gray-600">
                          van ‚Ç¨{editingDealCommission.prijs.toLocaleString()}
                        </span>
                      </div>
                    </div>

                    <div className="space-y-4 mb-6">
                      <div className="flex items-center justify-between">
                        <h4 className="font-semibold">Commissie Verdeling:</h4>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => addParticipant(false)}
                            className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 flex items-center space-x-1"
                          >
                            <PlusIcon size={14} />
                            <span>Teamlid</span>
                          </button>
                          <button
                            onClick={() => addParticipant(true)}
                            className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 flex items-center space-x-1"
                          >
                            <ExternalLinkIcon size={14} />
                            <span>Extern</span>
                          </button>
                        </div>
                      </div>

                      {commissionStructure.participants.map((participant, index) => (
                        <div key={index} className="border rounded p-4 bg-gray-50">
                          <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1">Rol</label>
                              <select
                                value={participant.role}
                                onChange={(e) => updateParticipant(index, 'role', e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                              >
                                <option value="deal_owner">Deal Eigenaar</option>
                                <option value="investor_referral">Investeerder Referral</option>
                                <option value="referral">Verwijzer</option>
                                <option value="manager">Manager</option>
                                <option value="assistant">Assistent</option>
                                <option value="broker">Makelaar</option>
                                <option value="consultant">Consultant</option>
                              </select>
                            </div>

                            <div>
                              <label className="block text-sm font-medium mb-1">
                                {participant.is_external ? 'Naam' : 'Teamlid'}
                              </label>
                              {participant.is_external ? (
                                <input
                                  type="text"
                                  value={participant.name}
                                  onChange={(e) => updateParticipant(index, 'name', e.target.value)}
                                  className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                  placeholder="Volledige naam"
                                />
                              ) : (
                                <select
                                  value={participant.user_id || ''}
                                  onChange={(e) => updateParticipant(index, 'user_id', e.target.value)}
                                  className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                >
                                  <option value="">Selecteer...</option>
                                  {users.map(user => (
                                    <option key={user.id} value={user.id}>{user.name}</option>
                                  ))}
                                </select>
                              )}
                            </div>

                            {participant.is_external && (
                              <>
                                <div>
                                  <label className="block text-sm font-medium mb-1">Email</label>
                                  <input
                                    type="email"
                                    value={participant.email || ''}
                                    onChange={(e) => updateParticipant(index, 'email', e.target.value)}
                                    className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    placeholder="email@example.com"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium mb-1">Bedrijf</label>
                                  <input
                                    type="text"
                                    value={participant.company || ''}
                                    onChange={(e) => updateParticipant(index, 'company', e.target.value)}
                                    className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    placeholder="Bedrijfsnaam"
                                  />
                                </div>
                              </>
                            )}

                            <div className={participant.is_external ? '' : 'md:col-start-4'}>
                              <label className="block text-sm font-medium mb-1">Type</label>
                              <select
                                value={participant.type}
                                onChange={(e) => updateParticipant(index, 'type', e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                              >
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Vast Bedrag</option>
                              </select>
                            </div>

                            <div>
                              <label className="block text-sm font-medium mb-1">
                                {participant.type === 'percentage' ? 'Percentage (%)' : 'Bedrag (‚Ç¨)'}
                              </label>
                              <input
                                type="number"
                                step={participant.type === 'percentage' ? '0.1' : '1'}
                                value={participant.type === 'percentage' ? participant.percentage : participant.fixed_amount}
                                onChange={(e) => updateParticipant(
                                  index, 
                                  participant.type === 'percentage' ? 'percentage' : 'fixed_amount', 
                                  parseFloat(e.target.value)
                                )}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                              />
                            </div>

                            <div className="flex items-end">
                              {commissionStructure.participants.length > 1 && (
                                <button
                                  onClick={() => removeParticipant(index)}
                                  className="text-red-600 hover:text-red-800 text-sm p-2"
                                >
                                  <TrashIcon size={16} />
                                </button>
                              )}
                            </div>
                          </div>

                          <div className="mt-2 text-sm text-gray-600">
                            Commissie: ‚Ç¨{participant.type === 'percentage' 
                              ? (totalCommission * (participant.percentage / 100)).toLocaleString()
                              : (participant.fixed_amount || 0).toLocaleString()
                            }
                            {participant.is_external && (
                              <span className="ml-2 px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                Extern
                              </span>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="bg-blue-50 p-4 rounded mb-6 border border-blue-200">
                      <h5 className="font-semibold mb-2">Commissie Overzicht:</h5>
                      <div className="space-y-1 text-sm">
                        {commissionStructure.participants.map((participant, index) => {
                          const commission = participant.type === 'percentage' 
                            ? totalCommission * (participant.percentage / 100)
                            : participant.fixed_amount;
                          
                          const displayName = participant.is_external 
                            ? participant.name 
                            : getUserById(participant.user_id).name;
                          
                          return (
                            <div key={index} className="flex justify-between">
                              <span>
                                {displayName} ({participant.role})
                                {participant.is_external && <span className="text-green-600 ml-1">üìß</span>}
                              </span>
                              <span>‚Ç¨{commission.toLocaleString()}</span>
                            </div>
                          );
                        })}
                        <div className="border-t pt-1 font-semibold flex justify-between">
                          <span>Totaal:</span>
                          <span>‚Ç¨{totalCommission.toLocaleString()}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="p-6 border-t bg-gray-50 flex justify-end space-x-4">
                    <button
                      onClick={() => {
                        setShowCommissionEditor(false);
                        setEditingDealCommission(null);
                      }}
                      className="px-6 py-2 text-gray-600 border rounded hover:bg-gray-100"
                    >
                      Annuleren
                    </button>
                    <button
                      onClick={handleSave}
                      className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      üíæ Opslaan
                    </button>
                  </div>
                </div>
              </div>
            );
          };
