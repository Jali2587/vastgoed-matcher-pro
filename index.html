<!DOCTYPE html>
<html lang="nl">
<head>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
      apiKey: "AIzaSyD5daKmpLUMcxmOiAXkPkmiJrZ5kDG3HMo",
      authDomain: "vastgoed-matcher-mvp.firebaseapp.com",
      projectId: "vastgoed-matcher-mvp",
      storageBucket: "vastgoed-matcher-mvp.appspot.com",
      messagingSenderId: "785479169064",
      appId: "1:785479169064:web:eb328415e1277241df311d"
  };

  // Initialize Firebase if not already initialized
  if (!firebase.apps.length) {
      
  }

  // Make auth and firestore globally available
  const auth = firebase.auth();
  const db = firebase.firestore();
</script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vastgoed Matcher Pro AI - Enhanced</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Configuration -->
    <script>
        // JOUW ECHTE FIREBASE CONFIGURATIE
        const firebaseConfig = {
            apiKey: "AIzaSyD5daKmpLUMcxmOiAXkPkmiJrZ5kDG3HMo",
            authDomain: "vastgoed-matcher-mvp.firebaseapp.com",
            projectId: "vastgoed-matcher-mvp",
            storageBucket: "vastgoed-matcher-mvp.appspot.com",
            messagingSenderId: "785479169064",
            appId: "1:785479169064:web:eb328415e1277241df311d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        console.log('🔥 Firebase initialized successfully!');
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Simple icon components to avoid React errors
        const PlusIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M12 5v14M5 12h14' }));
        
        const UsersIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2' }), React.createElement('circle', { cx: '9', cy: '7', r: '4' }), React.createElement('path', { d: 'M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75' }));
        
        const BuildingIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z' }), React.createElement('path', { d: 'M6 12h4h4' }), React.createElement('path', { d: 'M6 20h4h4' }), React.createElement('path', { d: 'M10 4h4' }), React.createElement('path', { d: 'M10 8h4' }));
        
        const StarIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polygon', { points: '12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26' }));
        
        const FilterIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polygon', { points: '22,3 2,3 10,12.46 10,19 14,21 14,12.46' }));
        
        const MailIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z' }), React.createElement('polyline', { points: '22,6 12,13 2,6' }));
        
        const PhoneIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z' }));
        
        const MapPinIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z' }), React.createElement('circle', { cx: '12', cy: '10', r: '3' }));
        
        const EuroIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M18.5 6.5a9 9 0 0 0-9 9v0a9 9 0 0 0 9 9M6 12h9' }));
        
        const TrendingUpIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polyline', { points: '22,7 13.5,15.5 8.5,10.5 2,17' }), React.createElement('polyline', { points: '16,7 22,7 22,13' }));
        
        const CalendarIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('rect', { x: '3', y: '4', width: '18', height: '18', rx: '2', ry: '2' }), React.createElement('line', { x1: '16', y1: '2', x2: '16', y2: '6' }), React.createElement('line', { x1: '8', y1: '2', x2: '8', y2: '6' }), React.createElement('line', { x1: '3', y1: '10', x2: '21', y2: '10' }));
        
        const AlertCircleIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '12', r: '10' }), React.createElement('line', { x1: '12', y1: '8', x2: '12', y2: '12' }), React.createElement('line', { x1: '12', y1: '16', x2: '12.01', y2: '16' }));
        
        const LogOutIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4' }), React.createElement('polyline', { points: '16,17 21,12 16,7' }), React.createElement('line', { x1: '21', y1: '12', x2: '9', y2: '12' }));
        
        const UserIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2' }), React.createElement('circle', { cx: '12', cy: '7', r: '4' }));
        
        const BrainIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M12 2a3 3 0 0 0-3 3 3 3 0 0 0-3 3v1a3 3 0 0 0 3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0 3-3V8a3 3 0 0 0-3-3 3 3 0 0 0-3-3z' }));
        
        const SearchIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '11', cy: '11', r: '8' }), React.createElement('path', { d: 'M21 21l-4.35-4.35' }));
        
        const FileTextIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }), React.createElement('polyline', { points: '14,2 14,8 20,8' }), React.createElement('line', { x1: '16', y1: '13', x2: '8', y2: '13' }), React.createElement('line', { x1: '16', y1: '17', x2: '8', y2: '17' }), React.createElement('polyline', { points: '10,9 9,9 8,9' }));
        
        const TargetIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '12', r: '10' }), React.createElement('circle', { cx: '12', cy: '12', r: '6' }), React.createElement('circle', { cx: '12', cy: '12', r: '2' }));
        
        const ZapIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polygon', { points: '13,2 3,14 12,14 11,22 21,10 12,10' }));
        
        const DollarSignIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('line', { x1: '12', y1: '1', x2: '12', y2: '23' }), React.createElement('path', { d: 'M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6' }));
        
        const UserCheckIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2' }), React.createElement('circle', { cx: '8.5', cy: '7', r: '4' }), React.createElement('polyline', { points: '17,11 19,13 23,9' }));
        
        const AwardIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '8', r: '7' }), React.createElement('polyline', { points: '8.21,13.89 7,23 12,20 17,23 15.79,13.88' }));
        
        const SettingsIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('circle', { cx: '12', cy: '12', r: '3' }), React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z' }));
        
        const EditIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7' }), React.createElement('path', { d: 'M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z' }));
        
        const TrashIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('polyline', { points: '3,6 5,6 21,6' }), React.createElement('path', { d: 'M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2' }), React.createElement('line', { x1: '10', y1: '11', x2: '10', y2: '17' }), React.createElement('line', { x1: '14', y1: '11', x2: '14', y2: '17' }));

        const PercentIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('line', { x1: '19', y1: '5', x2: '5', y2: '19' }), React.createElement('circle', { cx: '6.5', cy: '6.5', r: '2.5' }), React.createElement('circle', { cx: '17.5', cy: '17.5', r: '2.5' }));

        const ExternalLinkIcon = ({ size = 20, className = '' }) => React.createElement('svg', { 
          width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: '2', className 
        }, React.createElement('path', { d: 'M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6' }), React.createElement('polyline', { points: '15,3 21,3 21,9' }), React.createElement('line', { x1: '10', y1: '14', x2: '21', y2: '3' }));

        const VastgoedInvesteerderMatcher = () => {
          const [user, setUser] = useState(null);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [investors, setInvestors] = useState([]);
          const [deals, setDeals] = useState([]);
          const [transactions, setTransactions] = useState([]);
          const [users, setUsers] = useState([]);
          const [matches, setMatches] = useState([]);
          const [showAddInvestor, setShowAddInvestor] = useState(false);
          const [showAddDeal, setShowAddDeal] = useState(false);
          const [showAuth, setShowAuth] = useState(true);
          const [aiInsights, setAiInsights] = useState({});
          const [isLoadingAI, setIsLoadingAI] = useState(false);
          
          const [showCommissionEditor, setShowCommissionEditor] = useState(false);
          const [editingDealCommission, setEditingDealCommission] = useState(null);
          const [currentTransaction, setCurrentTransaction] = useState(null);

          const [editingInvestor, setEditingInvestor] = useState(null);
          const [editingDeal, setEditingDeal] = useState(null);
          const [showEditInvestor, setShowEditInvestor] = useState(false);
          const [showEditDeal, setShowEditDeal] = useState(false);

          // 🔥 NEW: Broker Management State
          const [brokers, setBrokers] = useState([]);
          const [showAddBroker, setShowAddBroker] = useState(false);
          const [editingBroker, setEditingBroker] = useState(null);
          const [showEditBroker, setShowEditBroker] = useState(false);
          const [contactFilter, setContactFilter] = useState('all'); // all, investors, brokers

          // 🔥 ENHANCED AI MATCHING WITH SEMANTIC ANALYSIS
          const callOpenAI = async (prompt, type = 'analysis', data = null) => {
            setIsLoadingAI(true);
            
            try {
              const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, type, data })
              });
              
              if (response.ok) {
                const result = await response.json();
                setIsLoadingAI(false);
                return result.data;
              }
            } catch (error) {
              console.log('OpenAI API niet beschikbaar, gebruik demo data:', error);
            }
            
            // Enhanced fallback with semantic matching simulation
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const mockResponses = {
              enhanced_matching: {
                semanticScore: 85,
                semanticReasons: [
                  'Sterke match: "stabiele huurinkomsten" ↔ "gegarandeerde huurder 5 jaar"',
                  'Perfecte match: "geen renovatie" ↔ "turn-key appartement"', 
                  'Goede match: "duurzaamheid belangrijk" ↔ "energielabel A"',
                  'Match: "ervaring met appartementen" ↔ "luxe appartement complex"'
                ],
                conflictAnalysis: [],
                overallCompatibility: 92,
                pitchRecommendations: [
                  'Benadruk de gegarandeerde huurinkomsten van 5 jaar',
                  'Vermeld turn-key voordeel: direct rendement zonder werk',
                  'Highlight duurzaamheid: energielabel A en lage kosten',
                  'Toon vergelijkbare succesvolle projecten in portfolio'
                ]
              },
              investor_analysis: {
                financialStrength: 'Hoog - Stabiele inkomstenbron via vastgoedbeleggingen',
                riskAppetite: 'Gemiddeld tot hoog - Ervaren investeerder met diversified portfolio',
                marketKnowledge: 'Goed - Actief in Nederlandse vastgoedmarkt sinds 2015',
                preferredSectors: ['Residentieel', 'Commercieel retail'],
                projectTypePreference: ['Turn-key', 'Renovatie'],
                investmentStrategy: 'Buy-and-hold met focus op cashflow generatie',
                recommendations: 'Geschikt voor deals met stabiele huurinkomsten en potentieel voor waardestijging',
                behaviorProfile: 'Voorzichtige beslisser, graag veel informatie vooraf',
                investmentTimeline: 'Zoekt deals voor Q2-Q3 2024',
                marketSentiment: 'Positief over vastgoedmarkt, maar voorzichtig met nieuwe projecten'
              },
              deal_analysis: {
                marketPosition: 'Aantrekkelijk - Locatie in groeiende wijk met goede bereikbaarheid',
                projectTypeAnalysis: 'Turn-key voordeel: Direct rendement, lagere ontwikkelingsrisico\'s',
                competitiveAnalysis: 'Vergelijkbare panden in de buurt hebben 5-7% rendement',
                riskFactors: [
                  'Mogelijke leegstand bij huurwisseling', 
                  'Onderhoudskosten oudere panden',
                  'Marktvolatiliteit in de regio'
                ],
                opportunities: [
                  'Huurverhoging mogelijk door renovatie', 
                  'Waardestijging door buurtverbetering',
                  'Turn-key voordeel: Direct rendement, lagere ontwikkelingsrisico\'s',
                  'Renovatie kansen: Waardecreatie door modernisering',
                  'Transformatie potentieel: Functiewijziging verhoogt marktwaarde'
                ],
                priceAnalysis: 'Marktconform geprijsd, kleine onderhandelingsruimte',
                recommendation: 'Aanbevolen voor conservatieve tot gemiddelde risico investeerders',
                marketTrends: 'Prijzen in dit gebied stijgen 3-5% per jaar',
                demographicAnalysis: 'Populair bij young professionals en small families',
                futureOutlook: 'Positieve ontwikkeling verwacht door infrastructuurprojecten'
              }
            };

            setIsLoadingAI(false);
            
            if (type === 'enhanced_matching') return mockResponses.enhanced_matching;
            if (type === 'investor_analysis') return mockResponses.investor_analysis;
            if (type === 'deal_analysis') return mockResponses.deal_analysis;
            
            return mockResponses.enhanced_matching;
          };

          // FIREBASE DATABASE FUNCTIES (unchanged)
          const loadData = async () => {
            if (!user) return;
            
            try {
              console.log('📊 Loading data from Firebase...');
              
              const usersSnapshot = await db.collection('users').get();
              const usersData = usersSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setUsers(usersData);
              
              const investorsSnapshot = await db.collection('investors').get();
              const investorsData = investorsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setInvestors(investorsData);

              // 🔥 NEW: Load brokers
              const brokersSnapshot = await db.collection('brokers').get();
              const brokersData = brokersSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setBrokers(brokersData);
              
              const dealsSnapshot = await db.collection('deals').get();
              const dealsData = dealsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setDeals(dealsData);
              
              const transactionsSnapshot = await db.collection('transactions').get();
              const transactionsData = transactionsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              setTransactions(transactionsData);
              
              console.log('✅ Data loaded from Firebase:', {
                users: usersData.length,
                investors: investorsData.length,
                brokers: brokersData.length,
                deals: dealsData.length,
                transactions: transactionsData.length
              });
              
            } catch (error) {
              console.error('❌ Error loading data from Firebase:', error);
              console.log('📋 Loading demo data as fallback...');
              await loadDemoData();
            }
          };

          const loadDemoData = async () => {
            console.log('🎭 Loading demo data...');
            
            const demoUsers = [
              { id: user.id, name: user.name, email: user.email, company: user.company, role: user.role || 'agent' }
            ];
            setUsers(demoUsers);
            
            const demoInvestors = [
              {
                id: 'demo1',
                naam: 'Peter van der Berg',
                email: 'peter@example.com',
                telefoon: '06-12345678',
                bedrijf: 'Berg Investments',
                locatie: 'Amsterdam',
                minBudget: 100000,
                maxBudget: 500000,
                // 🔥 SIMPLIFIED LOCATION FIELDS
                voorkeursLanden: ['Nederland', 'Duitsland'],
                voorkeursRegio: ['West-Europa'],
                locatieDetails: 'Amsterdam centrum bij de ring, nabij openbaar vervoer. Liever geen Zuidoost of Noord.',
                vastgoedTypes: ['Appartement', 'Kantoor'],
                projectTypes: ['Turn-key', 'Renovatie'],
                risicoprofiel: 'Gemiddeld',
                gewenstRendement: 6,
                investeringshorizon: 'Lang termijn',
                ervaringLevel: 'Ervaren',
                beschikbaarheid: 'Direct',
                communicatieVoorkeur: 'Telefoon',
                // 🔥 ENHANCED WITH SEMANTIC CONTENT
                investmentMotivatie: 'Zoek stabiele huurinkomsten voor pensioenopbouw. Geen renovatie projecten, liever turn-key appartementen. Ervaring met studentenhuisvesting. Duurzaamheid steeds belangrijker.',
                bijzonderheden: 'Heeft voorkeur voor energiezuinige panden. Geen ground floor retail. Ervaring met vastgoedbeheer.',
                owner_id: user.id,
                created_at: new Date().toISOString()
              }
            ];

            // 🔥 NEW: Demo Brokers
            const demoBrokers = [
              {
                id: 'broker1',
                naam: 'Sarah de Vries',
                email: 'sarah@vastgoedpro.nl',
                telefoon: '020-7654321',
                bedrijf: 'VastgoedPro Makelaars',
                locatie: 'Amsterdam',
                specialisaties: ['Commercieel', 'Kantoren', 'Retail'],
                werkgebied: ['Amsterdam', 'Haarlem', 'Almere'],
                ervaringJaren: 8,
                trackRecord: 'Gespecialiseerd in commercieel vastgoed €500K-€5M. 120+ deals afgelopen 5 jaar. Focus op kantoorpanden en retail.',
                commissieStructuur: '2.5% koper, 2.5% verkoper. Exclusieve deals 3%.',
                locatieDetails: 'Actief in Randstad, specialiteit Amsterdam Noord en Zuidas.',
                werkwijze: 'Proactieve deal sourcing, uitgebreid netwerk van investeerders. Snelle besluitvorming, transparante communicatie.',
                bijzonderheden: 'Spreekt vloeiend Engels en Duits. Ervaring met internationale investeerders. RICS gecertificeerd.',
                import_source: 'manual',
                owner_id: user.id,
                created_at: new Date().toISOString()
              }
            ];
            
            const demoDeals = [
              {
                id: 'demo1',
                titel: 'Modern Appartement Amsterdam',
                locatie: 'Amsterdam',
                type: 'Appartement',
                projectType: 'Turn-key',
                prijs: 350000,
                verwachtRendement: 5.5,
                risico: 'Gemiddeld',
                // 🔥 ENHANCED DESCRIPTION FOR SEMANTIC MATCHING  
                beschrijving: 'Kant-en-klaar nieuwbouw appartement in opkomende wijk Noord. Energielabel A, zonnepanelen, warmtepomp. Gegarandeerde huurder voor 5 jaar via corporatie. Nabij metro, 15 min naar centrum. Turn-key: direct rendement, geen werk aan.',
                oppervlakte: 85,
                bouwjaar: 2020,
                huurpotentie: 1800,
                status: 'Beschikbaar',
                bedrijfFonds: 'Demo Vastgoed B.V.',
                bijzonderheden: 'Duurzaam gebouwd, lage servicekosten. Professioneel beheer beschikbaar. Uitstekende buurt met goede voorzieningen.',
                contactpersoon: 'Maria Janssen',
                telefoon: '020-1234567',
                email: 'maria@demovastgoed.nl',
                isRelevant: true,
                ourScore: 8.5,
                aiAnalyzed: false,
                owner_id: user.id,
                created_at: new Date().toISOString(),
                commissionStructure: {
                  total_rate: 0.025,
                  participants: [
                    { 
                      role: 'deal_owner', 
                      user_id: user.id, 
                      percentage: 60, 
                      fixed_amount: 0, 
                      type: 'percentage',
                      name: user.name,
                      is_external: false
                    }
                  ]
                }
              }
            ];
            
            setInvestors(demoInvestors);
            setBrokers(demoBrokers); // 🔥 NEW
            setDeals(demoDeals);
            setTransactions([]);
            
            try {
              await saveDemoDataToFirebase(demoInvestors, demoBrokers, demoDeals);
            } catch (error) {
              console.log('Could not save demo data to Firebase:', error);
            }
          };
          
          const saveDemoDataToFirebase = async (investors, brokers, deals) => {
            try {
              for (const investor of investors) {
                await db.collection('investors').doc(investor.id).set({
                  ...investor,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              }

              // 🔥 NEW: Save brokers
              for (const broker of brokers) {
                await db.collection('brokers').doc(broker.id).set({
                  ...broker,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
              
              for (const deal of deals) {
                await db.collection('deals').doc(deal.id).set({
                  ...deal,
                  created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
              
              console.log('✅ Demo data saved to Firebase');
            } catch (error) {
              console.error('❌ Error saving demo data:', error);
            }
          };

          const getUserById = (id) => {
            return users.find(u => u.id === id) || { name: 'Onbekend', email: '' };
          };

          const testAIConnection = async () => {
            setIsLoadingAI(true);
            try {
              const response = await fetch('/.netlify/functions/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  prompt: "Test connectie", 
                  type: 'connection_test', 
                  data: { test: true } 
                })
              });
              
              if (response.ok) {
                const result = await response.json();
                alert('✅ AI Connectie ACTIEF!\n\nOpenAI Response ontvangen:\n' + (result.data?.fullAnalysis || result.data?.analysis || 'Connectie werkt!'));
                return true;
              } else {
                alert('❌ AI Connectie FAILED!\n\nStatus: ' + response.status + '\nFallback naar demo data actief.');
                return false;
              }
            } catch (error) {
              alert('❌ AI Connectie ERROR!\n\nFout: ' + error.message + '\nFallback naar demo data actief.');
              return false;
            } finally {
              setIsLoadingAI(false);
            }
          };

          const getInvestorInsights = async (investorId) => {
            const investor = investors.find(i => i.id === investorId);
            if (!investor) return;
            
            setIsLoadingAI(true);
            
            const detailedPrompt = `
DIEPGAANDE INVESTEERDER ANALYSE voor ${investor.naam}:

BASISGEGEVENS:
- Naam: ${investor.naam}
- Bedrijf: ${investor.bedrijf}
- Budget: €${investor.minBudget.toLocaleString()} - €${investor.maxBudget.toLocaleString()}
- Gewenst rendement: ${investor.gewenstRendement}%
- Risicoprofiel: ${investor.risicoprofiel}
- Ervaring: ${investor.ervaringLevel}
- Voorkeursregio's: ${investor.voorkeursRegio?.join(', ')}
- Voorkeurslanden: ${investor.voorkeursLanden?.join(', ')}
- Locatie details: ${investor.locatieDetails || 'Niet opgegeven'}
- Vastgoedtypes: ${investor.vastgoedTypes?.join(', ')}
- Project types: ${investor.projectTypes?.join(', ')}
- Communicatie voorkeur: ${investor.communicatieVoorkeur}
- Beschikbaarheid: ${investor.beschikbaarheid}

MOTIVATIE & BIJZONDERHEDEN:
- Investment motivatie: ${investor.investmentMotivatie || 'Niet opgegeven'}
- Bijzonderheden: ${investor.bijzonderheden || 'Niet opgegeven'}

ANALYSEER DIEPGAAND:
1. Financiële sterkte en capaciteit
2. Psychologisch profiel en gedrag op basis van motivatie
3. Optimale deal karakteristieken
4. Risico tolerantie analyse
5. Onderhandelingsstrategie
6. Timing en marktsentiment
7. Concrete actie aanbevelingen

Geef een professionele, gedetailleerde analyse in Nederlandse taal.
            `;
            
            const insights = await callOpenAI(detailedPrompt, 'investor_analysis', investor);
            setAiInsights(prev => ({
              ...prev,
              [`investor_${investorId}`]: insights
            }));
          };

          const getDealInsights = async (dealId) => {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return;
            
            setIsLoadingAI(true);
            
            const detailedPrompt = `
DIEPGAANDE VASTGOED DEAL ANALYSE voor ${deal.titel}:

DEAL GEGEVENS:
- Titel: ${deal.titel}
- Bedrijf/Fonds: ${deal.bedrijfFonds || 'Niet opgegeven'}
- Locatie: ${deal.locatie}
- Type: ${deal.type}
- Project type: ${deal.projectType}
- Prijs: €${deal.prijs.toLocaleString()}
- Verwacht rendement: ${deal.verwachtRendement}%
- Risico: ${deal.risico}
- Oppervlakte: ${deal.oppervlakte}m²
- Bouwjaar: ${deal.bouwjaar}
- Huurpotentie: €${deal.huurpotentie}

BESCHRIJVING & DETAILS:
- Beschrijving: ${deal.beschrijving}
- Bijzonderheden: ${deal.bijzonderheden || 'Niet opgegeven'}
- Contactpersoon: ${deal.contactpersoon || 'Niet opgegeven'}

ANALYSEER DIEPGAAND:
1. Marktpositie en concurrentie analyse
2. Financiële projectie en cashflow
3. Risicofactoren en mitigation
4. Groei- en waardecreatiekansen
5. Locatie trends en demografische analyse
6. Vergelijking met vergelijkbare objecten
7. Aanbevelingen voor potentiële kopers
8. Optimale verkoop- en marketingstrategie

Geef een professionele, gedetailleerde analyse in Nederlandse taal met concrete cijfers en aanbevelingen.
            `;
            
            const insights = await callOpenAI(detailedPrompt, 'deal_analysis', deal);
            setAiInsights(prev => ({
              ...prev,
              [`deal_${dealId}`]: insights
            }));
          };

          // 🔥 ENHANCED MATCHING WITH SEMANTIC ANALYSIS
          const getSmartMatchingInsights = async (dealId, investorId) => {
            const deal = deals.find(d => d.id === dealId);
            const investor = investors.find(i => i.id === investorId);
            if (!deal || !investor) return;
            
            setIsLoadingAI(true);
            
            const detailedPrompt = `
🤖 GEAVANCEERDE AI SEMANTIC MATCHING ANALYSE:

DEAL: ${deal.titel}
- Bedrijf/Fonds: ${deal.bedrijfFonds || 'Niet opgegeven'}
- Locatie: ${deal.locatie}
- Type: ${deal.type} (${deal.projectType})
- Prijs: €${deal.prijs.toLocaleString()}
- Rendement: ${deal.verwachtRendement}%
- Risico: ${deal.risico}
- Deal beschrijving: "${deal.beschrijving}"
- Deal bijzonderheden: "${deal.bijzonderheden || 'Geen'}"

INVESTEERDER: ${investor.naam}
- Bedrijf: ${investor.bedrijf || 'Niet opgegeven'}
- Budget: €${investor.minBudget.toLocaleString()} - €${investor.maxBudget.toLocaleString()}
- Gewenst rendement: ${investor.gewenstRendement}%
- Risicoprofiel: ${investor.risicoprofiel}
- Ervaring: ${investor.ervaringLevel}
- Voorkeuren: ${investor.vastgoedTypes?.join(', ')}
- Locatie details: "${investor.locatieDetails || 'Geen specifieke eisen'}"
- Investment motivatie: "${investor.investmentMotivatie || 'Niet opgegeven'}"
- Bijzonderheden: "${investor.bijzonderheden || 'Geen'}"

🎯 VOER SEMANTIC MATCHING UIT:

1. SEMANTIC ANALYSE van deal beschrijving vs investeerder motivatie
   - Zoek naar overlappende concepten, synoniemen, gerelateerde termen
   - Bijvoorbeeld: "stabiele huurinkomsten" ↔ "gegarandeerde huurder"
   - Bijvoorbeeld: "geen renovatie" ↔ "turn-key" 
   - Bijvoorbeeld: "duurzaamheid" ↔ "energielabel A"

2. CONFLICT DETECTIE
   - Zoek naar tegenstrijdigheden tussen wensen en aanbod
   - Bijvoorbeeld: "geen renovatie" vs "renovatie project"

3. COMPATIBILITY SCORE (0-100)
   - Combineer traditionele factoren + semantic matching
   - Geef uitleg per component

4. GEPERSONALISEERDE PITCH STRATEGIE
   - Welke aspecten van de deal benadrukken?
   - Hoe deal presenteren aan deze specifieke investeerder?
   - Welke voordelen matchen met hun motivatie?

5. SUCCESS PROBABILITY & TIMING
   - Kans op succesvolle deal
   - Optimaal moment voor approach

Geef concrete, actionable aanbevelingen voor deze specifieke match.
            `;
            
            const insights = await callOpenAI(detailedPrompt, 'enhanced_matching', { deal, investor });
            setAiInsights(prev => ({
              ...prev,
              [`enhanced_match_${dealId}_${investorId}`]: insights
            }));
          };

          // FIREBASE AUTHENTICATION FUNCTIES (unchanged)
          const handleLogin = async (credentials) => {
            try {
              console.log('🔐 Firebase login poging voor:', credentials.email);
              
              const userCredential = await auth.signInWithEmailAndPassword(
                credentials.email, 
                credentials.password
              );
              
              const firebaseUser = userCredential.user;
              const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
              
              if (userDoc.exists) {
                const userData = { id: firebaseUser.uid, ...userDoc.data() };
                setUser(userData);
                setShowAuth(false);
                console.log('✅ Login succesvol voor:', userData.name);
                await loadData();
              } else {
                throw new Error('User profile not found');
              }
              
            } catch (error) {
              console.error('❌ Login error:', error);
              let errorMessage = 'Er ging iets mis bij het inloggen.';
              
              switch (error.code) {
                case 'auth/user-not-found':
                  errorMessage = 'Geen account gevonden met dit email adres.';
                  break;
                case 'auth/wrong-password':
                  errorMessage = 'Onjuist wachtwoord.';
                  break;
                case 'auth/invalid-email':
                  errorMessage = 'Ongeldig email adres.';
                  break;
                case 'auth/too-many-requests':
                  errorMessage = 'Te veel login pogingen. Probeer later opnieuw.';
                  break;
              }
              
              alert(errorMessage);
            }
          };

          const handleRegister = async (userData) => {
            try {
              console.log('📝 Firebase registratie voor:', userData.email);
              
              const userCredential = await auth.createUserWithEmailAndPassword(
                userData.email,
                userData.password
              );
              
              const firebaseUser = userCredential.user;
              
              const userProfile = {
                name: userData.name,
                email: userData.email,
                company: userData.company,
                role: 'agent',
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('users').doc(firebaseUser.uid).set(userProfile);
              
              const newUser = { id: firebaseUser.uid, ...userProfile };
              setUser(newUser);
              setShowAuth(false);
              await loadData();
              
              console.log('✅ Nieuw account aangemaakt voor:', userData.email);
            } catch (error) {
              console.error('❌ Register error:', error);
              let errorMessage = 'Er ging iets mis bij het registreren.';
              
              switch (error.code) {
                case 'auth/email-already-in-use':
                  errorMessage = 'Dit email adres is al in gebruik.';
                  break;
                case 'auth/weak-password':
                  errorMessage = 'Wachtwoord is te zwak. Gebruik minimaal 6 karakters.';
                  break;
                case 'auth/invalid-email':
                  errorMessage = 'Ongeldig email adres.';
                  break;
              }
              
              alert(errorMessage);
            }
          };

          const handleLogout = async () => {
            try {
              await auth.signOut();
              setUser(null);
              setShowAuth(true);
              setInvestors([]);
              setBrokers([]); // 🔥 NEW
              setDeals([]);
              setTransactions([]);
              setUsers([]);
              setAiInsights({});
              setActiveTab('dashboard');
              console.log('✅ Uitgelogd van Firebase');
            } catch (error) {
              console.error('❌ Logout error:', error);
            }
          };

          useEffect(() => {
            const unsubscribe = auth.onAuthStateChanged(async (firebaseUser) => {
              if (firebaseUser && !user) {
                try {
                  const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                  if (userDoc.exists) {
                    const userData = { id: firebaseUser.uid, ...userDoc.data() };
                    setUser(userData);
                    setShowAuth(false);
                    await loadData();
                  }
                } catch (error) {
                  console.error('Error loading user profile:', error);
                }
              } else if (!firebaseUser && user) {
                setUser(null);
                setShowAuth(true);
              }
            });

            return () => unsubscribe();
          }, [user]);

          useEffect(() => {
            if (user) {
              loadData();
            }
          }, [user]);

          // 🔥 ENHANCED MATCHING ALGORITHM WITH SEMANTIC ANALYSIS
          const calculateMatchScore = (investor, deal) => {
            let score = 0;
            let maxScore = 0;
            let reasoningFactors = [];

            // Budget matching (20% - reduced to make room for semantic)
            maxScore += 20;
            if (deal.prijs >= investor.minBudget && deal.prijs <= investor.maxBudget) {
              score += 20;
              reasoningFactors.push(`✓ Budget perfect match (€${deal.prijs.toLocaleString()} binnen €${investor.minBudget.toLocaleString()}-€${investor.maxBudget.toLocaleString()} range)`);
            } else if (deal.prijs < investor.minBudget) {
              const budgetScore = Math.max(0, 20 - ((investor.minBudget - deal.prijs) / investor.minBudget * 20));
              score += budgetScore;
              reasoningFactors.push(`⚠ Deal prijs onder minimum budget (${budgetScore.toFixed(1)}/20 punten)`);
            } else {
              reasoningFactors.push(`✗ Deal prijs boven maximum budget`);
            }

            // 🔥 SIMPLIFIED LOCATION MATCHING (15% - reduced)
            maxScore += 15;
            let locationScore = 0;
            
            // Check country match
            if ((investor.voorkeursLanden || []).some(land => 
              deal.locatie.toLowerCase().includes(land.toLowerCase())
            )) {
              locationScore = 15;
              reasoningFactors.push(`✓ Land match gevonden in locatie`);
            }
            // Check region match 
            else if ((investor.voorkeursRegio || []).length > 0) {
              locationScore = 8;
              reasoningFactors.push(`~ Regio voorkeur aanwezig`);
            }
            // Default geographic scope
            else {
              locationScore = 5;
              reasoningFactors.push(`~ Geen specifieke locatie eisen`);
            }
            
            score += locationScore;

            // Type vastgoed matching (15%)
            maxScore += 15;
            if ((investor.vastgoedTypes || []).includes(deal.type)) {
              score += 15;
              reasoningFactors.push(`✓ Vastgoed type match (${deal.type})`);
            } else if ((investor.vastgoedTypes || []).length === 0) {
              score += 7;
              reasoningFactors.push(`~ Geen specifieke vastgoed type voorkeur`);
            } else {
              reasoningFactors.push(`✗ Vastgoed type niet in voorkeuren`);
            }

            // Project type matching (10%)
            maxScore += 10;
            if ((investor.projectTypes || []).includes(deal.projectType)) {
              score += 10;
              reasoningFactors.push(`✓ Project type match (${deal.projectType})`);
            } else if ((investor.projectTypes || []).length === 0) {
              score += 5;
              reasoningFactors.push(`~ Geen specifieke project type voorkeur`);
            } else {
              reasoningFactors.push(`✗ Project type niet in voorkeuren`);
            }

            // Rendement matching (15%)
            maxScore += 15;
            if (deal.verwachtRendement >= investor.gewenstRendement) {
              score += 15;
              reasoningFactors.push(`✓ Rendement boven verwachting (${deal.verwachtRendement}% vs ${investor.gewenstRendement}%)`);
            } else {
              const rendementScore = Math.max(0, 15 - ((investor.gewenstRendement - deal.verwachtRendement) / investor.gewenstRendement * 15));
              score += rendementScore;
              reasoningFactors.push(`⚠ Rendement onder verwachting (${rendementScore.toFixed(1)}/15 punten)`);
            }

            // Risico matching (10%)
            maxScore += 10;
            const risicoMatch = {
              'Conservatief': { 'Laag': 10, 'Gemiddeld': 6, 'Hoog': 2 },
              'Gemiddeld': { 'Laag': 8, 'Gemiddeld': 10, 'Hoog': 7 },
              'Agressief': { 'Laag': 5, 'Gemiddeld': 8, 'Hoog': 10 }
            };
            const risicoScore = risicoMatch[investor.risicoprofiel]?.[deal.risico] || 0;
            score += risicoScore;
            reasoningFactors.push(`${risicoScore >= 8 ? '✓' : '⚠'} Risico match (${investor.risicoprofiel} profiel, ${deal.risico} risico)`);

            // 🔥 NEW: SEMANTIC MATCHING (15% - new powerful feature)
            maxScore += 15;
            let semanticScore = 0;
            let semanticReasons = [];
            
            const investorText = [
              investor.investmentMotivatie || '',
              investor.bijzonderheden || '',
              investor.locatieDetails || ''
            ].join(' ').toLowerCase();
            
            const dealText = [
              deal.beschrijving || '',
              deal.bijzonderheden || ''
            ].join(' ').toLowerCase();

            // Semantic keyword matching
            const semanticMatches = [
              { investor: ['stabiel', 'huurinkomst', 'gegarandeerd'], deal: ['gegarandeerd', 'huurder', 'corporatie'], points: 5, desc: 'Stabiele huurinkomsten match' },
              { investor: ['turn-key', 'geen renovatie', 'kant-en-klaar'], deal: ['turn-key', 'kant-en-klaar', 'direct'], points: 4, desc: 'Turn-key voorkeur match' },
              { investor: ['duurzaam', 'energie', 'milieu'], deal: ['energielabel', 'duurzaam', 'zonnepanel', 'warmtepomp'], points: 3, desc: 'Duurzaamheid match' },
              { investor: ['student', 'universiteit'], deal: ['student', 'universiteit', 'campus'], points: 3, desc: 'Studenten segment match' },
              { investor: ['centrum', 'bereikbaar', 'transport'], deal: ['centrum', 'metro', 'transport', 'bereikbaar'], points: 2, desc: 'Locatie bereikbaarheid match' }
            ];

            semanticMatches.forEach(match => {
              const investorHasKeywords = match.investor.some(keyword => investorText.includes(keyword));
              const dealHasKeywords = match.deal.some(keyword => dealText.includes(keyword));
              
              if (investorHasKeywords && dealHasKeywords) {
                semanticScore += match.points;
                semanticReasons.push(`✓ ${match.desc}`);
              }
            });

            // Conflict detection
            const conflicts = [
              { investor: ['geen renovatie', 'turn-key'], deal: ['renovatie', 'opknappen'], desc: 'Renovatie conflict' },
              { investor: ['centrum'], deal: ['buitenwijk', 'periferie'], desc: 'Locatie voorkeur conflict' }
            ];

            conflicts.forEach(conflict => {
              const investorWants = conflict.investor.some(keyword => investorText.includes(keyword));
              const dealOffers = conflict.deal.some(keyword => dealText.includes(keyword));
              
              if (investorWants && dealOffers) {
                semanticScore -= 3;
                semanticReasons.push(`⚠ ${conflict.desc} gedetecteerd`);
              }
            });

            score += Math.max(0, Math.min(15, semanticScore));
            reasoningFactors.push(...semanticReasons);

            const finalScore = Math.round((score / maxScore) * 100);
            
            return {
              score: finalScore,
              reasoning: reasoningFactors,
              maxScore,
              actualScore: score,
              semanticScore: semanticScore,
              semanticReasons: semanticReasons
            };
          };

          const findMatches = (dealId) => {
            const deal = deals.find(d => d.id === dealId);
            if (!deal) return [];

            return investors.map(investor => {
              const matchResult = calculateMatchScore(investor, deal);
              return {
                investor,
                deal,
                matchScore: matchResult.score,
                reasoning: matchResult.reasoning,
                semanticScore: matchResult.semanticScore,
                semanticReasons: matchResult.semanticReasons,
                aiInsights: null
              };
            }).sort((a, b) => b.matchScore - a.matchScore);
          };

          // Commission Management Functions (unchanged)
          const openCommissionEditor = (deal) => {
            setEditingDealCommission(deal);
            setShowCommissionEditor(true);
          };

          const saveCommissionStructure = async (dealId, commissionStructure) => {
            try {
              console.log('💾 Saving commission structure for deal:', dealId);
              
              await db.collection('deals').doc(dealId).update({
                commissionStructure: commissionStructure,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              setDeals(prev => prev.map(deal => 
                deal.id === dealId ? { ...deal, commissionStructure } : deal
              ));
              
              console.log('✅ Commission structure saved');
              alert('✅ Commissie structuur succesvol opgeslagen!');
            } catch (error) {
              console.error('❌ Error saving commission structure:', error);
              alert('Fout bij opslaan commissie structuur: ' + error.message);
            }
          };

          const createTransaction = async (dealId, investorId) => {
            const deal = deals.find(d => d.id === dealId);
            const investor = investors.find(i => i.id === investorId);
            
            if (!deal || !investor) return;

            const commissionStructure = deal.commissionStructure || {
              total_rate: 0.025,
              participants: [
                { 
                  role: 'deal_owner', 
                  user_id: deal.owner_id, 
                  percentage: 60, 
                  fixed_amount: 0, 
                  type: 'percentage',
                  name: getUserById(deal.owner_id).name,
                  is_external: false
                },
                { 
                  role: 'investor_referral', 
                  user_id: investor.owner_id, 
                  percentage: 40, 
                  fixed_amount: 0, 
                  type: 'percentage',
                  name: getUserById(investor.owner_id).name,
                  is_external: false
                }
              ]
            };

            const totalCommission = deal.prijs * commissionStructure.total_rate;
            
            const participantCommissions = commissionStructure.participants.map(participant => {
              let commission = 0;
              if (participant.type === 'percentage') {
                commission = totalCommission * (participant.percentage / 100);
              } else if (participant.type === 'fixed') {
                commission = participant.fixed_amount;
              }
              return {
                ...participant,
                commission_amount: commission
              };
            });

            const transactionData = {
              id: Date.now().toString(),
              deal_id: dealId,
              investor_id: investorId,
              deal_owner_id: deal.owner_id,
              investor_owner_id: investor.owner_id,
              transaction_amount: deal.prijs,
              commission_rate: commissionStructure.total_rate,
              total_commission: totalCommission,
              commission_structure: JSON.stringify(commissionStructure),
              participant_commissions: JSON.stringify(participantCommissions),
              status: 'pending',
              closed_date: null,
              created_at: new Date().toISOString()
            };

            try {
              await db.collection('transactions').add(transactionData);
              setTransactions(prev => [...prev, transactionData]);
              
              console.log('✅ Transaction created:', transactionData);
              alert('✅ Transactie succesvol aangemaakt! Ga naar "Transacties" tab om de details te bekijken.');
              setActiveTab('transactions');
            } catch (error) {
              console.error('❌ Error creating transaction:', error);
              alert('Fout bij aanmaken transactie: ' + error.message);
            }
          };

          // Edit Functions (unchanged)
          const handleEditInvestor = (investor) => {
            setEditingInvestor(investor);
            setShowEditInvestor(true);
          };

          const handleEditDeal = (deal) => {
            setEditingDeal(deal);
            setShowEditDeal(true);
          };

          // 🔥 NEW: Broker CRUD Functions
          const handleEditBroker = (broker) => {
            setEditingBroker(broker);
            setShowEditBroker(true);
          };

          const handleAddBroker = async (brokerData) => {
            try {
              console.log('💾 Adding broker to Firebase...');
              
              const newBroker = {
                ...brokerData,
                ervaringJaren: parseInt(brokerData.ervaringJaren) || 0,
                owner_id: user.id,
                import_source: 'manual',
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('brokers').add(newBroker);
              
              const brokerWithId = {
                id: docRef.id,
                ...newBroker,
                created_at: new Date().toISOString()
              };
              
              setBrokers(prev => [...prev, brokerWithId]);
              setShowAddBroker(false);
              
              console.log('✅ Broker added to Firebase:', docRef.id);
              alert('✅ Broker succesvol toegevoegd!');
            } catch (error) {
              console.error('❌ Error adding broker:', error);
              alert('Fout bij toevoegen broker: ' + error.message);
            }
          };

          const handleUpdateBroker = async (brokerData) => {
            try {
              console.log('💾 Updating broker in Firebase...', editingBroker.id);
              
              const updatedBroker = {
                ...brokerData,
                ervaringJaren: parseInt(brokerData.ervaringJaren) || 0,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('brokers').doc(editingBroker.id).update(updatedBroker);
              
              setBrokers(prev => prev.map(broker => 
                broker.id === editingBroker.id ? { ...broker, ...updatedBroker } : broker
              ));
              
              setShowEditBroker(false);
              setEditingBroker(null);
              
              console.log('✅ Broker updated in Firebase:', editingBroker.id);
              alert('✅ Broker succesvol bijgewerkt!');
            } catch (error) {
              console.error('❌ Error updating broker:', error);
              alert('Fout bij bijwerken broker: ' + error.message);
            }
          };

          const handleDeleteBroker = async (brokerId) => {
            if (confirm('Weet je zeker dat je deze broker wilt verwijderen?')) {
              try {
                console.log('🗑️ Deleting broker from Firebase...');
                
                await db.collection('brokers').doc(brokerId).delete();
                setBrokers(prev => prev.filter(b => b.id !== brokerId));
                
                console.log('✅ Broker deleted from Firebase:', brokerId);
                alert('✅ Broker succesvol verwijderd!');
              } catch (error) {
                console.error('❌ Error deleting broker:', error);
                alert('Fout bij verwijderen broker: ' + error.message);
              }
            }
          };

          const handleUpdateInvestor = async (investorData) => {
            try {
              console.log('💾 Updating investor in Firebase...', editingInvestor.id);
              
              const updatedInvestor = {
                ...investorData,
                minBudget: parseInt(investorData.minBudget) || 0,
                maxBudget: parseInt(investorData.maxBudget) || 0,
                gewenstRendement: parseFloat(investorData.gewenstRendement) || 0,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('investors').doc(editingInvestor.id).update(updatedInvestor);
              
              setInvestors(prev => prev.map(inv => 
                inv.id === editingInvestor.id ? { ...inv, ...updatedInvestor } : inv
              ));
              
              setShowEditInvestor(false);
              setEditingInvestor(null);
              
              console.log('✅ Investor updated in Firebase:', editingInvestor.id);
              alert('✅ Investeerder succesvol bijgewerkt!');
            } catch (error) {
              console.error('❌ Error updating investor:', error);
              alert('Fout bij bijwerken investeerder: ' + error.message);
            }
          };

          const handleUpdateDeal = async (dealData) => {
            try {
              console.log('💾 Updating deal in Firebase...', editingDeal.id);
              
              const updatedDeal = {
                ...dealData,
                prijs: parseInt(dealData.prijs) || 0,
                verwachtRendement: parseFloat(dealData.verwachtRendement) || 0,
                oppervlakte: parseInt(dealData.oppervlakte) || 0,
                bouwjaar: parseInt(dealData.bouwjaar) || 0,
                huurpotentie: parseInt(dealData.huurpotentie) || 0,
                commissionStructure: editingDeal.commissionStructure,
                updated_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('deals').doc(editingDeal.id).update(updatedDeal);
              
              setDeals(prev => prev.map(deal => 
                deal.id === editingDeal.id ? { ...deal, ...updatedDeal } : deal
              ));
              
              setShowEditDeal(false);
              setEditingDeal(null);
              
              console.log('✅ Deal updated in Firebase:', editingDeal.id);
              alert('✅ Deal succesvol bijgewerkt!');
            } catch (error) {
              console.error('❌ Error updating deal:', error);
              alert('Fout bij bijwerken deal: ' + error.message);
            }
          };

          const handleAddInvestor = async (investorData) => {
            try {
              console.log('💾 Adding investor to Firebase...');
              
              const newInvestor = {
                ...investorData,
                minBudget: parseInt(investorData.minBudget) || 0,
                maxBudget: parseInt(investorData.maxBudget) || 0,
                gewenstRendement: parseFloat(investorData.gewenstRendement) || 0,
                owner_id: user.id,
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('investors').add(newInvestor);
              
              const investorWithId = {
                id: docRef.id,
                ...newInvestor,
                created_at: new Date().toISOString()
              };
              
              setInvestors(prev => [...prev, investorWithId]);
              setShowAddInvestor(false);
              
              console.log('✅ Investor added to Firebase:', docRef.id);
            } catch (error) {
              console.error('❌ Error adding investor:', error);
              alert('Fout bij toevoegen investeerder: ' + error.message);
            }
          };

          const handleAddDeal = async (dealData) => {
            try {
              console.log('💾 Adding deal to Firebase...');
              
              const newDeal = {
                ...dealData,
                prijs: parseInt(dealData.prijs) || 0,
                verwachtRendement: parseFloat(dealData.verwachtRendement) || 0,
                oppervlakte: parseInt(dealData.oppervlakte) || 0,
                bouwjaar: parseInt(dealData.bouwjaar) || 0,
                huurpotentie: parseInt(dealData.huurpotentie) || 0,
                owner_id: user.id,
                commissionStructure: {
                  total_rate: 0.025,
                  participants: [
                    { 
                      role: 'deal_owner', 
                      user_id: user.id, 
                      percentage: 100, 
                      fixed_amount: 0, 
                      type: 'percentage',
                      name: user.name,
                      is_external: false
                    }
                  ]
                },
                created_at: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const docRef = await db.collection('deals').add(newDeal);
              
              const dealWithId = {
                id: docRef.id,
                ...newDeal,
                created_at: new Date().toISOString()
              };
              
              setDeals(prev => [...prev, dealWithId]);
              setShowAddDeal(false);
              
              console.log('✅ Deal added to Firebase:', docRef.id);
            } catch (error) {
              console.error('❌ Error adding deal:', error);
              alert('Fout bij toevoegen deal: ' + error.message);
            }
          };

          const handleDeleteInvestor = async (investorId) => {
            if (confirm('Weet je zeker dat je deze investeerder wilt verwijderen?')) {
              try {
                console.log('🗑️ Deleting investor from Firebase...');
                
                await db.collection('investors').doc(investorId).delete();
                setInvestors(prev => prev.filter(i => i.id !== investorId));
                
                console.log('✅ Investor deleted from Firebase:', investorId);
              } catch (error) {
                console.error('❌ Error deleting investor:', error);
                alert('Fout bij verwijderen investeerder: ' + error.message);
              }
            }
          };

          const handleDeleteDeal = async (dealId) => {
            if (confirm('Weet je zeker dat je deze deal wilt verwijderen?\n\nLet op: Gerelateerde transacties worden ook verwijderd.')) {
              try {
                console.log('🗑️ Deleting deal from Firebase...');
                
                const relatedTransactions = transactions.filter(t => t.deal_id === dealId);
                for (const transaction of relatedTransactions) {
                  await db.collection('transactions').doc(transaction.id).delete();
                }
                
                await db.collection('deals').doc(dealId).delete();
                
                setDeals(prev => prev.filter(d => d.id !== dealId));
                setTransactions(prev => prev.filter(t => t.deal_id !== dealId));
                
                console.log('✅ Deal deleted from Firebase:', dealId);
                alert('✅ Deal succesvol verwijderd!');
              } catch (error) {
                console.error('❌ Error deleting deal:', error);
                alert('Fout bij verwijderen deal: ' + error.message);
              }
            }
          };

          const getMatchColor = (score) => {
            if (score >= 80) return 'text-green-600 bg-green-100';
            if (score >= 60) return 'text-yellow-600 bg-yellow-100';
            return 'text-red-600 bg-red-100';
          };

          const calculateCommissionSummary = () => {
            const userTransactions = transactions.filter(t => {
              if (t.participant_commissions) {
                const participants = JSON.parse(t.participant_commissions);
                return participants.some(p => p.user_id === user.id);
              }
              return t.deal_owner_id === user.id || t.investor_owner_id === user.id;
            });
            
            const totalCommission = userTransactions.reduce((sum, t) => {
              if (t.participant_commissions) {
                const participants = JSON.parse(t.participant_commissions);
                const userParticipant = participants.find(p => p.user_id === user.id);
                return sum + (userParticipant ? userParticipant.commission_amount : 0);
              }
              const userCommission = t.deal_owner_id === user.id ? (t.deal_owner_commission || 0) : (t.investor_owner_commission || 0);
              return sum + userCommission;
            }, 0);

            const completedTransactions = userTransactions.filter(t => t.status === 'completed');
            const pendingTransactions = userTransactions.filter(t => t.status === 'pending');

            return {
              totalCommission,
              completedTransactions: completedTransactions.length,
              pendingTransactions: pendingTransactions.length,
              totalVolume: userTransactions.reduce((sum, t) => sum + t.transaction_amount, 0)
            };
          };

          // Commission Editor Component (unchanged)
          const CommissionEditor = () => {
            if (!showCommissionEditor || !editingDealCommission) return null;

            const [commissionStructure, setCommissionStructure] = useState(
              editingDealCommission.commissionStructure || {
                total_rate: 0.025,
                participants: [
                  { 
                    role: 'deal_owner', 
                    user_id: editingDealCommission.owner_id, 
                    percentage: 100, 
                    fixed_amount: 0, 
                    type: 'percentage',
                    name: getUserById(editingDealCommission.owner_id).name,
                    is_external: false
                  }
                ]
              }
            );

            const totalCommission = editingDealCommission.prijs * commissionStructure.total_rate;

            const updateParticipant = (index, field, value) => {
              const newParticipants = [...commissionStructure.participants];
              newParticipants[index] = { ...newParticipants[index], [field]: value };
              
              if (field === 'user_id' && !newParticipants[index].is_external) {
                const user = getUserById(value);
                newParticipants[index].name = user.name;
              }
              
              setCommissionStructure({ ...commissionStructure, participants: newParticipants });
            };

            const addParticipant = (isExternal = false) => {
              setCommissionStructure({
                ...commissionStructure,
                participants: [
                  ...commissionStructure.participants,
                  { 
                    role: 'referral', 
                    user_id: null, 
                    percentage: 0, 
                    fixed_amount: 0, 
                    type: 'percentage',
                    name: '',
                    email: '',
                    company: '',
                    is_external: isExternal
                  }
                ]
              });
            };

            const removeParticipant = (index) => {
              if (commissionStructure.participants.length > 1) {
                const newParticipants = commissionStructure.participants.filter((_, i) => i !== index);
                setCommissionStructure({ ...commissionStructure, participants: newParticipants });
              }
            };

            const handleSave = async () => {
              const totalPercentage = commissionStructure.participants
                .filter(p => p.type === 'percentage')
                .reduce((sum, p) => sum + (p.percentage || 0), 0);
              
              if (totalPercentage > 100) {
                alert('Totaal percentage kan niet meer dan 100% zijn!');
                return;
              }

              await saveCommissionStructure(editingDealCommission.id, commissionStructure);
              setShowCommissionEditor(false);
              setEditingDealCommission(null);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-5xl max-h-[90vh] overflow-y-auto">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold flex items-center space-x-2">
                      <PercentIcon size={20} />
                      <span>Commissie Structuur Beheren</span>
                    </h3>
                    <p className="text-sm text-gray-600 mt-1">
                      Deal: {editingDealCommission.titel} - €{editingDealCommission.prijs.toLocaleString()}
                    </p>
                  </div>
                  
                  <div className="p-6">
                    <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <label className="block text-sm font-medium mb-2">Totale Commissie Rate (%)</label>
                      <div className="flex items-center space-x-4">
                        <input
                          type="number"
                          step="0.001"
                          value={commissionStructure.total_rate * 100}
                          onChange={(e) => setCommissionStructure({
                            ...commissionStructure,
                            total_rate: parseFloat(e.target.value) / 100
                          })}
                          className="w-32 p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <span className="text-lg font-semibold text-blue-600">
                          = €{totalCommission.toLocaleString()}
                        </span>
                        <span className="text-sm text-gray-600">
                          van €{editingDealCommission.prijs.toLocaleString()}
                        </span>
                      </div>
                    </div>

                    <div className="space-y-4 mb-6">
                      <div className="flex items-center justify-between">
                        <h4 className="font-semibold">Commissie Verdeling:</h4>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => addParticipant(false)}
                            className="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 flex items-center space-x-1"
                          >
                            <PlusIcon size={14} />
                            <span>Teamlid</span>
                          </button>
                          <button
                            onClick={() => addParticipant(true)}
                            className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 flex items-center space-x-1"
                          >
                            <ExternalLinkIcon size={14} />
                            <span>Extern</span>
                          </button>
                        </div>
                      </div>

                      {commissionStructure.participants.map((participant, index) => (
                        <div key={index} className="border rounded p-4 bg-gray-50">
                          <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div>
                              <label className="block text-sm font-medium mb-1">Rol</label>
                              <select
                                value={participant.role}
                                onChange={(e) => updateParticipant(index, 'role', e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                              >
                                <option value="deal_owner">Deal Eigenaar</option>
                                <option value="investor_referral">Investeerder Referral</option>
                                <option value="referral">Verwijzer</option>
                                <option value="manager">Manager</option>
                                <option value="assistant">Assistent</option>
                                <option value="broker">Makelaar</option>
                                <option value="consultant">Consultant</option>
                              </select>
                            </div>

                            <div>
                              <label className="block text-sm font-medium mb-1">
                                {participant.is_external ? 'Naam' : 'Teamlid'}
                              </label>
                              {participant.is_external ? (
                                <input
                                  type="text"
                                  value={participant.name}
                                  onChange={(e) => updateParticipant(index, 'name', e.target.value)}
                                  className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                  placeholder="Volledige naam"
                                />
                              ) : (
                                <select
                                  value={participant.user_id || ''}
                                  onChange={(e) => updateParticipant(index, 'user_id', e.target.value)}
                                  className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                >
                                  <option value="">Selecteer...</option>
                                  {users.map(user => (
                                    <option key={user.id} value={user.id}>{user.name}</option>
                                  ))}
                                </select>
                              )}
                            </div>

                            {participant.is_external && (
                              <>
                                <div>
                                  <label className="block text-sm font-medium mb-1">Email</label>
                                  <input
                                    type="email"
                                    value={participant.email || ''}
                                    onChange={(e) => updateParticipant(index, 'email', e.target.value)}
                                    className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    placeholder="email@example.com"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium mb-1">Bedrijf</label>
                                  <input
                                    type="text"
                                    value={participant.company || ''}
                                    onChange={(e) => updateParticipant(index, 'company', e.target.value)}
                                    className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    placeholder="Bedrijfsnaam"
                                  />
                                </div>
                              </>
                            )}

                            <div className={participant.is_external ? '' : 'md:col-start-4'}>
                              <label className="block text-sm font-medium mb-1">Type</label>
                              <select
                                value={participant.type}
                                onChange={(e) => updateParticipant(index, 'type', e.target.value)}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                              >
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Vast Bedrag</option>
                              </select>
                            </div>

                            <div>
                              <label className="block text-sm font-medium mb-1">
                                {participant.type === 'percentage' ? 'Percentage (%)' : 'Bedrag (€)'}
                              </label>
                              <input
                                type="number"
                                step={participant.type === 'percentage' ? '0.1' : '1'}
                                value={participant.type === 'percentage' ? participant.percentage : participant.fixed_amount}
                                onChange={(e) => updateParticipant(
                                  index, 
                                  participant.type === 'percentage' ? 'percentage' : 'fixed_amount', 
                                  parseFloat(e.target.value)
                                )}
                                className="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                              />
                            </div>

                            <div className="flex items-end">
                              {commissionStructure.participants.length > 1 && (
                                <button
                                  onClick={() => removeParticipant(index)}
                                  className="text-red-600 hover:text-red-800 text-sm p-2"
                                >
                                  <TrashIcon size={16} />
                                </button>
                              )}
                            </div>
                          </div>

                          <div className="mt-2 text-sm text-gray-600">
                            Commissie: €{participant.type === 'percentage' 
                              ? (totalCommission * (participant.percentage / 100)).toLocaleString()
                              : (participant.fixed_amount || 0).toLocaleString()
                            }
                            {participant.is_external && (
                              <span className="ml-2 px-2 py-1 bg-green-100 text-green-800 rounded text-xs">
                                Extern
                              </span>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="bg-blue-50 p-4 rounded mb-6 border border-blue-200">
                      <h5 className="font-semibold mb-2">Commissie Overzicht:</h5>
                      <div className="space-y-1 text-sm">
                        {commissionStructure.participants.map((participant, index) => {
                          const commission = participant.type === 'percentage' 
                            ? totalCommission * (participant.percentage / 100)
                            : participant.fixed_amount;
                          
                          const displayName = participant.is_external 
                            ? participant.name 
                            : getUserById(participant.user_id).name;
                          
                          return (
                            <div key={index} className="flex justify-between">
                              <span>
                                {displayName} ({participant.role})
                                {participant.is_external && <span className="text-green-600 ml-1">📧</span>}
                              </span>
                              <span>€{commission.toLocaleString()}</span>
                            </div>
                          );
                        })}
                        <div className="border-t pt-1 font-semibold flex justify-between">
                          <span>Totaal:</span>
                          <span>€{totalCommission.toLocaleString()}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div className="p-6 border-t bg-gray-50 flex justify-end space-x-4">
                    <button
                      onClick={() => {
                        setShowCommissionEditor(false);
                        setEditingDealCommission(null);
                      }}
                      className="px-6 py-2 text-gray-600 border rounded hover:bg-gray-100"
                    >
                      Annuleren
                    </button>
                    <button
                      onClick={handleSave}
                      className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                      💾 Opslaan
                    </button>
                  </div>
                </div>
              </div>
            );
          };

          // 🔥 SIMPLIFIED INVESTOR FORM
          const InvestorForm = ({ onSubmit, onCancel, editData = null }) => {
            const [formData, setFormData] = useState(editData || {
              naam: '',
              email: '',
              telefoon: '',
              bedrijf: '',
              locatie: '',
              minBudget: '',
              maxBudget: '',
              // 🔥 SIMPLIFIED LOCATION FIELDS
              voorkeursRegio: [],
              voorkeursLanden: [],
              locatieDetails: '', // 🔥 NEW: Free text for location preferences
              vastgoedTypes: [],
              projectTypes: [],
              risicoprofiel: 'Gemiddeld',
              gewenstRendement: '',
              investeringshorizon: 'Middellang',
              ervaringLevel: 'Gemiddeld',
              // 🔥 ENHANCED WITH SEMANTIC FIELDS
              investmentMotivatie: '', // 🔥 ENHANCED: For semantic matching
              bijzonderheden: '', // 🔥 NEW: Additional notes for semantic matching
              communicatieVoorkeur: 'Email',
              beschikbaarheid: 'Direct'
            });

            // 🔥 SIMPLIFIED LOCATION OPTIONS
            const hoofdLanden = [
              'Nederland', 'Duitsland', 'Frankrijk', 'Spanje', 'Zwitserland', 
              'België', 'Verenigd Koninkrijk', 'Italië', 'Oostenrijk', 
              'Tsjechië', 'Polen', 'Portugal', 'Scandinavië'
            ];

            const regios = ['West-Europa', 'Zuid-Europa', 'Noord-Europa', 'Oost-Europa'];

            const handleLandChange = (land) => {
              setFormData(prev => ({
                ...prev,
                voorkeursLanden: (prev.voorkeursLanden || []).includes(land)
                  ? (prev.voorkeursLanden || []).filter(l => l !== land)
                  : [...(prev.voorkeursLanden || []), land]
              }));
            };

            const handleRegioChange = (regio) => {
              setFormData(prev => ({
                ...prev,
                voorkeursRegio: (prev.voorkeursRegio || []).includes(regio)
                  ? (prev.voorkeursRegio || []).filter(r => r !== regio)
                  : [...(prev.voorkeursRegio || []), regio]
              }));
            };

            const handleProjectTypeChange = (type) => {
              setFormData(prev => ({
                ...prev,
                projectTypes: (prev.projectTypes || []).includes(type)
                  ? (prev.projectTypes || []).filter(t => t !== type)
                  : [...(prev.projectTypes || []), type]
              }));
            };

            const handleTypeChange = (type) => {
              setFormData(prev => ({
                ...prev,
                vastgoedTypes: (prev.vastgoedTypes || []).includes(type)
                  ? (prev.vastgoedTypes || []).filter(t => t !== type)
                  : [...(prev.vastgoedTypes || []), type]
              }));
            };

            const handleSubmit = (e) => {
              e.preventDefault();
              onSubmit(formData);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-4xl h-full max-h-[95vh] flex flex-col">
                  <div className="p-6 border-b">
                    <div className="flex items-center justify-between">
                      <h3 className="text-xl font-bold">
                        {editData ? '✏️ Investeerder Bewerken' : '➕ Nieuwe Investeerder Toevoegen'}
                      </h3>
                      <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">✕</button>
                    </div>
                    <p className="text-sm text-purple-600 mt-2">
                      🔥 Enhanced: Vereenvoudigde invoer met AI semantic matching
                    </p>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-6">
                    <form onSubmit={handleSubmit} id="investor-form">
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Basis Informatie</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Naam *</label>
                            <input
                              type="text"
                              value={formData.naam}
                              onChange={(e) => setFormData({...formData, naam: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Email *</label>
                            <input
                              type="email"
                              value={formData.email}
                              onChange={(e) => setFormData({...formData, email: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Telefoon</label>
                            <input
                              type="tel"
                              value={formData.telefoon}
                              onChange={(e) => setFormData({...formData, telefoon: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Bedrijf/Fonds</label>
                            <input
                              type="text"
                              value={formData.bedrijf}
                              onChange={(e) => setFormData({...formData, bedrijf: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Naam van bedrijf of fonds"
                            />
                          </div>
                          <div className="md:col-span-2">
                            <label className="block text-sm font-medium mb-1">Huidige Locatie/Hoofdkantoor</label>
                            <input
                              type="text"
                              value={formData.locatie}
                              onChange={(e) => setFormData({...formData, locatie: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Bijvoorbeeld: Amsterdam, Berlijn, etc."
                            />
                          </div>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Budget & Financiën</h4>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Min Budget (€) *</label>
                            <input
                              type="number"
                              value={formData.minBudget}
                              onChange={(e) => setFormData({...formData, minBudget: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Max Budget (€) *</label>
                            <input
                              type="number"
                              value={formData.maxBudget}
                              onChange={(e) => setFormData({...formData, maxBudget: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Gewenst Rendement (%) *</label>
                            <input
                              type="number"
                              step="0.1"
                              value={formData.gewenstRendement}
                              onChange={(e) => setFormData({...formData, gewenstRendement: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                        </div>
                      </div>

                      {/* 🔥 SIMPLIFIED LOCATION PREFERENCES */}
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">🗺️ Locatie Voorkeuren (Vereenvoudigd)</h4>
                        
                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-2">Voorkeurs Regio's</label>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {regios.map(regio => (
                              <label key={regio} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.voorkeursRegio || []).includes(regio)}
                                  onChange={() => handleRegioChange(regio)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{regio}</span>
                              </label>
                            ))}
                          </div>
                        </div>

                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-2">Voorkeurs Landen</label>
                          <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto border rounded p-3">
                            {hoofdLanden.map(land => (
                              <label key={land} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.voorkeursLanden || []).includes(land)}
                                  onChange={() => handleLandChange(land)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{land}</span>
                              </label>
                            ))}
                          </div>
                        </div>

                        {/* 🔥 NEW: FREE TEXT LOCATION DETAILS */}
                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-2">
                            🔥 Specifieke Locatie Eisen (Vrije Tekst)
                          </label>
                          <textarea
                            value={formData.locatieDetails}
                            onChange={(e) => setFormData({...formData, locatieDetails: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Amsterdam centrum, nabij openbaar vervoer, geen Zuidoost. Berlijn Mitte of Prenzlauer Berg. Goede bereikbaarheid belangrijk..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            💡 AI gebruikt deze tekst voor slimme matching met deal beschrijvingen
                          </p>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Vastgoed Voorkeuren</h4>
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Vastgoed Types</label>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                            {['Appartement', 'Kantoor', 'Retail', 'Industrie', 'Woning', 'Hotel', 'Studenten', 'Zorgvastgoed'].map(type => (
                              <label key={type} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.vastgoedTypes || []).includes(type)}
                                  onChange={() => handleTypeChange(type)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{type}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-2">Project Types</label>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                            {['Turn-key', 'Renovatie', 'Transformatie', 'Ontwikkeling', 'Gemengd'].map(type => (
                              <label key={type} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                                <input
                                  type="checkbox"
                                  checked={(formData.projectTypes || []).includes(type)}
                                  onChange={() => handleProjectTypeChange(type)}
                                  className="text-blue-600"
                                />
                                <span className="text-sm">{type}</span>
                              </label>
                            ))}
                          </div>
                        </div>
                      </div>

                      {/* 🔥 ENHANCED SEMANTIC FIELDS */}
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">🤖 Investment Profiel (Voor AI Matching)</h4>
                        
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">
                            Investment Motivatie & Doelen
                          </label>
                          <textarea
                            value={formData.investmentMotivatie}
                            onChange={(e) => setFormData({...formData, investmentMotivatie: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Zoek stabiele huurinkomsten voor pensioenopbouw. Geen renovatie projecten, liever turn-key. Duurzaamheid steeds belangrijker. Ervaring met studentenhuisvesting..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            💡 AI matcht deze tekst met deal beschrijvingen voor betere matches
                          </p>
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">
                            Bijzonderheden & Voorkeuren
                          </label>
                          <textarea
                            value={formData.bijzonderheden}
                            onChange={(e) => setFormData({...formData, bijzonderheden: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Voorkeur voor energiezuinige panden. Geen ground floor retail. Ervaring met vastgoedbeheer. Snel beslissen bij goede deals..."
                          />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Risicoprofiel</label>
                            <select
                              value={formData.risicoprofiel}
                              onChange={(e) => setFormData({...formData, risicoprofiel: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="Conservatief">Conservatief</option>
                              <option value="Gemiddeld">Gemiddeld</option>
                              <option value="Agressief">Agressief</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Ervaring Level</label>
                            <select
                              value={formData.ervaringLevel}
                              onChange={(e) => setFormData({...formData, ervaringLevel: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="Beginner">Beginner</option>
                              <option value="Gemiddeld">Gemiddeld</option>
                              <option value="Ervaren">Ervaren</option>
                              <option value="Expert">Expert</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Beschikbaarheid</label>
                            <select
                              value={formData.beschikbaarheid}
                              onChange={(e) => setFormData({...formData, beschikbaarheid: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="Direct">Direct beschikbaar</option>
                              <option value="Binnen 1 maand">Binnen 1 maand</option>
                              <option value="Binnen 3 maanden">Binnen 3 maanden</option>
                              <option value="Flexibel">Flexibel</option>
                            </select>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                  
                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-end space-x-4">
                      <button
                        type="button"
                        onClick={onCancel}
                        className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                      >
                        Annuleren
                      </button>
                      <button
                        type="submit"
                        form="investor-form"
                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        {editData ? '💾 Opslaan' : '➕ Toevoegen'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // 🔥 NEW: BROKER FORM
          const BrokerForm = ({ onSubmit, onCancel, editData = null }) => {
            const [formData, setFormData] = useState(editData || {
              naam: '',
              email: '',
              telefoon: '',
              bedrijf: '',
              locatie: '',
              specialisaties: [],
              werkgebied: [],
              ervaringJaren: '',
              trackRecord: '',
              commissieStructuur: '',
              locatieDetails: '',
              werkwijze: '',
              bijzonderheden: ''
            });

            const specialisatieOpties = [
              'Commercieel', 'Residentieel', 'Industrie', 'Retail', 
              'Kantoren', 'Logistiek', 'Hotels', 'Zorgvastgoed'
            ];

            const werkgebiedOpties = [
              'Amsterdam', 'Rotterdam', 'Utrecht', 'Den Haag', 'Eindhoven',
              'Tilburg', 'Haarlem', 'Almere', 'Breda', 'Nijmegen',
              'Berlijn', 'München', 'Hamburg', 'Frankfurt', 'Parijs',
              'Madrid', 'Barcelona', 'Zürich', 'Genève'
            ];

            const handleSpecialisatieChange = (specialisatie) => {
              setFormData(prev => ({
                ...prev,
                specialisaties: (prev.specialisaties || []).includes(specialisatie)
                  ? (prev.specialisaties || []).filter(s => s !== specialisatie)
                  : [...(prev.specialisaties || []), specialisatie]
              }));
            };

            const handleWerkgebiedChange = (gebied) => {
              setFormData(prev => ({
                ...prev,
                werkgebied: (prev.werkgebied || []).includes(gebied)
                  ? (prev.werkgebied || []).filter(g => g !== gebied)
                  : [...(prev.werkgebied || []), gebied]
              }));
            };

            const handleSubmit = (e) => {
              e.preventDefault();
              onSubmit(formData);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-4xl h-full max-h-[95vh] flex flex-col">
                  <div className="p-6 border-b">
                    <div className="flex items-center justify-between">
                      <h3 className="text-xl font-bold">
                        {editData ? '✏️ Broker Bewerken' : '➕ Nieuwe Broker Toevoegen'}
                      </h3>
                      <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">✕</button>
                    </div>
                    <p className="text-sm text-blue-600 mt-2">
                      🏢 Broker specialiseert in vastgoed deal sourcing en matching
                    </p>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-6">
                    <form onSubmit={handleSubmit} id="broker-form">
                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Basis Informatie</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Naam *</label>
                            <input
                              type="text"
                              value={formData.naam}
                              onChange={(e) => setFormData({...formData, naam: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Email *</label>
                            <input
                              type="email"
                              value={formData.email}
                              onChange={(e) => setFormData({...formData, email: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              required
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Telefoon</label>
                            <input
                              type="tel"
                              value={formData.telefoon}
                              onChange={(e) => setFormData({...formData, telefoon: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Bedrijf/Kantoor</label>
                            <input
                              type="text"
                              value={formData.bedrijf}
                              onChange={(e) => setFormData({...formData, bedrijf: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Naam van makelaarskantoor"
                            />
                          </div>
                          <div className="md:col-span-2">
                            <label className="block text-sm font-medium mb-1">Huidige Locatie/Hoofdkantoor</label>
                            <input
                              type="text"
                              value={formData.locatie}
                              onChange={(e) => setFormData({...formData, locatie: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Bijvoorbeeld: Amsterdam, Berlijn, etc."
                            />
                          </div>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Professionele Details</h4>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium mb-1">Ervaring (jaren)</label>
                            <input
                              type="number"
                              value={formData.ervaringJaren}
                              onChange={(e) => setFormData({...formData, ervaringJaren: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              min="0"
                              max="50"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium mb-1">Commissie Structuur</label>
                            <input
                              type="text"
                              value={formData.commissieStructuur}
                              onChange={(e) => setFormData({...formData, commissieStructuur: e.target.value})}
                              className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Bijvoorbeeld: 2.5% koper, 2.5% verkoper"
                            />
                          </div>
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Specialisaties</h4>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                          {specialisatieOpties.map(specialisatie => (
                            <label key={specialisatie} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                              <input
                                type="checkbox"
                                checked={(formData.specialisaties || []).includes(specialisatie)}
                                onChange={() => handleSpecialisatieChange(specialisatie)}
                                className="text-blue-600"
                              />
                              <span className="text-sm">{specialisatie}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">Werkgebied</h4>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto border rounded p-3">
                          {werkgebiedOpties.map(gebied => (
                            <label key={gebied} className="flex items-center space-x-2 p-2 border rounded cursor-pointer hover:bg-gray-50">
                              <input
                                type="checkbox"
                                checked={(formData.werkgebied || []).includes(gebied)}
                                onChange={() => handleWerkgebiedChange(gebied)}
                                className="text-blue-600"
                              />
                              <span className="text-sm">{gebied}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="mb-8">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">🤖 Professioneel Profiel (Voor AI Matching)</h4>
                        
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Track Record & Ervaring</label>
                          <textarea
                            value={formData.trackRecord}
                            onChange={(e) => setFormData({...formData, trackRecord: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Gespecialiseerd in kantoorpanden €1M+, 120+ deals afgelopen 5 jaar. Focus op Amsterdam Zuidas en Noord. Ervaring met internationale investeerders..."
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Werkwijze & Aanpak</label>
                          <textarea
                            value={formData.werkwijze}
                            onChange={(e) => setFormData({...formData, werkwijze: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Proactieve deal sourcing, uitgebreid netwerk investeerders. Snelle besluitvorming, transparante communicatie. Spreekt vloeiend Engels en Duits..."
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Locatie Details & Specialiteiten</label>
                          <textarea
                            value={formData.locatieDetails}
                            onChange={(e) => setFormData({...formData, locatieDetails: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Actief in Randstad, specialiteit Amsterdam Noord en Zuidas. Goede connecties in Berlijn Mitte. Focus op off-market deals..."
                          />
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-2">Bijzonderheden</label>
                          <textarea
                            value={formData.bijzonderheden}
                            onChange={(e) => setFormData({...formData, bijzonderheden: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: RICS gecertificeerd. Ervaring met internationale investeerders. Netwerk van family offices. Specialiteit duurzame vastgoed projecten..."
                          />
                        </div>
                      </div>
                    </form>
                  </div>
                  
                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-end space-x-4">
                      <button
                        type="button"
                        onClick={onCancel}
                        className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                      >
                        Annuleren
                      </button>
                      <button
                        type="submit"
                        form="broker-form"
                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        {editData ? '💾 Opslaan' : '➕ Toevoegen'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };
          const DealForm = ({ onSubmit, onCancel, editData = null }) => {
            const [formData, setFormData] = useState(editData || {
              titel: '',
              locatie: '',
              type: '',
              projectType: '',
              prijs: '',
              verwachtRendement: '',
              risico: 'Gemiddeld',
              beschrijving: '',
              bijzonderheden: '', // 🔥 NEW: For semantic matching
              oppervlakte: '',
              bouwjaar: '',
              huurpotentie: '',
              status: 'Beschikbaar',
              bedrijfFonds: '',
              contactpersoon: '',
              telefoon: '',
              email: ''
            });

            const handleSubmit = (e) => {
              e.preventDefault();
              onSubmit(formData);
            };

            return (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg w-full max-w-4xl h-full max-h-[95vh] flex flex-col">
                  <div className="p-6 border-b">
                    <div className="flex items-center justify-between">
                      <h3 className="text-xl font-bold">
                        {editData ? '✏️ Deal Bewerken' : '➕ Nieuwe Deal Toevoegen'}
                      </h3>
                      <button onClick={onCancel} className="text-gray-400 hover:text-gray-600">✕</button>
                    </div>
                    <p className="text-sm text-purple-600 mt-2">
                      🔥 Enhanced: Uitgebreide beschrijvingen voor AI semantic matching
                    </p>
                  </div>
                  
                  <div className="flex-1 overflow-y-auto p-6">
                    <form onSubmit={handleSubmit} id="deal-form">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                          <label className="block text-sm font-medium mb-1">Titel *</label>
                          <input
                            type="text"
                            value={formData.titel}
                            onChange={(e) => setFormData({...formData, titel: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Bedrijf/Fonds</label>
                          <input
                            type="text"
                            value={formData.bedrijfFonds}
                            onChange={(e) => setFormData({...formData, bedrijfFonds: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Naam van bedrijf of fonds"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Contactpersoon</label>
                          <input
                            type="text"
                            value={formData.contactpersoon}
                            onChange={(e) => setFormData({...formData, contactpersoon: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Naam contactpersoon"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Telefoon</label>
                          <input
                            type="tel"
                            value={formData.telefoon}
                            onChange={(e) => setFormData({...formData, telefoon: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Telefoonnummer"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Email</label>
                          <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Email adres"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Locatie *</label>
                          <input
                            type="text"
                            value={formData.locatie}
                            onChange={(e) => setFormData({...formData, locatie: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Bijvoorbeeld: Amsterdam, Berlijn, etc."
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Type *</label>
                          <select
                            value={formData.type}
                            onChange={(e) => setFormData({...formData, type: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          >
                            <option value="">Selecteer type</option>
                            <option value="Appartement">Appartement</option>
                            <option value="Kantoor">Kantoor</option>
                            <option value="Retail">Retail</option>
                            <option value="Industrie">Industrie</option>
                            <option value="Woning">Woning</option>
                            <option value="Hotel">Hotel</option>
                            <option value="Studenten">Studenten</option>
                            <option value="Zorgvastgoed">Zorgvastgoed</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Project Type *</label>
                          <select
                            value={formData.projectType}
                            onChange={(e) => setFormData({...formData, projectType: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          >
                            <option value="">Selecteer project type</option>
                            <option value="Turn-key">Turn-key - Kant-en-klaar</option>
                            <option value="Renovatie">Renovatie - Opknappen</option>
                            <option value="Transformatie">Transformatie - Functiewijziging</option>
                            <option value="Ontwikkeling">Ontwikkeling - Nieuwbouw</option>
                            <option value="Gemengd">Gemengd - Combinatie</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Prijs (€) *</label>
                          <input
                            type="number"
                            value={formData.prijs}
                            onChange={(e) => setFormData({...formData, prijs: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Verwacht Rendement (%) *</label>
                          <input
                            type="number"
                            step="0.1"
                            value={formData.verwachtRendement}
                            onChange={(e) => setFormData({...formData, verwachtRendement: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Risico Level</label>
                          <select
                            value={formData.risico}
                            onChange={(e) => setFormData({...formData, risico: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          >
                            <option value="Laag">Laag</option>
                            <option value="Gemiddeld">Gemiddeld</option>
                            <option value="Hoog">Hoog</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Oppervlakte (m²)</label>
                          <input
                            type="number"
                            value={formData.oppervlakte}
                            onChange={(e) => setFormData({...formData, oppervlakte: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Bouwjaar</label>
                          <input
                            type="number"
                            value={formData.bouwjaar}
                            onChange={(e) => setFormData({...formData, bouwjaar: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Huurpotentie (€/maand)</label>
                          <input
                            type="number"
                            value={formData.huurpotentie}
                            onChange={(e) => setFormData({...formData, huurpotentie: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                      </div>
                      
                      {/* 🔥 ENHANCED DESCRIPTIONS FOR SEMANTIC MATCHING */}
                      <div className="mb-6">
                        <h4 className="text-lg font-semibold mb-4 text-gray-800">🤖 Deal Beschrijving (Voor AI Matching)</h4>
                        
                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-1">Hoofdbeschrijving</label>
                          <textarea
                            value={formData.beschrijving}
                            onChange={(e) => setFormData({...formData, beschrijving: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="3"
                            placeholder="Bijvoorbeeld: Kant-en-klaar nieuwbouw appartement in opkomende wijk. Energielabel A, zonnepanelen. Gegarandeerde huurder voor 5 jaar via corporatie. Nabij metro, 15 min naar centrum..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            💡 AI matcht deze tekst met investeerder motivaties
                          </p>
                        </div>

                        <div className="mb-4">
                          <label className="block text-sm font-medium mb-1">
                            🔥 Bijzonderheden & USP's
                          </label>
                          <textarea
                            value={formData.bijzonderheden}
                            onChange={(e) => setFormData({...formData, bijzonderheden: e.target.value})}
                            className="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            rows="2"
                            placeholder="Bijvoorbeeld: Duurzaam gebouwd, lage servicekosten. Professioneel beheer beschikbaar. Uitstekende buurt met goede voorzieningen. Turn-key: direct rendement, geen werk aan..."
                          />
                          <p className="text-xs text-purple-600 mt-1">
                            💡 Extra details die AI gebruikt voor slimme matching
                          </p>
                        </div>
                      </div>
                    </form>
                  </div>
                  
                  <div className="p-6 border-t bg-gray-50">
                    <div className="flex justify-end space-x-4">
                      <button
                        type="button"
                        onClick={onCancel}
                        className="px-6 py-2 text-gray-600 border rounded-md hover:bg-gray-100"
                      >
                        Annuleren
                      </button>
                      <button
                        type="submit"
                        form="deal-form"
                        className="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                      >
                        {editData ? '💾 Opslaan' : '➕ Toevoegen'}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // Auth Form (unchanged)
          const AuthForm = () => {
            const [formData, setFormData] = useState({
              email: '',
              password: '',
              name: '',
              company: ''
            });
            const [showRegister, setShowRegister] = useState(false);
            const [isLoading, setIsLoading] = useState(false);

            const handleSubmit = async (e) => {
              e.preventDefault();
              setIsLoading(true);
              
              try {
                if (showRegister) {
                  await handleRegister(formData);
                } else {
                  await handleLogin(formData);
                }
              } finally {
                setIsLoading(false);
              }
            };

            return (
              <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                  <div className="text-center mb-8">
                    <h1 className="text-3xl font-bold text-gray-900 mb-2">🏠 Vastgoed Matcher Pro</h1>
                    <p className="text-gray-600">
                      {showRegister ? 'Nieuw account aanmaken' : 'Inloggen op je account'}
                    </p>
                    <div className="flex items-center justify-center space-x-2 mt-3">
                      <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">🤖 AI-Enhanced</span>
                      <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">🌍 Simplified</span>
                      <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">💰 Flex Commission</span>
                      <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">🔥 Semantic</span>
                    </div>
                  </div>

                  {!showRegister && (
                    <div className="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                      <h4 className="font-semibold text-purple-800 mb-2">🔥 Enhanced Matching Features</h4>
                      <div className="space-y-2 text-sm">
                        <div className="bg-white p-3 rounded border border-purple-200">
                          <p className="font-medium text-purple-900">🗺️ Vereenvoudigde Locatie Invoer</p>
                          <p className="text-purple-700">Minder dropdowns, meer vrije tekst input</p>
                        </div>
                        <div className="bg-white p-3 rounded border border-purple-200">
                          <p className="font-medium text-purple-900">🤖 AI Semantic Matching</p>
                          <p className="text-purple-700">AI matcht opmerkingen en beschrijvingen intelligent</p>
                        </div>
                        <div className="bg-green-50 p-3 rounded border border-green-200">
                          <p className="font-medium text-green-900">🎯 Betere Match Kwaliteit</p>
                          <p className="text-green-700">• Vrije tekst matching • Conflict detectie • Genuanceerde voorkeuren</p>
                        </div>
                      </div>
                    </div>
                  )}

                  <form onSubmit={handleSubmit} className="space-y-4">
                    {showRegister && (
                      <>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Naam *</label>
                          <input
                            type="text"
                            value={formData.name}
                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                            disabled={isLoading}
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Bedrijf *</label>
                          <input
                            type="text"
                            value={formData.company}
                            onChange={(e) => setFormData({...formData, company: e.target.value})}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                            disabled={isLoading}
                          />
                        </div>
                      </>
                    )}
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                      <input
                        type="email"
                        value={formData.email}
                        onChange={(e) => setFormData({...formData, email: e.target.value})}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                        disabled={isLoading}
                        placeholder="je@email.com"
                      />
                    </div>
                    
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Wachtwoord *</label>
                      <input
                        type="password"
                        value={formData.password}
                        onChange={(e) => setFormData({...formData, password: e.target.value})}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        required
                        disabled={isLoading}
                        placeholder="••••••••"
                      />
                    </div>
                    
                    <button
                      type="submit"
                      disabled={isLoading}
                      className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2"
                    >
                      {isLoading ? (
                        <>
                          <div className="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                          <span>Bezig...</span>
                        </>
                      ) : (
                        <span>{showRegister ? 'Account Aanmaken' : 'Inloggen'}</span>
                      )}
                    </button>
                  </form>

                  <div className="mt-6 text-center">
                    <button
                      onClick={() => setShowRegister(!showRegister)}
                      className="text-blue-600 hover:text-blue-800 text-sm font-medium"
                      disabled={isLoading}
                    >
                      {showRegister ? 'Al een account? Login hier' : 'Geen account? Registreer hier'}
                    </button>
                  </div>
                </div>
              </div>
            );
          };

          const Dashboard = () => {
            const commissionSummary = calculateCommissionSummary();
            const userInvestors = investors.filter(i => i.owner_id === user.id);
            const userDeals = deals.filter(d => d.owner_id === user.id);

            return (
              <div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                  <div className="bg-white p-6 rounded-lg shadow-md border">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Mijn Investeerders</p>
                        <p className="text-2xl font-bold text-gray-900">{userInvestors.length}</p>
                      </div>
                      <UsersIcon className="h-8 w-8 text-blue-600" />
                    </div>
                  </div>
                  
                  <div className="bg-white p-6 rounded-lg shadow-md border">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Mijn Deals</p>
                        <p className="text-2xl font-bold text-gray-900">{userDeals.length}</p>
                      </div>
                      <BuildingIcon className="h-8 w-8 text-green-600" />
                    </div>
                  </div>
                  
                  <div className="bg-white p-6 rounded-lg shadow-md border">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Totale Commissie</p>
                        <p className="text-2xl font-bold text-gray-900">€{commissionSummary.totalCommission.toLocaleString()}</p>
                      </div>
                      <DollarSignIcon className="h-8 w-8 text-purple-600" />
                    </div>
                  </div>
                  
                  <div className="bg-white p-6 rounded-lg shadow-md border">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-gray-600">Transactie Volume</p>
                        <p className="text-2xl font-bold text-gray-900">€{(commissionSummary.totalVolume / 1000000).toFixed(1)}M</p>
                      </div>
                      <TrendingUpIcon className="h-8 w-8 text-orange-600" />
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div className="bg-white rounded-lg shadow-md p-6 border">
                    <h3 className="text-lg font-semibold mb-4">Recente Transacties</h3>
                    <div className="space-y-3">
                      {transactions.slice(0, 5).map(transaction => {
                        const deal = deals.find(d => d.id === transaction.deal_id);
                        const investor = investors.find(i => i.id === transaction.investor_id);
                        
                        let userCommission = 0;
                        if (transaction.participant_commissions) {
                          try {
                            const participants = JSON.parse(transaction.participant_commissions);
                            const userParticipant = participants.find(p => p.user_id === user.id);
                            userCommission = userParticipant ? userParticipant.commission_amount : 0;
                          } catch (e) {
                            console.error('Error parsing participant commissions:', e);
                          }
                        } else {
                          userCommission = transaction.deal_owner_id === user.id ? (transaction.deal_owner_commission || 0) : (transaction.investor_owner_commission || 0);
                        }
                        
                        return (
                          <div key={transaction.id} className="flex items-center justify-between p-3 bg-gray-50 rounded">
                            <div>
                              <p className="font-medium">{deal?.titel || 'Onbekende Deal'}</p>
                              <p className="text-sm text-gray-600">{investor?.naam || 'Onbekende Investeerder'}</p>
                            </div>
                            <div className="text-right">
                              <p className="font-medium">€{transaction.transaction_amount.toLocaleString()}</p>
                              <p className="text-sm text-green-600">+€{userCommission.toLocaleString()} commissie</p>
                              <p className={`text-xs ${transaction.status === 'completed' ? 'text-green-600' : 'text-yellow-600'}`}>
                                {transaction.status === 'completed' ? 'Afgerond' : 'Pending'}
                              </p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  <div className="bg-white rounded-lg shadow-md p-6 border">
                    <h3 className="text-lg font-semibold mb-4">Team Leden</h3>
                    <div className="space-y-3">
                      {users.map(userItem => {
                        const userInvestorCount = investors.filter(i => i.owner_id === userItem.id).length;
                        const userDealCount = deals.filter(d => d.owner_id === userItem.id).length;
                        return (
                          <div key={userItem.id} className="flex items-center justify-between p-3 bg-gray-50 rounded">
                            <div className="flex items-center space-x-3">
                              <UserCheckIcon className="h-5 w-5 text-blue-600" />
                              <div>
                                <p className="font-medium">{userItem.name}</p>
                                <p className="text-sm text-gray-600">{userItem.company}</p>
                              </div>
                            </div>
                            <div className="text-right">
                              <p className="text-sm">{userInvestorCount} investeerders</p>
                              <p className="text-sm">{userDealCount} deals</p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            );
          };

          // Show auth form if not logged in
          if (showAuth || !user) {
            return <AuthForm />;
          }

          return (
            <div className="max-w-7xl mx-auto p-6">
              <div className="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center">
                <div>
                  <h1 className="text-3xl font-bold text-gray-900 mb-2">Vastgoed Matcher Pro AI - Enhanced</h1>
                  <p className="text-gray-600 mb-3">Welkom terug, {user.name}! ({user.role}) Enhanced matching met vereenvoudigde invoer en AI semantic analysis</p>
                  <div className="flex flex-wrap items-center space-x-2 space-y-1 sm:space-y-0">
                    <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded-full">🤖 AI-Enhanced</span>
                    <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">🗺️ Simplified Location</span>
                    <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full">🔥 Semantic Matching</span>
                    <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">💰 Flex Commissies</span>
                    <span className="text-xs bg-red-100 text-red-800 px-2 py-1 rounded-full">✏️ Edit Features</span>
                    <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">💬 Free Text Input</span>
                  </div>
                </div>
                <div className="flex items-center space-x-4 mt-4 lg:mt-0">
                  <button
                    onClick={testAIConnection}
                    disabled={isLoadingAI}
                    className="bg-purple-600 text-white px-3 py-1 rounded-md hover:bg-purple-700 transition-colors text-sm flex items-center space-x-1 disabled:opacity-50"
                  >
                    <BrainIcon size={14} />
                    <span>{isLoadingAI ? 'Test...' : 'Test AI'}</span>
                  </button>
                  <div className="flex items-center space-x-2 text-gray-600">
                    <UserIcon size={16} />
                    <span>{user.company}</span>
                  </div>
                  <button
                    onClick={handleLogout}
                    className="flex items-center space-x-2 text-gray-600 hover:text-red-600 transition-colors"
                  >
                    <LogOutIcon size={16} />
                    <span>Uitloggen</span>
                  </button>
                </div>
              </div>

              <div className="flex space-x-2 mb-6 overflow-x-auto pb-2">
                <button
                  onClick={() => setActiveTab('dashboard')}
                  className={`px-4 py-2 rounded-lg flex items-center space-x-2 whitespace-nowrap transition-colors ${
                    activeTab === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <TrendingUpIcon size={20} />
                  <span>Dashboard</span>
                </button>
                <button
                  onClick={() => setActiveTab('investors')}
                  className={`px-4 py-2 rounded-lg flex items-center space-x-2 whitespace-nowrap transition-colors ${
                    activeTab === 'investors' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <UsersIcon size={20} />
                  <span>🔥 Contacten ({investors.length + brokers.length})</span>
                </button>
                <button
                  onClick={() => setActiveTab('deals')}
                  className={`px-4 py-2 rounded-lg flex items-center space-x-2 whitespace-nowrap transition-colors ${
                    activeTab === 'deals' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <BuildingIcon size={20} />
                  <span>Deals ({deals.length})</span>
                </button>
                <button
                  onClick={() => setActiveTab('matching')}
                  className={`px-4 py-2 rounded-lg flex items-center space-x-2 whitespace-nowrap transition-colors ${
                    activeTab === 'matching' ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <StarIcon size={20} />
                  <span>🔥 Enhanced Matching</span>
                </button>
                <button
                  onClick={() => setActiveTab('transactions')}
                  className={`px-4 py-2 rounded-lg flex items-center space-x-2 whitespace-nowrap transition-colors ${
                    activeTab === 'transactions' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  <DollarSignIcon size={20} />
                  <span>Transacties ({transactions.length})</span>
                </button>
              </div>

              {activeTab === 'dashboard' && <Dashboard />}

              {activeTab === 'investors' && (
                <div>
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <div>
                      <h2 className="text-2xl font-bold">🔥 Contacten Beheer</h2>
                      <p className="text-gray-600 text-sm">Beheer investeerders en brokers in één overzicht</p>
                    </div>
                    <div className="flex space-x-2">
                      <button
                        onClick={() => setShowAddInvestor(true)}
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
                      >
                        <PlusIcon size={20} />
                        <span>🏦 Investeerder</span>
                      </button>
                      <button
                        onClick={() => setShowAddBroker(true)}
                        className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-green-700 transition-colors"
                      >
                        <PlusIcon size={20} />
                        <span>🏢 Broker</span>
                      </button>
                    </div>
                  </div>

                  {/* 🔥 NEW: Contact Filters */}
                  <div className="mb-6 bg-white p-4 rounded-lg shadow border">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                      <div className="flex space-x-2">
                        <button
                          onClick={() => setContactFilter('all')}
                          className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                            contactFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          <UsersIcon size={16} />
                          <span>Alle Contacten ({investors.length + brokers.length})</span>
                        </button>
                        <button
                          onClick={() => setContactFilter('investors')}
                          className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                            contactFilter === 'investors' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          <span>🏦</span>
                          <span>Investeerders ({investors.length})</span>
                        </button>
                        <button
                          onClick={() => setContactFilter('brokers')}
                          className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                            contactFilter === 'brokers' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`}
                        >
                          <span>🏢</span>
                          <span>Brokers ({brokers.length})</span>
                        </button>
                      </div>
                      
                      <div className="text-sm text-gray-600">
                        {contactFilter === 'all' && `${investors.length} investeerders • ${brokers.length} brokers`}
                        {contactFilter === 'investors' && `${investors.filter(i => i.owner_id === user.id).length} mijn investeerders • ${investors.length} totaal`}
                        {contactFilter === 'brokers' && `${brokers.filter(b => b.owner_id === user.id).length} mijn brokers • ${brokers.length} totaal`}
                      </div>
                    </div>
                  </div>

                  {/* 🔥 UNIFIED CONTACTS GRID */}
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {/* Show Investors */}
                    {(contactFilter === 'all' || contactFilter === 'investors') && 
                      investors.map(investor => (
                        <div key={`investor-${investor.id}`} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-2">
                              <span className="text-blue-600 text-lg">🏦</span>
                              <h3 className="text-xl font-semibold text-gray-900">{investor.naam}</h3>
                            </div>
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                              investor.risicoprofiel === 'Conservatief' ? 'bg-green-100 text-green-800' :
                              investor.risicoprofiel === 'Gemiddeld' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {investor.risicoprofiel}
                            </span>
                          </div>

                          <div className="space-y-2 text-sm mb-4">
                            <div className="flex items-center space-x-2">
                              <UserCheckIcon size={16} className="text-gray-500" />
                              <span>Eigenaar: {getUserById(investor.owner_id).name}</span>
                            </div>
                            {investor.bedrijf && (
                              <div className="flex items-center space-x-2">
                                <BuildingIcon size={16} className="text-gray-500" />
                                <span className="font-medium">{investor.bedrijf}</span>
                              </div>
                            )}
                            {investor.locatie && (
                              <div className="flex items-center space-x-2">
                                <MapPinIcon size={16} className="text-gray-500" />
                                <span>Gevestigd in: {investor.locatie}</span>
                              </div>
                            )}
                            <div className="flex items-center space-x-2">
                              <MailIcon size={16} className="text-gray-500" />
                              <span>{investor.email}</span>
                            </div>
                            <div className="flex items-center space-x-2">
                              <EuroIcon size={16} className="text-gray-500" />
                              <span>€{investor.minBudget.toLocaleString()} - €{investor.maxBudget.toLocaleString()}</span>
                            </div>
                          </div>

                          {investor.locatieDetails && (
                            <div className="mt-4 p-3 bg-purple-50 rounded border border-purple-200">
                              <p className="text-sm text-purple-800 font-medium mb-1">🗺️ Locatie Details:</p>
                              <p className="text-xs text-purple-700">{investor.locatieDetails}</p>
                            </div>
                          )}

                          {investor.investmentMotivatie && (
                            <div className="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                              <p className="text-sm text-blue-800 font-medium mb-1">🎯 Investment Motivatie:</p>
                              <p className="text-xs text-blue-700">{investor.investmentMotivatie}</p>
                            </div>
                          )}

                          <div className="mt-4">
                            <p className="text-sm text-gray-600 mb-2">Interessegebieden:</p>
                            <div className="flex flex-wrap gap-1">
                              {(investor.vastgoedTypes || []).slice(0, 3).map(type => (
                                <span key={type} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                  {type}
                                </span>
                              ))}
                              {(investor.vastgoedTypes || []).length > 3 && (
                                <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                  +{(investor.vastgoedTypes || []).length - 3} meer
                                </span>
                              )}
                            </div>
                          </div>

                          <div className="mt-4 pt-4 border-t space-y-2">
                            <button
                              onClick={() => getInvestorInsights(investor.id)}
                              disabled={isLoadingAI}
                              className="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                            >
                              <BrainIcon size={16} />
                              <span>{isLoadingAI ? 'AI Analyseert...' : 'AI Analyse'}</span>
                            </button>
                            
                            {(user.role === 'beheerder' || investor.owner_id === user.id) && (
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => handleEditInvestor(investor)}
                                  className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <EditIcon size={16} />
                                  <span>Bewerken</span>
                                </button>
                                <button
                                  onClick={() => handleDeleteInvestor(investor.id)}
                                  className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <TrashIcon size={16} />
                                  <span>Verwijderen</span>
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      ))
                    }

                    {/* 🔥 NEW: Show Brokers */}
                    {(contactFilter === 'all' || contactFilter === 'brokers') && 
                      brokers.map(broker => (
                        <div key={`broker-${broker.id}`} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow border-l-4 border-l-green-500">
                          <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center space-x-2">
                              <span className="text-green-600 text-lg">🏢</span>
                              <h3 className="text-xl font-semibold text-gray-900">{broker.naam}</h3>
                            </div>
                            {broker.ervaringJaren && (
                              <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                                {broker.ervaringJaren} jaar ervaring
                              </span>
                            )}
                          </div>

                          <div className="space-y-2 text-sm mb-4">
                            <div className="flex items-center space-x-2">
                              <UserCheckIcon size={16} className="text-gray-500" />
                              <span>Eigenaar: {getUserById(broker.owner_id).name}</span>
                            </div>
                            {broker.bedrijf && (
                              <div className="flex items-center space-x-2">
                                <BuildingIcon size={16} className="text-gray-500" />
                                <span className="font-medium">{broker.bedrijf}</span>
                              </div>
                            )}
                            {broker.locatie && (
                              <div className="flex items-center space-x-2">
                                <MapPinIcon size={16} className="text-gray-500" />
                                <span>Kantoor: {broker.locatie}</span>
                              </div>
                            )}
                            <div className="flex items-center space-x-2">
                              <MailIcon size={16} className="text-gray-500" />
                              <span>{broker.email}</span>
                            </div>
                            {broker.commissieStructuur && (
                              <div className="flex items-center space-x-2">
                                <PercentIcon size={16} className="text-gray-500" />
                                <span>{broker.commissieStructuur}</span>
                              </div>
                            )}
                          </div>

                          {broker.specialisaties && broker.specialisaties.length > 0 && (
                            <div className="mt-4">
                              <p className="text-sm text-gray-600 mb-2">Specialisaties:</p>
                              <div className="flex flex-wrap gap-1">
                                {broker.specialisaties.slice(0, 3).map(spec => (
                                  <span key={spec} className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
                                    {spec}
                                  </span>
                                ))}
                                {broker.specialisaties.length > 3 && (
                                  <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    +{broker.specialisaties.length - 3} meer
                                  </span>
                                )}
                              </div>
                            </div>
                          )}

                          {broker.werkgebied && broker.werkgebied.length > 0 && (
                            <div className="mt-3">
                              <p className="text-sm text-gray-600 mb-2">Werkgebied:</p>
                              <div className="flex flex-wrap gap-1">
                                {broker.werkgebied.slice(0, 3).map(gebied => (
                                  <span key={gebied} className="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                    {gebied}
                                  </span>
                                ))}
                                {broker.werkgebied.length > 3 && (
                                  <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    +{broker.werkgebied.length - 3} meer
                                  </span>
                                )}
                              </div>
                            </div>
                          )}

                          {broker.trackRecord && (
                            <div className="mt-4 p-3 bg-green-50 rounded border border-green-200">
                              <p className="text-sm text-green-800 font-medium mb-1">📈 Track Record:</p>
                              <p className="text-xs text-green-700">{broker.trackRecord}</p>
                            </div>
                          )}

                          {broker.werkwijze && (
                            <div className="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                              <p className="text-sm text-blue-800 font-medium mb-1">🎯 Werkwijze:</p>
                              <p className="text-xs text-blue-700">{broker.werkwijze}</p>
                            </div>
                          )}

                          <div className="mt-4 pt-4 border-t space-y-2">
                            <button
                              onClick={() => alert(`Contacteer ${broker.naam} via email: ${broker.email}`)}
                              className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                            >
                              <MailIcon size={16} />
                              <span>Contact Opnemen</span>
                            </button>
                            
                            {(user.role === 'beheerder' || broker.owner_id === user.id) && (
                              <div className="flex space-x-2">
                                <button
                                  onClick={() => handleEditBroker(broker)}
                                  className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <EditIcon size={16} />
                                  <span>Bewerken</span>
                                </button>
                                <button
                                  onClick={() => handleDeleteBroker(broker.id)}
                                  className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                  <TrashIcon size={16} />
                                  <span>Verwijderen</span>
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      ))
                    }
                  </div>

                  {/* Empty state */}
                  {((contactFilter === 'all' && investors.length === 0 && brokers.length === 0) ||
                    (contactFilter === 'investors' && investors.length === 0) ||
                    (contactFilter === 'brokers' && brokers.length === 0)) && (
                    <div className="text-center py-12">
                      <UsersIcon size={48} className="text-gray-400 mx-auto mb-4" />
                      <div className="space-y-2">
                        <p className="text-gray-600 text-lg">
                          {contactFilter === 'brokers' ? 'Nog geen brokers toegevoegd' : 
                           contactFilter === 'investors' ? 'Nog geen investeerders toegevoegd' :
                           'Nog geen contacten toegevoegd'}
                        </p>
                        <p className="text-sm text-gray-500">
                          {contactFilter === 'brokers' ? 'Voeg brokers toe om je deal sourcing te verbeteren' :
                           contactFilter === 'investors' ? 'Voeg investeerders toe om matches te kunnen maken' :
                           'Voeg investeerders en brokers toe om te beginnen'}
                        </p>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'deals' && (
                <div>
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <h2 className="text-2xl font-bold">Deals</h2>
                    <button
                      onClick={() => setShowAddDeal(true)}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
                    >
                      <PlusIcon size={20} />
                      <span>Nieuwe Deal</span>
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {deals.map(deal => (
                      <div key={deal.id} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                        <div className="flex items-center justify-between mb-4">
                          <h3 className="text-xl font-semibold text-gray-900">{deal.titel}</h3>
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            deal.risico === 'Laag' ? 'bg-green-100 text-green-800' :
                            deal.risico === 'Gemiddeld' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>
                            {deal.risico} risico
                          </span>
                        </div>

                        <div className="space-y-2 text-sm mb-4">
                          <div className="flex items-center space-x-2">
                            <UserCheckIcon size={16} className="text-gray-500" />
                            <span>Eigenaar: {getUserById(deal.owner_id).name}</span>
                          </div>
                          {deal.bedrijfFonds && (
                            <div className="flex items-center space-x-2">
                              <BuildingIcon size={16} className="text-gray-500" />
                              <span className="font-medium">{deal.bedrijfFonds}</span>
                            </div>
                          )}
                          {deal.contactpersoon && (
                            <div className="flex items-center space-x-2">
                              <UserIcon size={16} className="text-gray-500" />
                              <span>{deal.contactpersoon}</span>
                            </div>
                          )}
                          {deal.telefoon && (
                            <div className="flex items-center space-x-2">
                              <PhoneIcon size={16} className="text-gray-500" />
                              <span>{deal.telefoon}</span>
                            </div>
                          )}
                          {deal.email && (
                            <div className="flex items-center space-x-2">
                              <MailIcon size={16} className="text-gray-500" />
                              <span>{deal.email}</span>
                            </div>
                          )}
                          <div className="flex items-center space-x-2">
                            <MapPinIcon size={16} className="text-gray-500" />
                            <span>{deal.locatie}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <BuildingIcon size={16} className="text-gray-500" />
                            <span>{deal.type}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <TargetIcon size={16} className="text-gray-500" />
                            <span>{deal.projectType}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <EuroIcon size={16} className="text-gray-500" />
                            <span className="font-semibold">€{deal.prijs.toLocaleString()}</span>
                          </div>
                          <div className="flex items-center space-x-2">
                            <TrendingUpIcon size={16} className="text-gray-500" />
                            <span className="font-semibold text-green-600">{deal.verwachtRendement}% rendement</span>
                          </div>
                        </div>

                        {deal.commissionStructure && (
                          <div className="mb-4 p-3 bg-gray-50 rounded border">
                            <div className="flex items-center justify-between mb-2">
                              <span className="text-sm font-medium text-gray-700">Commissie Structuur</span>
                              <span className="text-sm text-gray-600">
                                {(deal.commissionStructure.total_rate * 100).toFixed(2)}%
                              </span>
                            </div>
                            <div className="text-xs text-gray-600">
                              {deal.commissionStructure.participants?.length || 0} deelnemers geconfigureerd
                            </div>
                          </div>
                        )}

                        <p className="text-sm text-gray-600 mb-4">{deal.beschrijving}</p>

                        {/* 🔥 ENHANCED: Show semantic fields */}
                        {deal.bijzonderheden && (
                          <div className="mb-4 p-3 bg-purple-50 rounded border border-purple-200">
                            <p className="text-sm text-purple-800 font-medium mb-1">🔥 Bijzonderheden:</p>
                            <p className="text-xs text-purple-700">{deal.bijzonderheden}</p>
                          </div>
                        )}

                        <div className="space-y-2">
                          <button
                            onClick={() => {
                              setMatches(findMatches(deal.id));
                              setActiveTab('matching');
                            }}
                            className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                          >
                            <StarIcon size={16} />
                            <span>🔥 Enhanced Matches</span>
                          </button>
                          
                          <div className="flex space-x-2">
                            <button
                              onClick={() => getDealInsights(deal.id)}
                              disabled={isLoadingAI}
                              className="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                            >
                              <BrainIcon size={16} />
                              <span>{isLoadingAI ? 'AI...' : 'AI Analyse'}</span>
                            </button>
                            
                            <button
                              onClick={() => openCommissionEditor(deal)}
                              className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2"
                            >
                              <PercentIcon size={16} />
                              <span>Commissie</span>
                            </button>
                          </div>

                          {(user.role === 'beheerder' || deal.owner_id === user.id) && (
                            <div className="flex space-x-2">
                              <button
                                onClick={() => handleEditDeal(deal)}
                                className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                              >
                                <EditIcon size={16} />
                                <span>Bewerken</span>
                              </button>
                              <button
                                onClick={() => handleDeleteDeal(deal.id)}
                                className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                              >
                                <TrashIcon size={16} />
                                <span>Verwijderen</span>
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {activeTab === 'matching' && (
                <div>
                  <div className="mb-6">
                    <h2 className="text-2xl font-bold mb-4">🔥 Enhanced AI-Powered Matching</h2>
                    
                    {matches.length === 0 ? (
                      <div className="text-center py-12">
                        <AlertCircleIcon size={48} className="text-gray-400 mx-auto mb-4" />
                        <div className="space-y-2">
                          <p className="text-gray-600 text-lg">Selecteer een deal om enhanced AI-powered matches te vinden</p>
                          <p className="text-sm text-gray-500">
                            🔥 Enhanced Features: Semantic matching van beschrijvingen, vrije tekst analyse, conflict detectie
                          </p>
                        </div>
                      </div>
                    ) : (
                      <div>
                        <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
                          <h4 className="font-semibold text-purple-800 mb-3">🔥 Enhanced AI Matching Features:</h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-purple-700">
                            <div className="space-y-2">
                              <p>• 🗺️ Vereenvoudigde locatie matching</p>
                              <p>• 🤖 Semantic text analyse van beschrijvingen</p>
                              <p>• 💬 Vrije tekst input matching</p>
                              <p>• ⚠️ Conflict detectie tussen wensen en aanbod</p>
                            </div>
                            <div className="space-y-2">
                              <p>• 🎯 Intelligente keyword matching</p>
                              <p>• 📝 Investment motivatie vs deal beschrijving</p>
                              <p>• 🚀 Enhanced compatibility scoring</p>
                              <p>• 💰 Flexibele commissie structuren</p>
                            </div>
                          </div>
                        </div>

                        <div className="bg-blue-50 p-6 rounded-lg mb-6">
                          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center">
                            <div className="mb-4 lg:mb-0">
                              <h3 className="font-semibold text-lg mb-2">🎯 Deal: {matches[0].deal.titel}</h3>
                              <p className="text-sm text-gray-600 mb-2">{matches[0].deal.beschrijving}</p>
                              {matches[0].deal.bijzonderheden && (
                                <p className="text-sm text-purple-600 mb-2">🔥 {matches[0].deal.bijzonderheden}</p>
                              )}
                              <div className="flex flex-wrap items-center gap-4 text-sm">
                                <span className="text-blue-600 font-medium">Deal eigenaar: {getUserById(matches[0].deal.owner_id).name}</span>
                                {matches[0].deal.bedrijfFonds && (
                                  <span className="text-gray-600">Bedrijf/Fonds: {matches[0].deal.bedrijfFonds}</span>
                                )}
                                <span className="text-gray-600">Type: {matches[0].deal.type}</span>
                                <span className="text-gray-600">Project: {matches[0].deal.projectType}</span>
                              </div>
                            </div>
                            <div className="text-center lg:text-right">
                              <div className="text-3xl font-bold text-blue-600">{matches.length}</div>
                              <div className="text-sm text-gray-600">Enhanced Matches</div>
                            </div>
                          </div>
                        </div>

                        <div className="space-y-6">
                          {matches.map((match, index) => (
                            <div key={match.investor.id} className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                              <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4">
                                <div className="flex items-center space-x-4 mb-4 lg:mb-0">
                                  <div className="flex items-center space-x-2">
                                    <span className={`text-2xl font-bold ${
                                      index === 0 ? 'text-yellow-500' : 
                                      index === 1 ? 'text-gray-400' : 
                                      index === 2 ? 'text-orange-400' : 'text-gray-600'
                                    }`}>
                                      #{index + 1}
                                    </span>
                                    <div>
                                      <h3 className="text-xl font-semibold">{match.investor.naam}</h3>
                                      <p className="text-sm text-gray-600">{match.investor.bedrijf}</p>
                                    </div>
                                  </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                  <span className={`px-4 py-2 rounded-full text-lg font-bold ${getMatchColor(match.matchScore)}`}>
                                    {match.matchScore}% match
                                  </span>
                                  {match.semanticScore > 0 && (
                                    <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                                      🔥 +{match.semanticScore} semantic
                                    </span>
                                  )}
                                  <button
                                    onClick={() => createTransaction(match.deal.id, match.investor.id)}
                                    className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
                                  >
                                    <DollarSignIcon size={16} />
                                    <span>Start Deal</span>
                                  </button>
                                </div>
                              </div>

                              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                  <h4 className="font-semibold mb-3">🔥 Enhanced Match Analyse:</h4>
                                  <div className="space-y-2">
                                    {match.reasoning.map((reason, idx) => (
                                      <div key={idx} className="text-sm p-2 bg-gray-50 rounded">
                                        {reason}
                                      </div>
                                    ))}
                                    {match.semanticReasons && match.semanticReasons.length > 0 && (
                                      <div className="mt-3">
                                        <p className="text-sm font-medium text-purple-700 mb-2">🤖 Semantic Matches:</p>
                                        {match.semanticReasons.map((reason, idx) => (
                                          <div key={idx} className="text-sm p-2 bg-purple-50 rounded border border-purple-200">
                                            {reason}
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                </div>
                                <div>
                                  <h4 className="font-semibold mb-3">Investeerder Details:</h4>
                                  <div className="space-y-2 text-sm">
                                    {match.investor.bedrijf && <p>Bedrijf: {match.investor.bedrijf}</p>}
                                    <p>Budget: €{match.investor.minBudget.toLocaleString()} - €{match.investor.maxBudget.toLocaleString()}</p>
                                    <p>Gewenst rendement: {match.investor.gewenstRendement}%</p>
                                    <p>Risicoprofiel: {match.investor.risicoprofiel}</p>
                                    <p>Ervaring: {match.investor.ervaringLevel}</p>
                                    <p>Beschikbaarheid: {match.investor.beschikbaarheid}</p>
                                    {match.investor.locatieDetails && (
                                      <div className="mt-2 p-2 bg-blue-50 rounded border border-blue-200">
                                        <p className="font-medium text-blue-800">Locatie Details:</p>
                                        <p className="text-blue-700">{match.investor.locatieDetails}</p>
                                      </div>
                                    )}
                                    {match.investor.investmentMotivatie && (
                                      <div className="mt-2 p-2 bg-green-50 rounded border border-green-200">
                                        <p className="font-medium text-green-800">Investment Motivatie:</p>
                                        <p className="text-green-700">{match.investor.investmentMotivatie}</p>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>

                              <div className="mt-6 flex flex-wrap gap-2">
                                <button
                                  onClick={() => getSmartMatchingInsights(match.deal.id, match.investor.id)}
                                  disabled={isLoadingAI}
                                  className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center space-x-2"
                                >
                                  <BrainIcon size={16} />
                                  <span>{isLoadingAI ? 'AI Analyseert...' : '🔥 Enhanced AI Analyse'}</span>
                                </button>
                                <button
                                  onClick={() => alert(`Contacteer ${match.investor.naam} via ${match.investor.communicatieVoorkeur.toLowerCase()}: ${match.investor.email}`)}
                                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2"
                                >
                                  <MailIcon size={16} />
                                  <span>Contact</span>
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {activeTab === 'transactions' && (
                <div>
                  <div className="mb-6">
                    <h2 className="text-2xl font-bold mb-4">Transacties & Commissies</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                      <div className="bg-white p-4 rounded-lg shadow border">
                        <h3 className="font-semibold text-gray-700">Totale Commissie</h3>
                        <p className="text-2xl font-bold text-green-600">
                          €{calculateCommissionSummary().totalCommission.toLocaleString()}
                        </p>
                      </div>
                      <div className="bg-white p-4 rounded-lg shadow border">
                        <h3 className="font-semibold text-gray-700">Afgeronde Deals</h3>
                        <p className="text-2xl font-bold text-blue-600">
                          {calculateCommissionSummary().completedTransactions}
                        </p>
                      </div>
                      <div className="bg-white p-4 rounded-lg shadow border">
                        <h3 className="font-semibold text-gray-700">Pending Deals</h3>
                        <p className="text-2xl font-bold text-yellow-600">
                          {calculateCommissionSummary().pendingTransactions}
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="space-y-6">
                    {transactions.map(transaction => {
                      const deal = deals.find(d => d.id === transaction.deal_id);
                      const investor = investors.find(i => i.id === transaction.investor_id);
                      
                      let participantCommissions = [];
                      try {
                        participantCommissions = transaction.participant_commissions ? 
                          JSON.parse(transaction.participant_commissions) : [];
                      } catch (e) {
                        console.error('Error parsing participant commissions:', e);
                      }

                      return (
                        <div key={transaction.id} className="bg-white rounded-lg shadow-md p-6 border">
                          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4">
                            <div>
                              <h3 className="text-xl font-semibold mb-2">
                                {deal?.titel || 'Onbekende Deal'}
                              </h3>
                              <div className="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                                <span>Investeerder: {investor?.naam || 'Onbekend'}</span>
                                <span>Waarde: €{transaction.transaction_amount.toLocaleString()}</span>
                                <span>Commissie: €{transaction.total_commission.toLocaleString()}</span>
                              </div>
                            </div>
                            <div className="mt-4 lg:mt-0">
                              <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                transaction.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                              }`}>
                                {transaction.status === 'completed' ? 'Afgerond' : 'Pending'}
                              </span>
                            </div>
                          </div>

                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                              <h4 className="font-semibold mb-3">Deal Details:</h4>
                              <div className="space-y-2 text-sm">
                                {deal?.bedrijfFonds && <p>Bedrijf/Fonds: {deal.bedrijfFonds}</p>}
                                <p>Locatie: {deal?.locatie || 'Onbekend'}</p>
                                <p>Type: {deal?.type || 'Onbekend'}</p>
                                <p>Project: {deal?.projectType || 'Onbekend'}</p>
                                <p>Verwacht rendement: {deal?.verwachtRendement || 0}%</p>
                              </div>
                            </div>
                            <div>
                              <h4 className="font-semibold mb-3">Commissie Verdeling:</h4>
                              <div className="space-y-2">
                                {participantCommissions.map((participant, index) => {
                                  const userName = participant.is_external 
                                    ? participant.name 
                                    : getUserById(participant.user_id).name;
                                  
                                  return (
                                    <div key={index} className="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                                      <span className="flex items-center space-x-2">
                                        <span>{userName} ({participant.role})</span>
                                        {participant.is_external && (
                                          <span className="px-1 py-0.5 bg-green-100 text-green-800 text-xs rounded">
                                            Extern
                                          </span>
                                        )}
                                      </span>
                                      <span className="font-semibold">
                                        €{participant.commission_amount.toLocaleString()}
                                      </span>
                                    </div>
                                  );
                                })}
                              </div>
                              
                              {participantCommissions.some(p => p.is_external) && (
                                <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded">
                                  <h5 className="font-medium text-green-800 mb-2">Externe Partners:</h5>
                                  <div className="space-y-2 text-sm">
                                    {participantCommissions
                                      .filter(p => p.is_external)
                                      .map((participant, index) => (
                                        <div key={index} className="flex flex-col space-y-1">
                                          <span className="font-medium">{participant.name}</span>
                                          {participant.email && (
                                            <span className="text-gray-600">📧 {participant.email}</span>
                                          )}
                                          {participant.company && (
                                            <span className="text-gray-600">🏢 {participant.company}</span>
                                          )}
                                        </div>
                                      ))
                                    }
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              {Object.keys(aiInsights).length > 0 && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div className="sticky top-0 bg-white border-b p-6 flex justify-between items-center">
                      <h4 className="text-xl font-bold flex items-center space-x-2">
                        <BrainIcon size={20} />
                        <span>🔥 Enhanced AI Analyse</span>
                      </h4>
                      <button
                        onClick={() => setAiInsights({})}
                        className="text-gray-400 hover:text-gray-600 text-xl"
                      >
                        ✕
                      </button>
                    </div>
                    <div className="p-6">
                      {Object.entries(aiInsights).slice(-1).map(([key, insight]) => (
                        <div key={key} className="space-y-6">
                          <div className="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-lg border border-purple-200">
                            <h3 className="font-bold text-lg mb-2 text-purple-900">
                              {key.includes('enhanced_match') ? '🔥 Enhanced Smart Match Analyse' :
                              key.includes('investor') ? '👤 Investeerder Analyse' :
                              key.includes('deal') ? '🏢 Deal Analyse' :
                              '📊 Markt Inzichten'}
                            </h3>
                            <p className="text-sm text-purple-700">
                              Gegenereerd op {new Date().toLocaleString('nl-NL')} | Enhanced met semantic analysis
                            </p>
                          </div>
                          
                          {typeof insight === 'object' && insight.semanticScore !== undefined ? (
                            <div className="space-y-4">
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                <h4 className="font-semibold text-purple-800 mb-3">🔥 Enhanced Semantic Analysis:</h4>
                                {insight.semanticReasons && insight.semanticReasons.map((reason, idx) => (
                                  <div key={idx} className="bg-white p-3 rounded border border-purple-200 mb-2">
                                    <p className="text-purple-700">{reason}</p>
                                  </div>
                                ))}
                                <div className="mt-3 p-3 bg-white rounded border border-purple-300">
                                  <p className="font-medium text-purple-900">
                                    Semantic Score: <span className="text-2xl">{insight.semanticScore || 0}</span> punten
                                  </p>
                                  <p className="text-purple-700 text-sm">
                                    Based on AI analysis of investment motivatie vs deal beschrijving
                                  </p>
                                </div>
                              </div>
                              
                              {insight.pitchRecommendations && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                  <h4 className="font-semibold text-green-800 mb-3">💡 Pitch Aanbevelingen:</h4>
                                  <ul className="space-y-2">
                                    {insight.pitchRecommendations.map((rec, idx) => (
                                      <li key={idx} className="flex items-start space-x-2">
                                        <span className="text-green-600 font-bold">•</span>
                                        <span className="text-green-700">{rec}</span>
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {insight.overallCompatibility && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                  <h4 className="font-semibold text-blue-800 mb-3">📈 Overall Compatibility:</h4>
                                  <div className="flex items-center space-x-4">
                                    <div className="text-3xl font-bold text-blue-600">
                                      {insight.overallCompatibility}%
                                    </div>
                                    <div className="flex-1">
                                      <div className="w-full bg-gray-200 rounded-full h-3">
                                        <div 
                                          className="bg-blue-600 h-3 rounded-full transition-all duration-500"
                                          style={{ width: `${insight.overallCompatibility}%` }}
                                        ></div>
                                      </div>
                                      <p className="text-blue-700 text-sm mt-1">
                                        Enhanced score including semantic matching
                                      </p>
                                    </div>
                                  </div>
                                </div>
                              )}
                            </div>
                          ) : typeof insight === 'object' && insight.fullAnalysis ? (
                            <div className="space-y-4">
                              <div className="bg-white border rounded-lg p-4">
                                <h4 className="font-semibold text-gray-800 mb-3">🤖 AI Analyse:</h4>
                                <div className="prose prose-sm max-w-none">
                                  {insight.fullAnalysis.split('\n').map((line, idx) => (
                                    <p key={idx} className="mb-2 text-gray-700 leading-relaxed">
                                      {line}
                                    </p>
                                  ))}
                                </div>
                              </div>
                              
                              {insight.aiRecommendations && (
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                  <h4 className="font-semibold text-green-800 mb-3">💡 Aanbevelingen:</h4>
                                  <ul className="space-y-2">
                                    {insight.aiRecommendations.map((rec, idx) => (
                                      <li key={idx} className="flex items-start space-x-2">
                                        <span className="text-green-600 font-bold">•</span>
                                        <span className="text-green-700">{rec}</span>
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                            </div>
                          ) : (
                            <div className="bg-gray-50 border rounded-lg p-4">
                              <p className="text-gray-700">
                                {typeof insight === 'string' ? insight : JSON.stringify(insight, null, 2)}
                              </p>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                    <div className="sticky bottom-0 bg-white border-t p-4 flex justify-between items-center">
                      <div className="text-sm text-gray-500">
                        🔥 Enhanced: Analyse includes semantic matching van teksten en beschrijvingen
                      </div>
                      <button
                        onClick={() => setAiInsights({})}
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                      >
                        Sluiten
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showAddInvestor && (
                <InvestorForm
                  onSubmit={handleAddInvestor}
                  onCancel={() => setShowAddInvestor(false)}
                />
              )}

              {showEditInvestor && editingInvestor && (
                <InvestorForm
                  editData={editingInvestor}
                  onSubmit={handleUpdateInvestor}
                  onCancel={() => {
                    setShowEditInvestor(false);
                    setEditingInvestor(null);
                  }}
                />
              )}

              {showAddDeal && (
                <DealForm
                  onSubmit={handleAddDeal}
                  onCancel={() => setShowAddDeal(false)}
                />
              )}

              {showEditDeal && editingDeal && (
                <DealForm
                  editData={editingDeal}
                  onSubmit={handleUpdateDeal}
                  onCancel={() => {
                    setShowEditDeal(false);
                    setEditingDeal(null);
                  }}
                />
              )}

              {showAddBroker && (
                <BrokerForm
                  onSubmit={handleAddBroker}
                  onCancel={() => setShowAddBroker(false)}
                />
              )}

              {showEditBroker && editingBroker && (
                <BrokerForm
                  editData={editingBroker}
                  onSubmit={handleUpdateBroker}
                  onCancel={() => {
                    setShowEditBroker(false);
                    setEditingBroker(null);
                  }}
                />
              )}

              <CommissionEditor />
            </div>
          );
        };

        // Initialize the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(VastgoedInvesteerderMatcher));

        console.log('🚀 Vastgoed Matcher Pro AI - Enhanced Semantic + Broker Versie geladen!');
        console.log('🔥 Firebase Authentication & Database geïntegreerd');
        console.log('🔥 NIEUWE ENHANCED FEATURES:');
        console.log('   • 🏢 BROKER MANAGEMENT IN CONTACTEN TAB');
        console.log('     - Unified contacten interface voor investeerders én brokers');
        console.log('     - Broker-specifieke velden: specialisaties, werkgebied, track record');
        console.log('     - Enhanced AI classificatie voor broker detection');
        console.log('     - Aparte database collection voor brokers');
        console.log('     - Filter functionaliteit: Alle / Investeerders / Brokers');
        console.log('   • 🗺️ VEREENVOUDIGDE LOCATIE INVOER');
        console.log('     - Minder dropdowns, meer vrije tekst input');
        console.log('     - Hoofdlanden selectie in plaats van 150+ steden');
        console.log('     - Vrije tekst veld voor specifieke locatie eisen');
        console.log('   • 🤖 AI SEMANTIC MATCHING');
        console.log('     - AI matcht investment motivatie vs deal beschrijving');
        console.log('     - Keyword matching: "stabiele huurinkomsten" ↔ "gegarandeerde huurder"');
        console.log('     - Conflict detectie: "geen renovatie" vs "renovatie project"');
        console.log('     - Enhanced compatibility scoring met semantic analyse');
        console.log('   • 💬 VRIJE TEKST INPUT FIELDS:');
        console.log('     - Investeerder: locatieDetails, investmentMotivatie, bijzonderheden');
        console.log('     - Broker: trackRecord, werkwijze, locatieDetails, bijzonderheden');
        console.log('     - Deal: bijzonderheden veld voor extra deal details');
        console.log('     - AI gebruikt deze teksten voor slimme matching');
        console.log('   • 🎯 ENHANCED MATCHING ALGORITHM:');
        console.log('     - Traditional scoring (budget, locatie, type) = 70%');
        console.log('     - NEW: Semantic matching van teksten = 30%');
        console.log('     - Conflict detectie tussen wensen en aanbod');
        console.log('     - Intelligente keyword matching');
        console.log('💰 Commissie Management behouden:');
        console.log('   • ✅ Per deal aanpasbare commissie rate');
        console.log('   • ✅ Meerdere deelnemers per deal');
        console.log('   • ✅ Externe partners met contactinfo');
        console.log('   • ✅ Percentage en vast bedrag combinaties');
        console.log('✏️ Edit Features behouden:');
        console.log('   • ✅ Investeerders én brokers bewerken en verwijderen');
        console.log('   • ✅ Deals bewerken en verwijderen');
        console.log('   • ✅ Real-time updates tussen teamleden');
        console.log('🌍 Alle andere features behouden:');
        console.log('   • ✅ AI-powered matching (enhanced!)');
        console.log('   • ✅ Team collaboration via Firebase');
        console.log('   • ✅ Transactie management');
        console.log('   • ✅ Commission tracking');
        console.log('📊 VERBETERDE USER EXPERIENCE:');
        console.log('   • Unified contact management voor investeerders en brokers');
        console.log('   • Smart filtering en categorisatie');
        console.log('   • Snellere data invoer door minder dropdowns');
        console.log('   • Genuanceerdere voorkeuren door vrije tekst');
        console.log('   • Betere matches door AI semantic analysis');
        console.log('   • Duidelijke feedback over waarom deals matchen');
        console.log('🔥 DEMO DATA ENHANCED:');
        console.log('   • Demo investeerder met uitgebreide motivatie tekst');
        console.log('   • Demo broker met professioneel profiel');
        console.log('   • Demo deal heeft gedetailleerde beschrijving');
        console.log('   • Toont semantic matching in actie');
        console.log('   • AI detecteert "stabiele huurinkomsten" ↔ "gegarandeerde huurder"');
        console.log('🏢 BROKER FEATURES:');
        console.log('   • Specialisaties tracking (Commercieel, Retail, etc.)');
        console.log('   • Werkgebied definitie en filtering');
        console.log('   • Track record en ervaring logging');
        console.log('   • Commissie structuur documentatie');
        console.log('   • Werkwijze en approach beschrijving');
        console.log('   • Visual distinction: groene accent kleur voor brokers');
    </script>

<!-- 🔽 CSV Upload & Preview Component -->
<div id="csv-upload-section" class="p-4 border-t border-gray-300 mt-6">
  <h2 class="text-xl font-semibold mb-4">Contacten Uploaden via CSV</h2>
  <input type="file" id="csvFileInput" accept=".csv" class="mb-4" />
  <div id="csvPreview" class="overflow-x-auto text-sm"></div>
  <button id="uploadToFirestore" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Upload naar Firestore</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script type="text/javascript">
  const csvFileInput = document.getElementById('csvFileInput');
  const csvPreview = document.getElementById('csvPreview');
  const uploadButton = document.getElementById('uploadToFirestore');

  let parsedData = [];
  let userId = null;

  firebase.auth().onAuthStateChanged(user => {
    if (user) userId = user.uid;
  });

  csvFileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        parsedData = results.data.map(row => ({
          firstName: row['First Name'],
          lastName: row['Last Name'],
          linkedin: row['URL'],
          email: row['Email Address'],
          company: row['Company'],
          position: row['Position'],
          contactType: 'investor'
        }));

        renderPreview(parsedData);
      }
    });
  });

  function renderPreview(data) {
    const html = data.slice(0, 5).map((item, idx) => `
      <div class="p-2 border-b">
        <strong>${item.firstName} ${item.lastName}</strong> – ${item.position || ''} @ ${item.company || ''}
        <div class="text-xs text-gray-500">${item.email || ''} | ${item.linkedin || ''}</div>
        <label class="block text-sm mt-2">Classificatie:
          <select onchange="parsedData[${idx}].contactType = this.value" class="ml-2 border p-1 rounded">
            <option value="investor">Investor</option>
            <option value="broker">Broker</option>
            <option value="both">Beiden</option>
          </select>
        </label>
      </div>
    `).join('');
    csvPreview.innerHTML = html;
  }

  uploadButton.addEventListener('click', async () => {
    if (!userId || parsedData.length === 0) {
      alert('Geen gebruiker ingelogd of geen data beschikbaar.');
      return;
    }

    try {
      const batch = firebase.firestore().batch();
      const contactsRef = firebase.firestore().collection('contacts');

      parsedData.forEach(contact => {
        const docRef = contactsRef.doc();
        batch.set(docRef, {
          ...contact,
          owner_id: userId,
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      await batch.commit();
      alert('✅ Contacten succesvol geüpload!');
    } catch (err) {
      console.error('❌ Fout bij upload:', err);
      alert('Fout bij upload: ' + err.message);
    }
  });
</script>


<script>
async function findMatchesForDeal(dealText) {
  const user = firebase.auth().currentUser;
  if (!user) {
    alert("Je moet ingelogd zijn om te matchen.");
    return;
  }

  const db = firebase.firestore();
  const investorsSnapshot = await db.collection("investors").where("owner_id", "==", user.uid).get();
  const brokersSnapshot = await db.collection("brokers").where("owner_id", "==", user.uid).get();

  const investors = investorsSnapshot.docs.map(doc => doc.data());
  const brokers = brokersSnapshot.docs.map(doc => doc.data());

  const data = {
    investors: investors.concat(brokers)
  };

  const response = await fetch('/.netlify/functions/openai-chat', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      prompt: `Geef een topselectie van de meest relevante investeerders of makelaars voor de volgende vastgoeddeal:

"${dealText}"`,
      type: 'smart_matching',
      data: data
    })
  });

  const result = await response.json();
  const matchResults = result?.data;

  const container = document.getElementById("matchResults");
  container.innerHTML = "";

  if (!matchResults || !matchResults.aiRecommendations) {
    container.innerHTML = "<p>❌ Geen AI-matches gevonden.</p>";
    return;
  }

  container.innerHTML = "<h4>📌 Top AI-matches:</h4>";
  matchResults.aiRecommendations.slice(0, 15).forEach((rec, index) => {
    const div = document.createElement("div");
    div.className = "border p-2 my-2 bg-gray-50 rounded";
    div.innerHTML = `<b>#${index + 1} — Matchscore: ${matchResults.matchScore + index % 10}</b><br>${rec}`;
    container.appendChild(div);
  });

  if (matchResults.aiRecommendations.length > 15) {
    const btn = document.createElement("button");
    btn.textContent = "📈 Toon meer matches";
    btn.className = "mt-2 px-3 py-1 bg-blue-600 text-white rounded";
    btn.onclick = () => {
      container.innerHTML += "<hr><h4>🔁 Extra matches:</h4>";
      matchResults.aiRecommendations.slice(15).forEach((rec, index) => {
        const div = document.createElement("div");
        div.className = "border p-2 my-2 bg-white rounded";
        div.innerHTML = `<b>Extra #${index + 1}</b><br>${rec}`;
        container.appendChild(div);
      });
      btn.remove();
    };
    container.appendChild(btn);
  }
}
</script>


<div class="mt-10 p-4 bg-gray-100 rounded shadow">
  <h3 class="text-lg font-semibold mb-2">🤝 AI-matching voor deals</h3>
  <textarea id="dealInput" rows="4" class="w-full border p-2 rounded" placeholder="Plak hier je vastgoeddeal beschrijving..."></textarea>
  <button onclick="findMatchesForDeal(document.getElementById('dealInput').value)" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">🔍 Vind investeerders/brokers</button>
  <div id="matchResults" class="mt-4 text-sm text-gray-800"></div>
</div>

</body>
</html>
