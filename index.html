<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vastgoed Matcher Pro AI - Enhanced</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <!-- PapaParse voor CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* Hide legacy upload UI */
        #csvFileInput,
        #uploadToFirestore,
        #uploadBtn,
        #csv-upload-section {
            display: none !important;
        }
        
        /* LinkedIn button styles */
        .vm-linkedin-btn {
            display: inline-flex;
            align-items: center;
            gap: .5rem;
            padding: .5rem .75rem;
            border-radius: .5rem;
            border: 1px solid #d1d5db;
        }
        .vm-linkedin-btn:hover {
            background: #f3f4f6;
        }
        
        /* Loading animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <!-- Firebase Configuration -->
    <script>
        // JOUW ECHTE FIREBASE CONFIGURATIE
        const firebaseConfig = {
            apiKey: "AIzaSyD5daKmpLUMcxmOiAXkPkmiJrZ5kDG3HMo",
            authDomain: "vastgoed-matcher-mvp.firebaseapp.com",
            projectId: "vastgoed-matcher-mvp",
            storageBucket: "vastgoed-matcher-mvp.appspot.com",
            messagingSenderId: "785479169064",
            appId: "1:785479169064:web:eb328415e1277241df311d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Initialize services
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        console.log('üî• Firebase initialized successfully!');
    </script>

    <script type="text/babel">
        // Main application component
        const VastgoedInvesteerderMatcher = () => {
            const [user, setUser] = React.useState(null);
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [investors, setInvestors] = React.useState([]);
            const [deals, setDeals] = React.useState([]);
            const [transactions, setTransactions] = React.useState([]);
            const [users, setUsers] = React.useState([]);
            const [matches, setMatches] = React.useState([]);
            const [showAddInvestor, setShowAddInvestor] = React.useState(false);
            const [showAddDeal, setShowAddDeal] = React.useState(false);
            const [showAuth, setShowAuth] = React.useState(true);
            const [aiInsights, setAiInsights] = React.useState({});
            const [isLoadingAI, setIsLoadingAI] = React.useState(false);
            
            const [showCommissionEditor, setShowCommissionEditor] = React.useState(false);
            const [editingDealCommission, setEditingDealCommission] = React.useState(null);
            const [currentTransaction, setCurrentTransaction] = React.useState(null);

            const [editingInvestor, setEditingInvestor] = React.useState(null);
            const [editingDeal, setEditingDeal] = React.useState(null);
            const [showEditInvestor, setShowEditInvestor] = React.useState(false);
            const [showEditDeal, setShowEditDeal] = React.useState(false);

            // üî• NEW: Broker Management State
            const [brokers, setBrokers] = React.useState([]);
            const [showAddBroker, setShowAddBroker] = React.useState(false);
            const [editingBroker, setEditingBroker] = React.useState(null);
            const [showEditBroker, setShowEditBroker] = React.useState(false);
            const [contactFilter, setContactFilter] = React.useState('all'); // all, investors, brokers

            // üî• CSV Upload State
            const [csvData, setCsvData] = React.useState([]);
            const [uploadProgress, setUploadProgress] = React.useState('');
            const [contactsCount, setContactsCount] = React.useState(0);

            // üî• ENHANCED AI MATCHING WITH SEMANTIC ANALYSIS
            const callOpenAI = async (prompt, type = 'analysis', data = null) => {
                setIsLoadingAI(true);
                
                try {
                    const response = await fetch('/.netlify/functions/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, type, data })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        setIsLoadingAI(false);
                        return result.data;
                    }
                } catch (error) {
                    console.log('OpenAI API niet beschikbaar, gebruik demo data:', error);
                }
                
                // Enhanced fallback with semantic matching simulation
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const mockResponses = {
                    enhanced_matching: {
                        semanticScore: 85,
                        semanticReasons: [
                            'Sterke match: "stabiele huurinkomsten" ‚Üî "gegarandeerde huurder 5 jaar"',
                            'Perfecte match: "geen renovatie" ‚Üî "turn-key appartement"', 
                            'Goede match: "duurzaamheid belangrijk" ‚Üî "energielabel A"',
                            'Match: "ervaring met appartementen" ‚Üî "luxe appartement complex"'
                        ],
                        conflictAnalysis: [],
                        overallCompatibility: 92,
                        pitchRecommendations: [
                            'Benadruk de gegarandeerde huurinkomsten van 5 jaar',
                            'Vermeld turn-key voordeel: direct rendement zonder werk',
                            'Highlight duurzaamheid: energielabel A en lage kosten',
                            'Toon vergelijkbare succesvolle projecten in portfolio'
                        ]
                    },
                    investor_analysis: {
                        financialStrength: 'Hoog - Stabiele inkomstenbron via vastgoedbeleggingen',
                        riskAppetite: 'Gemiddeld tot hoog - Ervaren investeerder met diversified portfolio',
                        marketKnowledge: 'Goed - Actief in Nederlandse vastgoedmarkt sinds 2015',
                        preferredSectors: ['Residentieel', 'Commercieel retail'],
                        projectTypePreference: ['Turn-key', 'Renovatie'],
                        investmentStrategy: 'Buy-and-hold met focus on cashflow generatie',
                        recommendations: 'Geschikt voor deals met stabiele huurinkomsten en potentieel voor waardestijging',
                        behaviorProfile: 'Voorzichtige beslisser, graag veel informatie vooraf',
                        investmentTimeline: 'Zoekt deals voor Q2-Q3 2024',
                        marketSentiment: 'Positief over vastgoedmarkt, maar voorzichtig met nieuwe projecten'
                    },
                    deal_analysis: {
                        marketPosition: 'Aantrekkelijk - Locatie in groeiende wijk met goede bereikbaarheid',
                        projectTypeAnalysis: 'Turn-key voordeel: Direct rendement, lagere ontwikkelingsrisico\'s',
                        competitiveAnalysis: 'Vergelijkbare panden in de buurt hebben 5-7% rendement',
                        riskFactors: [
                            'Mogelijke leegstand bij huurwisseling', 
                            'Onderhoudskosten oudere panden',
                            'Marktvolatiliteit in de regio'
                        ],
                        opportunities: [
                            'Huurverhoging mogelijk door renovatie', 
                            'Waardestijging door buurtverbetering',
                            'Turn-key voordeel: Direct rendement, lagere ontwikkelingsrisico\'s',
                            'Renovatie kansen: Waardecreatie door modernisering',
                            'Transformatie potentieel: Functiewijziging verhoogt marktwaarde'
                        ],
                        priceAnalysis: 'Marktconform geprijsd, kleine onderhandelingsruimte',
                        recommendation: 'Aanbevolen voor conservatieve tot gemiddelde risico investeerders',
                        marketTrends: 'Prijzen in dit gebied stijgen 3-5% per jaar',
                        demographicAnalysis: 'Populair bij young professionals en small families',
                        futureOutlook: 'Positieve ontwikkeling verwacht door infrastructuurprojecten'
                    }
                };

                setIsLoadingAI(false);
                
                if (type === 'enhanced_matching') return mockResponses.enhanced_matching;
                if (type === 'investor_analysis') return mockResponses.investor_analysis;
                if (type === 'deal_analysis') return mockResponses.deal_analysis;
                
                return mockResponses.enhanced_matching;
            };

            // FIREBASE DATABASE FUNCTIES
            const loadData = async () => {
                if (!user) return;
                
                try {
                    console.log('üìä Loading data from Firebase...');
                    
                    const usersSnapshot = await db.collection('users').get();
                    const usersData = usersSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setUsers(usersData);
                    
                    const investorsSnapshot = await db.collection('investors').get();
                    const investorsData = investorsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setInvestors(investorsData);

                    // üî• NEW: Load brokers
                    const brokersSnapshot = await db.collection('brokers').get();
                    const brokersData = brokersSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setBrokers(brokersData);
                    
                    const dealsSnapshot = await db.collection('deals').get();
                    const dealsData = dealsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setDeals(dealsData);
                    
                    const transactionsSnapshot = await db.collection('transactions').get();
                    const transactionsData = transactionsSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setTransactions(transactionsData);
                    
                    console.log('‚úÖ Data loaded from Firebase:', {
                        users: usersData.length,
                        investors: investorsData.length,
                        brokers: brokersData.length,
                        deals: dealsData.length,
                        transactions: transactionsData.length
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error loading data from Firebase:', error);
                    console.log('üìã Loading demo data as fallback...');
                    await loadDemoData();
                }
            };

            const loadDemoData = async () => {
                console.log('üé≠ Loading demo data...');
                
                const demoUsers = [
                    { id: user.id, name: user.name, email: user.email, company: user.company, role: user.role || 'agent' }
                ];
                setUsers(demoUsers);
                
                const demoInvestors = [
                    {
                        id: 'demo1',
                        naam: 'Peter van der Berg',
                        email: 'peter@example.com',
                        telefoon: '06-12345678',
                        bedrijf: 'Berg Investments',
                        locatie: 'Amsterdam',
                        minBudget: 100000,
                        maxBudget: 500000,
                        // üî• SIMPLIFIED LOCATION FIELDS
                        voorkeursLanden: ['Nederland', 'Duitsland'],
                        voorkeursRegio: ['West-Europa'],
                        locatieDetails: 'Amsterdam centrum bij de ring, nabij openbaar vervoer. Liever geen Zuidoost of Noord.',
                        vastgoedTypes: ['Appartement', 'Kantoor'],
                        projectTypes: ['Turn-key', 'Renovatie'],
                        risicoprofiel: 'Gemiddeld',
                        gewenstRendement: 6,
                        investeringshorizon: 'Lang termijn',
                        ervaringLevel: 'Ervaren',
                        beschikbaarheid: 'Direct',
                        communicatieVoorkeur: 'Telefoon',
                        // üî• ENHANCED WITH SEMANTIC CONTENT
                        investmentMotivatie: 'Zoek stabiele huurinkomsten voor pensioenopbouw. Geen renovatie projecten, liever turn-key appartementen. Ervaring met studentenhuisvesting. Duurzaamheid steeds belangrijker.',
                        bijzonderheden: 'Heeft voorkeur voor energiezuinige panden. Geen ground floor retail. Ervaring met vastgoedbeheer.',
                        owner_id: user.id,
                        created_at: new Date().toISOString()
                    }
                ];

                // üî• NEW: Demo Brokers
                const demoBrokers = [
                    {
                        id: 'broker1',
                        naam: 'Sarah de Vries',
                        email: 'sarah@vastgoedpro.nl',
                        telefoon: '020-7654321',
                        bedrijf: 'VastgoedPro Makelaars',
                        locatie: 'Amsterdam',
                        specialisaties: ['Commercieel', 'Kantoren', 'Retail'],
                        werkgebied: ['Amsterdam', 'Haarlem', 'Almere'],
                        ervaringJaren: 8,
                        trackRecord: 'Gespecialiseerd in commercieel vastgoed ‚Ç¨500K-‚Ç¨5M. 120+ deals afgelopen 5 jaar. Focus op kantoorpanden en retail.',
                        commissieStructuur: '2.5% koper, 2.5% verkoper. Exclusieve deals 3%.',
                        locatieDetails: 'Actief in Randstad, specialiteit Amsterdam Noord en Zuidas.',
                        werkwijze: 'Proactieve deal sourcing, uitgebreid netwerk van investeerders. Snelle besluitvorming, transparante communicatie.',
                        bijzonderheden: 'Spreekt vloeiend Engels en Duits. Ervaring met internationale investeerders. RICS gecertificeerd.',
                        import_source: 'manual',
                        owner_id: user.id,
                        created_at: new Date().toISOString()
                    }
                ];
                
                const demoDeals = [
                    {
                        id: 'demo1',
                        titel: 'Modern Appartement Amsterdam',
                        locatie: 'Amsterdam',
                        type: 'Appartement',
                        projectType: 'Turn-key',
                        prijs: 350000,
                        verwachtRendement: 5.5,
                        risico: 'Gemiddeld',
                        // üî• ENHANCED DESCRIPTION FOR SEMANTIC MATCHING  
                        beschrijving: 'Kant-en-klaar nieuwbouw appartement in opkomende wijk Noord. Energielabel A, zonnepanelen, warmtepomp. Gegarandeerde huurder voor 5 jaar via corporatie. Nabij metro, 15 min naar centrum. Turn-key: direct rendement, geen werk aan.',
                        oppervlakte: 85,
                        bouwjaar: 2020,
                        huurpotentie: 1800,
                        status: 'Beschikbaar',
                        bedrijfFonds: 'Demo Vastgoed B.V.',
                        bijzonderheden: 'Duurzaam gebouwd, lage servicekosten. Professioneel beheer beschikbaar. Uitstekende buurt met goede voorzieningen.',
                        contactpersoon: 'Maria Janssen',
                        telefoon: '020-1234567',
                        email: 'maria@demovastgoed.nl',
                        isRelevant: true,
                        ourScore: 8.5,
                        aiAnalyzed: false,
                        owner_id: user.id,
                        created_at: new Date().toISOString(),
                        commissionStructure: {
                            total_rate: 0.025,
                            participants: [
                                { 
                                    role: 'deal_owner', 
                                    user_id: user.id, 
                                    percentage: 60, 
                                    fixed_amount: 0, 
                                    type: 'percentage',
                                    name: user.name,
                                    is_external: false
                                }
                            ]
                        }
                    }
                ];
                
                setInvestors(demoInvestors);
                setBrokers(demoBrokers); // üî• NEW
                setDeals(demoDeals);
                setTransactions([]);
                
                try {
                    await saveDemoDataToFirebase(demoInvestors, demoBrokers, demoDeals);
                } catch (error) {
                    console.log('Could not save demo data to Firebase:', error);
                }
            };
            
            const saveDemoDataToFirebase = async (investors, brokers, deals) => {
                try {
                    for (const investor of investors) {
                        await db.collection('investors').doc(investor.id).set({
                            ...investor,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // üî• NEW: Save brokers
                    for (const broker of brokers) {
                        await db.collection('brokers').doc(broker.id).set({
                            ...broker,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    for (const deal of deals) {
                        await db.collection('deals').doc(deal.id).set({
                            ...deal,
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                    
                    console.log('‚úÖ Demo data saved to Firebase');
                } catch (error) {
                    console.error('‚ùå Error saving demo data:', error);
                }
            };

            const getUserById = (id) => {
                return users.find(u => u.id === id) || { name: 'Onbekend', email: '' };
            };

            // üî• WERKENDE LinkedIn CSV Parser - Speciaal voor LinkedIn Connections export
            const parseLinkedInCSV = (file, contactType = 'investor') => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const csvText = e.target.result;
                            console.log('üîç LinkedIn CSV parsing gestart...');
                            
                            const connections = [];
                            const lines = csvText.split('\n');
                            
                            for (let i = 0; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;
                                
                                console.log('üìù Originele regel:', line);
                                
                                // LinkedIn CSV specifiek formaat met ;; als separator
                                // Gebruik een betere splitsing die omgaat met gequote velden
                                const parts = [];
                                let currentPart = '';
                                let inQuotes = false;
                                
                                for (let j = 0; j < line.length; j++) {
                                    const char = line[j];
                                    const nextChar = line[j + 1];
                                    
                                    if (char === '"') {
                                        inQuotes = !inQuotes;
                                        currentPart += char;
                                    } else if (char === ';' && nextChar === ';' && !inQuotes) {
                                        // Dit is een scheidingsteken ;;
                                        parts.push(currentPart.trim());
                                        currentPart = '';
                                        j++; // Skip de volgende ;
                                    } else {
                                        currentPart += char;
                                    }
                                }
                                
                                // Voeg het laatste deel toe
                                if (currentPart.trim()) {
                                    parts.push(currentPart.trim());
                                }
                                
                                console.log('üîß Gesplitste delen:', parts);
                                
                                if (parts.length >= 6) {
                                    // Verwerk naam (kan "Voornaam, Achternaam" formaat hebben)
                                    let firstName = parts[0] ? parts[0].replace(/^"|"$/g, '').trim() : '';
                                    let lastName = parts[1] ? parts[1].replace(/^"|"$/g, '').trim() : '';
                                    
                                    // Als eerste deel een komma bevat, splits dan op komma voor naam
                                    if (firstName.includes(',') && !lastName) {
                                        const nameParts = firstName.split(',');
                                        firstName = nameParts[1]?.trim() || '';
                                        lastName = nameParts[0]?.trim() || '';
                                    }
                                    
                                    const url = parts[2] ? parts[2].replace(/^"|"$/g, '').trim() : '';
                                    const email = parts[3] ? parts[3].replace(/^"|"$/g, '').trim() : '';
                                    const company = parts[4] ? parts[4].replace(/^"|"$/g, '').trim() : '';
                                    const position = parts[5] ? parts[5].replace(/^"|"$/g, '').trim() : '';
                                    const connectedOn = parts[6] ? parts[6].replace(/^"|"$/g, '').trim() : '';
                                    
                                    if (firstName || lastName) {
                                        const connection = {
                                            firstName: firstName,
                                            lastName: lastName,
                                            email: email,
                                            company: company,
                                            position: position,
                                            linkedin: url,
                                            connectedOn: connectedOn,
                                            contactType: contactType,
                                            importSource: 'linkedin'
                                        };
                                        connections.push(connection);
                                        console.log('‚úÖ Toegevoegd:', connection);
                                    }
                                } else {
                                    console.log('‚ùå Rij heeft te weinig delen:', parts.length);
                                }
                            }
                            
                            console.log(`‚úÖ LinkedIn parsing voltooid: ${connections.length} connecties verwerkt`);
                            resolve(connections);
                            
                        } catch (error) {
                            console.error('‚ùå LinkedIn CSV parsing error:', error);
                            reject(error);
                        }
                    };
                    
                    reader.onerror = function() {
                        reject(new Error('Fout bij lezen van bestand'));
                    };
                    
                    reader.readAsText(file);
                });
            };

            // üî• DEBUG functie om CSV structuur te analyseren
            const debugCSVStructure = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const csvText = e.target.result;
                        console.log('üîç CSV Structuur Analyse:');
                        console.log('Totaal rijen:', csvText.split('\n').length);
                        
                        // Toon eerste 3 rijen voor analyse
                        const lines = csvText.split('\n');
                        for (let i = 0; i < Math.min(3, lines.length); i++) {
                            const line = lines[i].trim();
                            if (line) {
                                console.log(`Rij ${i}:`, line);
                                console.log(`Rij ${i} split op ;;:`, line.split(';;'));
                            }
                        }
                        
                        resolve(lines);
                    };
                    
                    reader.readAsText(file);
                });
            };

            // üî• Standaard CSV Upload Functions
            const handleCsvUpload = (file, contactType = 'investor') => {
                return new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: async (results) => {
                            try {
                                const data = results.data.map(row => ({
                                    firstName: row['First Name'] || row['Voornaam'] || '',
                                    lastName: row['Last Name'] || row['Achternaam'] || '',
                                    email: row['Email Address'] || row['E-mail'] || row['Email'] || '',
                                    company: row['Company'] || row['Bedrijf'] || '',
                                    position: row['Position'] || row['Functie'] || row['Job Title'] || '',
                                    linkedin: row['Profile URL'] || row['LinkedIn Profile URL'] || row['URL'] || row['Linkedin'] || '',
                                    contactType: contactType,
                                    importSource: 'standard_csv'
                                })).filter(item => item.firstName || item.lastName || item.email);
                                
                                setCsvData(data);
                                resolve(data);
                            } catch (error) {
                                reject(error);
                            }
                        },
                        error: (error) => {
                            reject(error);
                        }
                    });
                });
            };

            const uploadContactsToFirebase = async (contacts) => {
                if (!user) {
                    alert('Je moet ingelogd zijn om contacten te uploaden.');
                    return;
                }

                try {
                    setUploadProgress('Uploaden gestart...');
                    const batch = db.batch();
                    
                    let investorCount = 0;
                    let brokerCount = 0;

                    for (let i = 0; i < contacts.length; i++) {
                        const contact = contacts[i];
                        
                        // LinkedIn-specifieke velden toevoegen
                        const baseData = {
                            naam: `${contact.firstName} ${contact.lastName}`.trim(),
                            email: contact.email,
                            telefoon: '', 
                            bedrijf: contact.company,
                            locatie: '',
                            owner_id: user.id,
                            import_source: contact.importSource || 'csv_upload',
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        // LinkedIn-specifieke velden
                        if (contact.linkedin) {
                            baseData.linkedin = contact.linkedin;
                        }
                        if (contact.connectedOn) {
                            baseData.connectedOn = contact.connectedOn;
                        }

                        // Upload to investors collection
                        if (contact.contactType === 'investor' || contact.contactType === 'both') {
                            const investorData = {
                                ...baseData,
                                minBudget: 0,
                                maxBudget: 0,
                                gewenstRendement: 0,
                                risicoprofiel: 'Gemiddeld',
                                ervaringLevel: 'Gemiddeld',
                                vastgoedTypes: [],
                                projectTypes: [],
                                communicatieVoorkeur: 'Email',
                                beschikbaarheid: 'Direct',
                                investmentMotivatie: contact.position ? `Functie: ${contact.position}` : '',
                                bijzonderheden: contact.importSource === 'linkedin' ? 'Ge√Ømporteerd van LinkedIn' : ''
                            };
                            
                            const investorRef = db.collection('investors').doc();
                            batch.set(investorRef, investorData);
                            investorCount++;
                        }

                        // Upload to brokers collection
                        if (contact.contactType === 'broker' || contact.contactType === 'both') {
                            const brokerData = {
                                ...baseData,
                                specialisaties: [],
                                werkgebied: [],
                                ervaringJaren: 0,
                                trackRecord: contact.position || '',
                                commissieStructuur: '',
                                werkwijze: '',
                                bijzonderheden: contact.position ? `Functie: ${contact.position}` : 
                                                contact.importSource === 'linkedin' ? 'Ge√Ømporteerd van LinkedIn' : ''
                            };
                            
                            const brokerRef = db.collection('brokers').doc();
                            batch.set(brokerRef, brokerData);
                            brokerCount++;
                        }
                        
                        // Update progress
                        if (i % 10 === 0) {
                            setUploadProgress(`${i} van ${contacts.length} contacten verwerkt...`);
                        }
                    }
                    
                    await batch.commit();
                    
                    let successMessage = `‚úÖ Upload voltooid! `;
                    if (investorCount > 0) successMessage += `${investorCount} investeerders `;
                    if (brokerCount > 0) successMessage += `${brokerCount} brokers `;
                    successMessage += `toegevoegd.`;
                    
                    if (contacts[0]?.importSource === 'linkedin') {
                        successMessage += ' üî• LinkedIn connecties succesvol ge√Ømporteerd!';
                    }
                    
                    setUploadProgress(successMessage);
                    setCsvData([]);
                    
                    // Refresh data
                    setTimeout(() => {
                        loadData();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Upload error:', error);
                    setUploadProgress(`‚ùå Fout bij uploaden: ${error.message}`);
                }
            };

            const refreshContactsCount = async () => {
                if (!user) return;
                
                try {
                    const snapshot = await db.collection('contacts')
                        .where('owner_id', '==', user.id)
                        .get();
                    setContactsCount(snapshot.size);
                } catch (error) {
                    console.error('Error counting contacts:', error);
                }
            };

            // üî• ENHANCED MATCHING ALGORITHM WITH SEMANTIC ANALYSIS
            const calculateMatchScore = (investor, deal) => {
                let score = 0;
                let maxScore = 0;
                let reasoningFactors = [];

                // Budget matching (20% - reduced to make room for semantic)
                maxScore += 20;
                if (deal.prijs >= investor.minBudget && deal.prijs <= investor.maxBudget) {
                    score += 20;
                    reasoningFactors.push(`‚úì Budget perfect match (‚Ç¨${deal.prijs.toLocaleString()} binnen ‚Ç¨${investor.minBudget.toLocaleString()}-‚Ç¨${investor.maxBudget.toLocaleString()} range)`);
                } else if (deal.prijs < investor.minBudget) {
                    const budgetScore = Math.max(0, 20 - ((investor.minBudget - deal.prijs) / investor.minBudget * 20));
                    score += budgetScore;
                    reasoningFactors.push(`‚ö† Deal prijs onder minimum budget (${budgetScore.toFixed(1)}/20 punten)`);
                } else {
                    reasoningFactors.push(`‚úó Deal prijs boven maximum budget`);
                }

                // üî• SIMPLIFIED LOCATION MATCHING (15% - reduced)
                maxScore += 15;
                let locationScore = 0;
                
                // Check country match
                if ((investor.voorkeursLanden || []).some(land => 
                    deal.locatie.toLowerCase().includes(land.toLowerCase())
                )) {
                    locationScore = 15;
                    reasoningFactors.push(`‚úì Land match gevonden in locatie`);
                }
                // Check region match 
                else if ((investor.voorkeursRegio || []).length > 0) {
                    locationScore = 8;
                    reasoningFactors.push(`~ Regio voorkeur aanwezig`);
                }
                // Default geographic scope
                else {
                    locationScore = 5;
                    reasoningFactors.push(`~ Geen specifieke locatie eisen`);
                }
                
                score += locationScore;

                // Type vastgoed matching (15%)
                maxScore += 15;
                if ((investor.vastgoedTypes || []).includes(deal.type)) {
                    score += 15;
                    reasoningFactors.push(`‚úì Vastgoed type match (${deal.type})`);
                } else if ((investor.vastgoedTypes || []).length === 0) {
                    score += 7;
                    reasoningFactors.push(`~ Geen specifieke vastgoed type voorkeur`);
                } else {
                    reasoningFactors.push(`‚úó Vastgoed type niet in voorkeuren`);
                }

                // Project type matching (10%)
                maxScore += 10;
                if ((investor.projectTypes || []).includes(deal.projectType)) {
                    score += 10;
                    reasoningFactors.push(`‚úì Project type match (${deal.projectType})`);
                } else if ((investor.projectTypes || []).length === 0) {
                    score += 5;
                    reasoningFactors.push(`~ Geen specifieke project type voorkeur`);
                } else {
                    reasoningFactors.push(`‚úó Project type niet in voorkeuren`);
                }

                // Rendement matching (15%)
                maxScore += 15;
                if (deal.verwachtRendement >= investor.gewenstRendement) {
                    score += 15;
                    reasoningFactors.push(`‚úì Rendement boven verwachting (${deal.verwachtRendement}% vs ${investor.gewenstRendement}%)`);
                } else {
                    const rendementScore = Math.max(0, 15 - ((investor.gewenstRendement - deal.verwachtRendement) / investor.gewenstRendement * 15));
                    score += rendementScore;
                    reasoningFactors.push(`‚ö† Rendement onder verwachting (${rendementScore.toFixed(1)}/15 punten)`);
                }

                // Risico matching (10%)
                maxScore += 10;
                const risicoMatch = {
                    'Conservatief': { 'Laag': 10, 'Gemiddeld': 6, 'Hoog': 2 },
                    'Gemiddeld': { 'Laag': 8, 'Gemiddeld': 10, 'Hoog': 7 },
                    'Agressief': { 'Laag': 5, 'Gemiddeld': 8, 'Hoog': 10 }
                };
                const risicoScore = risicoMatch[investor.risicoprofiel]?.[deal.risico] || 0;
                score += risicoScore;
                reasoningFactors.push(`${risicoScore >= 8 ? '‚úì' : '‚ö†'} Risico match (${investor.risicoprofiel} profiel, ${deal.risico} risico)`);

                // üî• NEW: SEMANTIC MATCHING (15% - new powerful feature)
                maxScore += 15;
                let semanticScore = 0;
                let semanticReasons = [];
                
                const investorText = [
                    investor.investmentMotivatie || '',
                    investor.bijzonderheden || '',
                    investor.locatieDetails || ''
                ].join(' ').toLowerCase();
                
                const dealText = [
                    deal.beschrijving || '',
                    deal.bijzonderheden || ''
                ].join(' ').toLowerCase();

                // Semantic keyword matching
                const semanticMatches = [
                    { investor: ['stabiel', 'huurinkomst', 'gegarandeerd'], deal: ['gegarandeerd', 'huurder', 'corporatie'], points: 5, desc: 'Stabiele huurinkomsten match' },
                    { investor: ['turn-key', 'geen renovatie', 'kant-en-klaar'], deal: ['turn-key', 'kant-en-klaar', 'direct'], points: 4, desc: 'Turn-key voorkeur match' },
                    { investor: ['duurzaam', 'energie', 'milieu'], deal: ['energielabel', 'duurzaam', 'zonnepanel', 'warmtepomp'], points: 3, desc: 'Duurzaamheid match' },
                    { investor: ['student', 'universiteit'], deal: ['student', 'universiteit', 'campus'], points: 3, desc: 'Studenten segment match' },
                    { investor: ['centrum', 'bereikbaar', 'transport'], deal: ['centrum', 'metro', 'transport', 'bereikbaar'], points: 2, desc: 'Locatie bereikbaarheid match' }
                ];

                semanticMatches.forEach(match => {
                    const investorHasKeywords = match.investor.some(keyword => investorText.includes(keyword));
                    const dealHasKeywords = match.deal.some(keyword => dealText.includes(keyword));
                    
                    if (investorHasKeywords && dealHasKeywords) {
                        semanticScore += match.points;
                        semanticReasons.push(`‚úì ${match.desc}`);
                    }
                });

                // Conflict detection
                const conflicts = [
                    { investor: ['geen renovatie', 'turn-key'], deal: ['renovatie', 'opknappen'], desc: 'Renovatie conflict' },
                    { investor: ['centrum'], deal: ['buitenwijk', 'periferie'], desc: 'Locatie voorkeur conflict' }
                ];

                conflicts.forEach(conflict => {
                    const investorWants = conflict.investor.some(keyword => investorText.includes(keyword));
                    const dealOffers = conflict.deal.some(keyword => dealText.includes(keyword));
                    
                    if (investorWants && dealOffers) {
                        semanticScore -= 3;
                        semanticReasons.push(`‚ö† ${conflict.desc} gedetecteerd`);
                    }
                });

                score += Math.max(0, Math.min(15, semanticScore));
                reasoningFactors.push(...semanticReasons);

                const finalScore = Math.round((score / maxScore) * 100);
                
                return {
                    score: finalScore,
                    reasoning: reasoningFactors,
                    maxScore,
                    actualScore: score,
                    semanticScore: semanticScore,
                    semanticReasons: semanticReasons
                };
            };

            const findMatches = (dealId) => {
                const deal = deals.find(d => d.id === dealId);
                if (!deal) return [];

                return investors.map(investor => {
                    const matchResult = calculateMatchScore(investor, deal);
                    return {
                        investor,
                        deal,
                        matchScore: matchResult.score,
                        reasoning: matchResult.reasoning,
                        semanticScore: matchResult.semanticScore,
                        semanticReasons: matchResult.semanticReasons,
                        aiInsights: null
                    };
                }).sort((a, b) => b.matchScore - a.matchScore);
            };

            // üî• Enhanced CSV Upload Section met LinkedIn support
            const CsvUploadSection = () => {
                const [selectedFile, setSelectedFile] = React.useState(null);
                const [contactType, setContactType] = React.useState('investor');
                const [csvSource, setCsvSource] = React.useState('standard'); // 'standard' of 'linkedin'
                const [isUploading, setIsUploading] = React.useState(false);

                const handleFileSelect = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    setSelectedFile(file);
                    setUploadProgress('');
                    
                    try {
                        setIsUploading(true);
                        
                        // Eerst debug de structuur
                        await debugCSVStructure(file);
                        
                        let parsedData;
                        if (csvSource === 'linkedin') {
                            parsedData = await parseLinkedInCSV(file, contactType);
                        } else {
                            parsedData = await handleCsvUpload(file, contactType);
                        }
                        
                        setCsvData(parsedData);
                        setUploadProgress(`‚úÖ ${parsedData.length} contacten gevonden in CSV`);
                    } catch (error) {
                        console.error('CSV parsing error:', error);
                        setUploadProgress(`‚ùå Fout bij verwerken CSV: ${error.message}`);
                    } finally {
                        setIsUploading(false);
                    }
                };

                const handleUpload = () => {
                    if (csvData.length === 0) {
                        alert('Geen CSV data om te uploaden');
                        return;
                    }
                    setIsUploading(true);
                    uploadContactsToFirebase(csvData);
                    setIsUploading(false);
                };

                const clearData = () => {
                    setCsvData([]);
                    setSelectedFile(null);
                    setUploadProgress('');
                };

                return (
                    <div className="p-6 bg-white border-t border-gray-200 mt-8 rounded-lg shadow">
                        <h2 className="text-2xl font-semibold mb-4">Contacten CSV Upload</h2>
                        
                        {/* CSV Source Selectie */}
                        <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h3 className="font-medium text-blue-800 mb-2">üì• Kies CSV Type:</h3>
                            <div className="flex flex-wrap gap-4">
                                <label className="flex items-center space-x-2">
                                    <input 
                                        type="radio" 
                                        value="standard" 
                                        checked={csvSource === 'standard'}
                                        onChange={(e) => {
                                            setCsvSource(e.target.value);
                                            clearData();
                                        }}
                                        className="text-blue-600"
                                    />
                                    <span>Standaard CSV</span>
                                </label>
                                <label className="flex items-center space-x-2">
                                    <input 
                                        type="radio" 
                                        value="linkedin" 
                                        checked={csvSource === 'linkedin'}
                                        onChange={(e) => {
                                            setCsvSource(e.target.value);
                                            clearData();
                                        }}
                                        className="text-blue-600"
                                    />
                                    <span>üî• LinkedIn Connections Export</span>
                                </label>
                            </div>
                        </div>

                        <div className="flex flex-col md:flex-row md:items-center gap-3 mb-3">
                            <input 
                                type="file" 
                                accept=".csv" 
                                onChange={handleFileSelect}
                                className="p-2 border rounded w-full md:w-auto" 
                                disabled={isUploading}
                            />
                            <select 
                                value={contactType}
                                onChange={(e) => setContactType(e.target.value)}
                                className="p-2 border rounded"
                                disabled={isUploading}
                            >
                                <option value="investor">Investeerder</option>
                                <option value="broker">Broker</option>
                                <option value="both">Beiden</option>
                            </select>
                            <button 
                                onClick={handleUpload}
                                disabled={csvData.length === 0 || isUploading}
                                className="px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed flex items-center space-x-2"
                            >
                                {isUploading ? (
                                    <>
                                        <div className="loading-spinner h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                                        <span>Uploaden...</span>
                                    </>
                                ) : (
                                    <>
                                        <span>üì§</span>
                                        <span>Upload naar Firestore</span>
                                    </>
                                )}
                            </button>
                            {csvData.length > 0 && (
                                <button 
                                    onClick={clearData}
                                    className="px-5 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                                >
                                    Wissen
                                </button>
                            )}
                        </div>
                        
                        {uploadProgress && (
                            <div className={`mb-4 p-3 rounded border ${
                                uploadProgress.includes('‚úÖ') ? 'bg-green-50 border-green-200 text-green-700' : 
                                uploadProgress.includes('‚ùå') ? 'bg-red-50 border-red-200 text-red-700' :
                                'bg-blue-50 border-blue-200 text-blue-700'
                            }`}>
                                <p>{uploadProgress}</p>
                            </div>
                        )}
                        
                        {csvData.length > 0 && (
                            <div className="border rounded p-4 bg-gray-50">
                                <div className="flex justify-between items-center mb-2">
                                    <h3 className="font-medium">
                                        Voorbeeld van ge√ºploade data ({csvData.length} contacten)
                                        {csvSource === 'linkedin' && ' üî• LinkedIn Connecties'}
                                    </h3>
                                    <span className="text-sm text-gray-600">
                                        {contactType === 'both' ? 'Investeerders & Brokers' : 
                                         contactType === 'investor' ? 'Alleen Investeerders' : 'Alleen Brokers'}
                                    </span>
                                </div>
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-60 overflow-y-auto custom-scrollbar">
                                    {csvData.slice(0, 9).map((contact, index) => (
                                        <div key={index} className="p-3 bg-white rounded border text-sm">
                                            <div className="font-medium">
                                                {contact.firstName} {contact.lastName}
                                            </div>
                                            {contact.position && (
                                                <div className="text-gray-600">{contact.position}</div>
                                            )}
                                            {contact.company && (
                                                <div className="text-gray-600">@{contact.company}</div>
                                            )}
                                            {contact.email && (
                                                <div className="text-blue-600 truncate">{contact.email}</div>
                                            )}
                                            {contact.connectedOn && (
                                                <div className="text-xs text-gray-500">Connected: {contact.connectedOn}</div>
                                            )}
                                            <div className="text-xs text-gray-500 mt-1">
                                                Type: {contact.contactType === 'both' ? 'Investeerder & Broker' : contact.contactType}
                                                {contact.importSource === 'linkedin' && ' ‚Ä¢ üî• LinkedIn'}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                {csvData.length > 9 && (
                                    <p className="text-sm text-gray-500 mt-2">
                                        ... en nog {csvData.length - 9} contacten
                                    </p>
                                )}
                            </div>
                        )}
                        
                        {/* Instructies gebaseerd op geselecteerde CSV source */}
                        <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded">
                            <h4 className="font-semibold text-yellow-800 mb-2">
                                {csvSource === 'linkedin' ? 'üìã LinkedIn Connections Export' : 'üìã Standaard CSV'}
                            </h4>
                            
                            {csvSource === 'linkedin' ? (
                                <div className="text-sm text-yellow-700 space-y-2">
                                    <p><strong>Hoe LinkedIn connecties exporteren:</strong></p>
                                    <ol className="list-decimal list-inside space-y-1 ml-2">
                                        <li>Ga naar LinkedIn ‚Üí Mijn Netwerk</li>
                                        <li>Klik op "Connections" in linker menu</li>
                                        <li>Klik op "Exporteer connecties" (rechtsboven)</li>
                                        <li>Kies "CSV" formaat en download</li>
                                        <li>Upload het gedownloade CSV bestand hier</li>
                                    </ol>
                                    <p className="mt-2 text-xs">
                                        üî• <strong>Verbeterde parsing:</strong> Namen, bedrijven, functies en LinkedIn URLs worden automatisch herkend
                                    </p>
                                </div>
                            ) : (
                                <ul className="text-sm text-yellow-700 list-disc list-inside space-y-1">
                                    <li><code>First Name</code> / <code>Voornaam</code> (verplicht)</li>
                                    <li><code>Last Name</code> / <code>Achternaam</code> (verplicht)</li>
                                    <li><code>Email Address</code> / <code>Email</code> / <code>E-mail</code></li>
                                    <li><code>Company</code> / <code>Bedrijf</code></li>
                                    <li><code>Position</code> / <code>Functie</code> / <code>Job Title</code></li>
                                    <li><code>Profile URL</code> / <code>LinkedIn Profile URL</code> / <code>URL</code></li>
                                </ul>
                            )}
                        </div>
                    </div>
                );
            };

            // üî• LinkedIn Profile Button Component
            const LinkedInButton = ({ url }) => {
                const normalizedUrl = url ? (url.startsWith('http') ? url : `https://${url}`) : '';
                
                if (!normalizedUrl) return null;
                
                return (
                    <a 
                        href={normalizedUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="vm-linkedin-btn text-blue-700 hover:bg-gray-100 transition-colors"
                    >
                        <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                        Open LinkedIn-profiel
                    </a>
                );
            };

            // üî• Main Application Layout
            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center py-4">
                                <div>
                                    <h1 className="text-2xl font-bold text-gray-900">Vastgoed Matcher Pro AI</h1>
                                    <p className="text-gray-600 text-sm">Enhanced matching met AI semantic analysis</p>
                                </div>
                                <div className="flex items-center space-x-4">
                                    {user && (
                                        <>
                                            <span className="text-gray-700">{user.name}</span>
                                            <button 
                                                onClick={() => {
                                                    firebase.auth().signOut();
                                                    setUser(null);
                                                    setShowAuth(true);
                                                }}
                                                className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors"
                                            >
                                                Uitloggen
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        {showAuth ? (
                            <AuthForm 
                                onLogin={setUser}
                                onRegister={setUser}
                                onHideAuth={() => setShowAuth(false)}
                            />
                        ) : (
                            <>
                                {/* Navigation Tabs */}
                                <div className="mb-8">
                                    <div className="flex space-x-1 overflow-x-auto pb-2 custom-scrollbar">
                                        {[
                                            { id: 'dashboard', label: 'Dashboard', icon: 'üìä' },
                                            { id: 'investors', label: 'Contacten', icon: 'üë•' },
                                            { id: 'deals', label: 'Deals', icon: 'üè¢' },
                                            { id: 'matching', label: 'AI Matching', icon: 'ü§ñ' },
                                            { id: 'transactions', label: 'Transacties', icon: 'üí∞' },
                                            { id: 'csv-upload', label: 'CSV Upload', icon: 'üì§' }
                                        ].map(tab => (
                                            <button
                                                key={tab.id}
                                                onClick={() => setActiveTab(tab.id)}
                                                className={`px-4 py-3 rounded-lg flex items-center space-x-2 whitespace-nowrap transition-colors ${
                                                    activeTab === tab.id 
                                                        ? 'bg-blue-600 text-white shadow-md' 
                                                        : 'bg-white text-gray-700 hover:bg-gray-100 border'
                                                }`}
                                            >
                                                <span>{tab.icon}</span>
                                                <span>{tab.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Tab Content */}
                                <div className="bg-white rounded-lg shadow-sm border p-6">
                                    {activeTab === 'dashboard' && <Dashboard 
                                        user={user}
                                        investors={investors}
                                        brokers={brokers}
                                        deals={deals}
                                        transactions={transactions}
                                        users={users}
                                        getUserById={getUserById}
                                    />}
                                    
                                    {activeTab === 'investors' && <ContactsTab 
                                        investors={investors}
                                        brokers={brokers}
                                        contactFilter={contactFilter}
                                        setContactFilter={setContactFilter}
                                        user={user}
                                        getUserById={getUserById}
                                        setShowAddInvestor={setShowAddInvestor}
                                        setShowAddBroker={setShowAddBroker}
                                        handleEditInvestor={setEditingInvestor}
                                        handleDeleteInvestor={() => {}}
                                        handleEditBroker={setEditingBroker}
                                        handleDeleteBroker={() => {}}
                                        getInvestorInsights={() => {}}
                                        isLoadingAI={isLoadingAI}
                                    />}
                                    
                                    {activeTab === 'deals' && <DealsTab 
                                        deals={deals}
                                        user={user}
                                        setShowAddDeal={setShowAddDeal}
                                        handleEditDeal={setEditingDeal}
                                        handleDeleteDeal={() => {}}
                                        openCommissionEditor={setEditingDealCommission}
                                        setMatches={setMatches}
                                        setActiveTab={setActiveTab}
                                        getDealInsights={() => {}}
                                        isLoadingAI={isLoadingAI}
                                        getUserById={getUserById}
                                    />}
                                    
                                    {activeTab === 'matching' && <MatchingTab 
                                        matches={matches}
                                        deals={deals}
                                        setActiveTab={setActiveTab}
                                        createTransaction={() => {}}
                                        getSmartMatchingInsights={() => {}}
                                        isLoadingAI={isLoadingAI}
                                        getUserById={getUserById}
                                    />}
                                    
                                    {activeTab === 'transactions' && <TransactionsTab 
                                        transactions={transactions}
                                        deals={deals}
                                        investors={investors}
                                        getUserById={getUserById}
                                        calculateCommissionSummary={() => ({ totalCommission: 0, completedTransactions: 0, pendingTransactions: 0 })}
                                    />}
                                    
                                    {activeTab === 'csv-upload' && <CsvUploadSection />}
                                </div>
                            </>
                        )}
                    </main>

                    {/* Modals would go here */}
                    {showAddInvestor && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4">Nieuwe Investeerder Toevoegen</h3>
                                {/* Investor form content would go here */}
                                <div className="flex justify-end space-x-4 mt-6">
                                    <button 
                                        onClick={() => setShowAddInvestor(false)}
                                        className="px-4 py-2 text-gray-600 border rounded hover:bg-gray-100"
                                    >
                                        Annuleren
                                    </button>
                                    <button 
                                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                    >
                                        Toevoegen
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // üî• Auth Form Component
        const AuthForm = ({ onLogin, onRegister, onHideAuth }) => {
            const [isLogin, setIsLogin] = React.useState(true);
            const [formData, setFormData] = React.useState({
                email: '',
                password: '',
                name: '',
                company: ''
            });
            const [isLoading, setIsLoading] = React.useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                
                try {
                    if (isLogin) {
                        // Login logic
                        const userCredential = await firebase.auth().signInWithEmailAndPassword(
                            formData.email, 
                            formData.password
                        );
                        onLogin(userCredential.user);
                    } else {
                        // Register logic
                        const userCredential = await firebase.auth().createUserWithEmailAndPassword(
                            formData.email,
                            formData.password
                        );
                        
                        await firebase.firestore().collection('users').doc(userCredential.user.uid).set({
                            name: formData.name,
                            email: formData.email,
                            company: formData.company,
                            role: 'agent',
                            created_at: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        onRegister({ 
                            id: userCredential.user.uid, 
                            name: formData.name,
                            email: formData.email,
                            company: formData.company,
                            role: 'agent'
                        });
                    }
                    
                    onHideAuth();
                } catch (error) {
                    console.error('Auth error:', error);
                    alert(error.message);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4 sm:px-6 lg:px-8">
                    <div className="max-w-md w-full space-y-8 bg-white p-8 rounded-xl shadow-lg">
                        <div>
                            <h2 className="mt-6 text-center text-3xl font-extrabold text-gray-900">
                                {isLogin ? 'Welkom terug' : 'Account aanmaken'}
                            </h2>
                            <p className="mt-2 text-center text-sm text-gray-600">
                                {isLogin ? 'Log in op je account' : 'Maak een nieuw account aan'}
                            </p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
                            {!isLogin && (
                                <>
                                    <div>
                                        <label htmlFor="name" className="sr-only">Naam</label>
                                        <input
                                            id="name"
                                            name="name"
                                            type="text"
                                            required
                                            className="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                            placeholder="Volledige naam"
                                            value={formData.name}
                                            onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        />
                                    </div>
                                    <div>
                                        <label htmlFor="company" className="sr-only">Bedrijf</label>
                                        <input
                                            id="company"
                                            name="company"
                                            type="text"
                                            required
                                            className="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                            placeholder="Bedrijfsnaam"
                                            value={formData.company}
                                            onChange={(e) => setFormData({...formData, company: e.target.value})}
                                        />
                                    </div>
                                </>
                            )}
                            <div>
                                <label htmlFor="email" className="sr-only">Email adres</label>
                                <input
                                    id="email"
                                    name="email"
                                    type="email"
                                    autoComplete="email"
                                    required
                                    className="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                    placeholder="Email adres"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                />
                            </div>
                            <div>
                                <label htmlFor="password" className="sr-only">Wachtwoord</label>
                                <input
                                    id="password"
                                    name="password"
                                    type="password"
                                    autoComplete="current-password"
                                    required
                                    className="appearance-none rounded-md relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
                                    placeholder="Wachtwoord"
                                    value={formData.password}
                                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                                />
                            </div>

                            <div>
                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50"
                                >
                                    {isLoading ? (
                                        <div className="loading-spinner h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>
                                    ) : (
                                        isLogin ? 'Inloggen' : 'Account aanmaken'
                                    )}
                                </button>
                            </div>
                            
                            <div className="text-center">
                                <button
                                    type="button"
                                    onClick={() => setIsLogin(!isLogin)}
                                    className="text-blue-600 hover:text-blue-500 text-sm font-medium"
                                >
                                    {isLogin ? 'Geen account? Registreer hier' : 'Al een account? Login hier'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // üî• Dashboard Component
        const Dashboard = ({ user, investors, brokers, deals, transactions, users, getUserById }) => {
            const userInvestors = investors.filter(i => i.owner_id === user.id);
            const userBrokers = brokers.filter(b => b.owner_id === user.id);
            const userDeals = deals.filter(d => d.owner_id === user.id);
            
            const commissionSummary = {
                totalCommission: transactions.reduce((sum, t) => sum + (t.total_commission || 0), 0),
                completedTransactions: transactions.filter(t => t.status === 'completed').length,
                pendingTransactions: transactions.filter(t => t.status === 'pending').length,
                totalVolume: transactions.reduce((sum, t) => sum + (t.transaction_amount || 0), 0)
            };

            return (
                <div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-gray-600">Mijn Investeerders</p>
                                    <p className="text-2xl font-bold text-gray-900">{userInvestors.length}</p>
                                </div>
                                <div className="p-3 bg-blue-100 rounded-full">
                                    <span className="text-blue-600 text-xl">üë•</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-gray-600">Mijn Brokers</p>
                                    <p className="text-2xl font-bold text-gray-900">{userBrokers.length}</p>
                                </div>
                                <div className="p-3 bg-green-100 rounded-full">
                                    <span className="text-green-600 text-xl">üè¢</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-gray-600">Mijn Deals</p>
                                    <p className="text-2xl font-bold text-gray-900">{userDeals.length}</p>
                                </div>
                                <div className="p-3 bg-purple-100 rounded-full">
                                    <span className="text-purple-600 text-xl">üè¢</span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-medium text-gray-600">Transactie Volume</p>
                                    <p className="text-2xl font-bold text-gray-900">‚Ç¨{(commissionSummary.totalVolume / 1000000).toFixed(1)}M</p>
                                </div>
                                <div className="p-3 bg-orange-100 rounded-full">
                                    <span className="text-orange-600 text-xl">üìà</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                            <h3 className="text-lg font-semibold mb-4">Recente Transacties</h3>
                            <div className="space-y-3">
                                {transactions.slice(0, 5).map(transaction => {
                                    const deal = deals.find(d => d.id === transaction.deal_id);
                                    const investor = investors.find(i => i.id === transaction.investor_id);
                                    
                                    return (
                                        <div key={transaction.id} className="flex items-center justify-between p-3 bg-gray-50 rounded border">
                                            <div>
                                                <p className="font-medium">{deal?.titel || 'Onbekende Deal'}</p>
                                                <p className="text-sm text-gray-600">{investor?.naam || 'Onbekende Investeerder'}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-medium">‚Ç¨{transaction.transaction_amount?.toLocaleString() || '0'}</p>
                                                <p className={`text-xs ${transaction.status === 'completed' ? 'text-green-600' : 'text-yellow-600'}`}>
                                                    {transaction.status === 'completed' ? 'Afgerond' : 'Pending'}
                                                </p>
                                            </div>
                                        </div>
                                    );
                                })}
                                {transactions.length === 0 && (
                                    <p className="text-gray-500 text-center py-4">Nog geen transacties</p>
                                )}
                            </div>
                        </div>

                        <div className="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                            <h3 className="text-lg font-semibold mb-4">Team Leden</h3>
                            <div className="space-y-3">
                                {users.map(userItem => {
                                    const userInvestorCount = investors.filter(i => i.owner_id === userItem.id).length;
                                    const userDealCount = deals.filter(d => d.owner_id === userItem.id).length;
                                    return (
                                        <div key={userItem.id} className="flex items-center justify-between p-3 bg-gray-50 rounded border">
                                            <div className="flex items-center space-x-3">
                                                <div className="p-2 bg-blue-100 rounded-full">
                                                    <span className="text-blue-600">üë§</span>
                                                </div>
                                                <div>
                                                    <p className="font-medium">{userItem.name}</p>
                                                    <p className="text-sm text-gray-600">{userItem.company}</p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-sm">{userInvestorCount} investeerders</p>
                                                <p className="text-sm">{userDealCount} deals</p>
                                            </div>
                                        </div>
                                    );
                                })}
                                {users.length === 0 && (
                                    <p className="text-gray-500 text-center py-4">Nog geen teamleden</p>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // üî• Contacts Tab Component
        const ContactsTab = ({ 
            investors, 
            brokers, 
            contactFilter, 
            setContactFilter, 
            user, 
            getUserById,
            setShowAddInvestor,
            setShowAddBroker,
            handleEditInvestor,
            handleDeleteInvestor,
            handleEditBroker,
            handleDeleteBroker,
            getInvestorInsights,
            isLoadingAI
        }) => {
            return (
                <div>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <div>
                            <h2 className="text-2xl font-bold">üî• Contacten Beheer</h2>
                            <p className="text-gray-600 text-sm">Beheer investeerders en brokers in √©√©n overzicht</p>
                        </div>
                        <div className="flex space-x-2">
                            <button
                                onClick={() => setShowAddInvestor(true)}
                                className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
                            >
                                <span>+</span>
                                <span>üè¶ Investeerder</span>
                            </button>
                            <button
                                onClick={() => setShowAddBroker(true)}
                                className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-green-700 transition-colors"
                            >
                                <span>+</span>
                                <span>üè¢ Broker</span>
                            </button>
                        </div>
                    </div>

                    {/* Contact Filters */}
                    <div className="mb-6 bg-white p-4 rounded-lg shadow border">
                        <div className="flex flex-wrap items-center justify-between gap-4">
                            <div className="flex space-x-2">
                                <button
                                    onClick={() => setContactFilter('all')}
                                    className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                                        contactFilter === 'all' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    <span>üë•</span>
                                    <span>Alle Contacten ({investors.length + brokers.length})</span>
                                </button>
                                <button
                                    onClick={() => setContactFilter('investors')}
                                    className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                                        contactFilter === 'investors' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    <span>üè¶</span>
                                    <span>Investeerders ({investors.length})</span>
                                </button>
                                <button
                                    onClick={() => setContactFilter('brokers')}
                                    className={`px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors ${
                                        contactFilter === 'brokers' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    <span>üè¢</span>
                                    <span>Brokers ({brokers.length})</span>
                                </button>
                            </div>
                            
                            <div className="text-sm text-gray-600">
                                {contactFilter === 'all' && `${investors.length} investeerders ‚Ä¢ ${brokers.length} brokers`}
                                {contactFilter === 'investors' && `${investors.filter(i => i.owner_id === user.id).length} mijn investeerders ‚Ä¢ ${investors.length} totaal`}
                                {contactFilter === 'brokers' && `${brokers.filter(b => b.owner_id === user.id).length} mijn brokers ‚Ä¢ ${brokers.length} totaal`}
                            </div>
                        </div>
                    </div>

                    {/* Contacts Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {/* Investors */}
                        {(contactFilter === 'all' || contactFilter === 'investors') && 
                            investors.map(investor => (
                                <ContactCard 
                                    key={`investor-${investor.id}`}
                                    type="investor"
                                    data={investor}
                                    user={user}
                                    getUserById={getUserById}
                                    onEdit={handleEditInvestor}
                                    onDelete={handleDeleteInvestor}
                                    onAnalyze={getInvestorInsights}
                                    isLoadingAI={isLoadingAI}
                                />
                            ))
                        }

                        {/* Brokers */}
                        {(contactFilter === 'all' || contactFilter === 'brokers') && 
                            brokers.map(broker => (
                                <ContactCard 
                                    key={`broker-${broker.id}`}
                                    type="broker"
                                    data={broker}
                                    user={user}
                                    getUserById={getUserById}
                                    onEdit={handleEditBroker}
                                    onDelete={handleDeleteBroker}
                                    isLoadingAI={isLoadingAI}
                                />
                            ))
                        }
                    </div>

                    {/* Empty state */}
                    {((contactFilter === 'all' && investors.length === 0 && brokers.length === 0) ||
                        (contactFilter === 'investors' && investors.length === 0) ||
                        (contactFilter === 'brokers' && brokers.length === 0)) && (
                        <div className="text-center py-12">
                            <div className="text-4xl mb-4">üë•</div>
                            <div className="space-y-2">
                                <p className="text-gray-600 text-lg">
                                    {contactFilter === 'brokers' ? 'Nog geen brokers toegevoegd' : 
                                    contactFilter === 'investors' ? 'Nog geen investeerders toegevoegd' :
                                    'Nog geen contacten toegevoegd'}
                                </p>
                                <p className="text-sm text-gray-500">
                                    {contactFilter === 'brokers' ? 'Voeg brokers toe om je deal sourcing te verbeteren' :
                                    contactFilter === 'investors' ? 'Voeg investeerders toe om matches te kunnen maken' :
                                    'Voeg investeerders en brokers toe om te beginnen'}
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // üî• Contact Card Component
        const ContactCard = ({ type, data, user, getUserById, onEdit, onDelete, onAnalyze, isLoadingAI }) => {
            const isInvestor = type === 'investor';
            const isBroker = type === 'broker';
            
            return (
                <div className={`bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow ${
                    isBroker ? 'border-l-4 border-l-green-500' : ''
                }`}>
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center space-x-2">
                            <span className={`text-lg ${isInvestor ? 'text-blue-600' : 'text-green-600'}`}>
                                {isInvestor ? 'üè¶' : 'üè¢'}
                            </span>
                            <h3 className="text-xl font-semibold text-gray-900">{data.naam}</h3>
                        </div>
                        {isInvestor && data.risicoprofiel && (
                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                data.risicoprofiel === 'Conservatief' ? 'bg-green-100 text-green-800' :
                                data.risicoprofiel === 'Gemiddeld' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }`}>
                                {data.risicoprofiel}
                            </span>
                        )}
                        {isBroker && data.ervaringJaren && (
                            <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                                {data.ervaringJaren} jaar ervaring
                            </span>
                        )}
                    </div>

                    <div className="space-y-2 text-sm mb-4">
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üë§</span>
                            <span>Eigenaar: {getUserById(data.owner_id).name}</span>
                        </div>
                        {data.bedrijf && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">üè¢</span>
                                <span className="font-medium">{data.bedrijf}</span>
                            </div>
                        )}
                        {data.locatie && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">üìç</span>
                                <span>{isBroker ? 'Kantoor: ' : 'Gevestigd in: '}{data.locatie}</span>
                            </div>
                        )}
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üìß</span>
                            <span>{data.email}</span>
                        </div>
                        {isInvestor && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">üí∞</span>
                                <span>‚Ç¨{data.minBudget?.toLocaleString() || '0'} - ‚Ç¨{data.maxBudget?.toLocaleString() || '0'}</span>
                            </div>
                        )}
                        {isBroker && data.commissieStructuur && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">%</span>
                                <span>{data.commissieStructuur}</span>
                            </div>
                        )}
                    </div>

                    {data.linkedin && (
                        <div className="mb-3">
                            <LinkedInButton url={data.linkedin} />
                        </div>
                    )}

                    {data.import_source === 'linkedin' && (
                        <div className="mb-2">
                            <span className="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                                üî• LinkedIn Connectie
                            </span>
                            {data.connectedOn && (
                                <span className="ml-2 text-xs text-gray-500">
                                    Connected: {data.connectedOn}
                                </span>
                            )}
                        </div>
                    )}

                    {isInvestor && data.locatieDetails && (
                        <div className="mt-4 p-3 bg-purple-50 rounded border border-purple-200">
                            <p className="text-sm text-purple-800 font-medium mb-1">üó∫Ô∏è Locatie Details:</p>
                            <p className="text-xs text-purple-700">{data.locatieDetails}</p>
                        </div>
                    )}

                    {isInvestor && data.investmentMotivatie && (
                        <div className="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                            <p className="text-sm text-blue-800 font-medium mb-1">üéØ Investment Motivatie:</p>
                            <p className="text-xs text-blue-700">{data.investmentMotivatie}</p>
                        </div>
                    )}

                    {isBroker && data.trackRecord && (
                        <div className="mt-4 p-3 bg-green-50 rounded border border-green-200">
                            <p className="text-sm text-green-800 font-medium mb-1">üìà Track Record:</p>
                            <p className="text-xs text-green-700">{data.trackRecord}</p>
                        </div>
                    )}

                    {isBroker && data.werkwijze && (
                        <div className="mt-4 p-3 bg-blue-50 rounded border border-blue-200">
                            <p className="text-sm text-blue-800 font-medium mb-1">üéØ Werkwijze:</p>
                            <p className="text-xs text-blue-700">{data.werkwijze}</p>
                        </div>
                    )}

                    {(data.vastgoedTypes?.length > 0 || data.specialisaties?.length > 0) && (
                        <div className="mt-4">
                            <p className="text-sm text-gray-600 mb-2">
                                {isInvestor ? 'Interessegebieden:' : 'Specialisaties:'}
                            </p>
                            <div className="flex flex-wrap gap-1">
                                {(isInvestor ? data.vastgoedTypes : data.specialisaties)?.slice(0, 3).map(item => (
                                    <span key={item} className={`px-2 py-1 text-xs rounded-full ${
                                        isInvestor ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                                    }`}>
                                        {item}
                                    </span>
                                ))}
                                {(isInvestor ? data.vastgoedTypes : data.specialisaties)?.length > 3 && (
                                    <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                        +{(isInvestor ? data.vastgoedTypes : data.specialisaties).length - 3} meer
                                    </span>
                                )}
                            </div>
                        </div>
                    )}

                    <div className="mt-4 pt-4 border-t space-y-2">
                        {isInvestor && onAnalyze && (
                            <button
                                onClick={() => onAnalyze(data.id)}
                                disabled={isLoadingAI}
                                className="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                            >
                                <span>ü§ñ</span>
                                <span>{isLoadingAI ? 'AI Analyseert...' : 'AI Analyse'}</span>
                            </button>
                        )}
                        
                        <button
                            onClick={() => window.open(`mailto:${data.email}`)}
                            className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                        >
                            <span>üìß</span>
                            <span>Contact Opnemen</span>
                        </button>
                        
                        {(user.role === 'beheerder' || data.owner_id === user.id) && (
                            <div className="flex space-x-2">
                                <button
                                    onClick={() => onEdit(data)}
                                    className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                    <span>‚úèÔ∏è</span>
                                    <span>Bewerken</span>
                                </button>
                                <button
                                    onClick={() => onDelete(data.id)}
                                    className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                    <span>üóëÔ∏è</span>
                                    <span>Verwijderen</span>
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // üî• Deals Tab Component
        const DealsTab = ({ 
            deals, 
            user, 
            setShowAddDeal, 
            handleEditDeal, 
            handleDeleteDeal, 
            openCommissionEditor, 
            setMatches, 
            setActiveTab, 
            getDealInsights, 
            isLoadingAI,
            getUserById 
        }) => {
            return (
                <div>
                    <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <h2 className="text-2xl font-bold">Deals</h2>
                        <button
                            onClick={() => setShowAddDeal(true)}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
                        >
                            <span>+</span>
                            <span>Nieuwe Deal</span>
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {deals.map(deal => (
                            <DealCard 
                                key={deal.id}
                                deal={deal}
                                user={user}
                                getUserById={getUserById}
                                onEdit={handleEditDeal}
                                onDelete={handleDeleteDeal}
                                onCommission={openCommissionEditor}
                                onMatch={() => {
                                    // This would need the findMatches function
                                    setActiveTab('matching');
                                }}
                                onAnalyze={getDealInsights}
                                isLoadingAI={isLoadingAI}
                            />
                        ))}
                    </div>
                    
                    {deals.length === 0 && (
                        <div className="text-center py-12">
                            <div className="text-4xl mb-4">üè¢</div>
                            <div className="space-y-2">
                                <p className="text-gray-600 text-lg">Nog geen deals toegevoegd</p>
                                <p className="text-sm text-gray-500">Voeg deals toe om matches te kunnen maken met investeerders</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // üî• Deal Card Component
        const DealCard = ({ 
            deal, 
            user, 
            getUserById, 
            onEdit, 
            onDelete, 
            onCommission, 
            onMatch, 
            onAnalyze, 
            isLoadingAI 
        }) => {
            return (
                <div className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-xl font-semibold text-gray-900">{deal.titel}</h3>
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            deal.risico === 'Laag' ? 'bg-green-100 text-green-800' :
                            deal.risico === 'Gemiddeld' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }`}>
                            {deal.risico} risico
                        </span>
                    </div>

                    <div className="space-y-2 text-sm mb-4">
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üë§</span>
                            <span>Eigenaar: {getUserById(deal.owner_id).name}</span>
                        </div>
                        {deal.bedrijfFonds && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">üè¢</span>
                                <span className="font-medium">{deal.bedrijfFonds}</span>
                            </div>
                        )}
                        {deal.contactpersoon && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">üë§</span>
                                <span>{deal.contactpersoon}</span>
                            </div>
                        )}
                        {deal.telefoon && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">üìû</span>
                                <span>{deal.telefoon}</span>
                            </div>
                        )}
                        {deal.email && (
                            <div className="flex items-center space-x-2">
                                <span className="text-gray-500">üìß</span>
                                <span>{deal.email}</span>
                            </div>
                        )}
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üìç</span>
                            <span>{deal.locatie}</span>
                        </div>
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üè¢</span>
                            <span>{deal.type}</span>
                        </div>
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üéØ</span>
                            <span>{deal.projectType}</span>
                        </div>
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üí∞</span>
                            <span className="font-semibold">‚Ç¨{deal.prijs?.toLocaleString() || '0'}</span>
                        </div>
                        <div className="flex items-center space-x-2">
                            <span className="text-gray-500">üìà</span>
                            <span className="font-semibold text-green-600">{deal.verwachtRendement || '0'}% rendement</span>
                        </div>
                    </div>

                    {deal.commissionStructure && (
                        <div className="mb-4 p-3 bg-gray-50 rounded border">
                            <div className="flex items-center justify-between mb-2">
                                <span className="text-sm font-medium text-gray-700">Commissie Structuur</span>
                                <span className="text-sm text-gray-600">
                                    {(deal.commissionStructure.total_rate * 100).toFixed(2)}%
                                </span>
                            </div>
                            <div className="text-xs text-gray-600">
                                {deal.commissionStructure.participants?.length || 0} deelnemers geconfigureerd
                            </div>
                        </div>
                    )}

                    <p className="text-sm text-gray-600 mb-4">{deal.beschrijving}</p>

                    {deal.bijzonderheden && (
                        <div className="mb-4 p-3 bg-purple-50 rounded border border-purple-200">
                            <p className="text-sm text-purple-800 font-medium mb-1">üî• Bijzonderheden:</p>
                            <p className="text-xs text-purple-700">{deal.bijzonderheden}</p>
                        </div>
                    )}

                    <div className="space-y-2">
                        <button
                            onClick={onMatch}
                            className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                        >
                            <span>‚≠ê</span>
                            <span>üî• Enhanced Matches</span>
                        </button>
                        
                        <div className="flex space-x-2">
                            <button
                                onClick={() => onAnalyze(deal.id)}
                                disabled={isLoadingAI}
                                className="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                            >
                                <span>ü§ñ</span>
                                <span>{isLoadingAI ? 'AI...' : 'AI Analyse'}</span>
                            </button>
                            
                            <button
                                onClick={() => onCommission(deal)}
                                className="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center space-x-2"
                            >
                                <span>%</span>
                                <span>Commissie</span>
                            </button>
                        </div>

                        {(user.role === 'beheerder' || deal.owner_id === user.id) && (
                            <div className="flex space-x-2">
                                <button
                                    onClick={() => onEdit(deal)}
                                    className="flex-1 bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                    <span>‚úèÔ∏è</span>
                                    <span>Bewerken</span>
                                </button>
                                <button
                                    onClick={() => onDelete(deal.id)}
                                    className="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center space-x-2"
                                >
                                    <span>üóëÔ∏è</span>
                                    <span>Verwijderen</span>
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // üî• Matching Tab Component
        const MatchingTab = ({ matches, deals, setActiveTab, createTransaction, getSmartMatchingInsights, isLoadingAI, getUserById }) => {
            return (
                <div>
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold mb-4">üî• Enhanced AI-Powered Matching</h2>
                        
                        {matches.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="text-4xl mb-4">‚ö†Ô∏è</div>
                                <div className="space-y-2">
                                    <p className="text-gray-600 text-lg">Selecteer een deal om enhanced AI-powered matches te vinden</p>
                                    <p className="text-sm text-gray-500">
                                        üî• Enhanced Features: Semantic matching van beschrijvingen, vrije tekst analyse, conflict detectie
                                    </p>
                                </div>
                            </div>
                        ) : (
                            <div>
                                <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-lg p-6 mb-6">
                                    <h4 className="font-semibold text-purple-800 mb-3">üî• Enhanced AI Matching Features:</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-purple-700">
                                        <div className="space-y-2">
                                            <p>‚Ä¢ üó∫Ô∏è Vereenvoudigde locatie matching</p>
                                            <p>‚Ä¢ ü§ñ Semantic text analyse van beschrijvingen</p>
                                            <p>‚Ä¢ üí¨ Vrije tekst input matching</p>
                                            <p>‚Ä¢ ‚ö†Ô∏è Conflict detectie tussen wensen en aanbod</p>
                                        </div>
                                        <div className="space-y-2">
                                            <p>‚Ä¢ üéØ Intelligente keyword matching</p>
                                            <p>‚Ä¢ üìù Investment motivatie vs deal beschrijving</p>
                                            <p>‚Ä¢ üöÄ Enhanced compatibility scoring</p>
                                            <p>‚Ä¢ üí∞ Flexibele commissie structuren</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-blue-50 p-6 rounded-lg mb-6">
                                    <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center">
                                        <div className="mb-4 lg:mb-0">
                                            <h3 className="font-semibold text-lg mb-2">üéØ Deal: {matches[0]?.deal?.titel}</h3>
                                            <p className="text-sm text-gray-600 mb-2">{matches[0]?.deal?.beschrijving}</p>
                                            {matches[0]?.deal?.bijzonderheden && (
                                                <p className="text-sm text-purple-600 mb-2">üî• {matches[0]?.deal?.bijzonderheden}</p>
                                            )}
                                            <div className="flex flex-wrap items-center gap-4 text-sm">
                                                <span className="text-blue-600 font-medium">Deal eigenaar: {getUserById(matches[0]?.deal?.owner_id).name}</span>
                                                {matches[0]?.deal?.bedrijfFonds && (
                                                    <span className="text-gray-600">Bedrijf/Fonds: {matches[0]?.deal?.bedrijfFonds}</span>
                                                )}
                                                <span className="text-gray-600">Type: {matches[0]?.deal?.type}</span>
                                                <span className="text-gray-600">Project: {matches[0]?.deal?.projectType}</span>
                                            </div>
                                        </div>
                                        <div className="text-center lg:text-right">
                                            <div className="text-3xl font-bold text-blue-600">{matches.length}</div>
                                            <div className="text-sm text-gray-600">Enhanced Matches</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    {matches.map((match, index) => (
                                        <MatchCard 
                                            key={match.investor.id}
                                            match={match}
                                            index={index}
                                            onCreateTransaction={createTransaction}
                                            onAnalyze={getSmartMatchingInsights}
                                            isLoadingAI={isLoadingAI}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // üî• Match Card Component
        const MatchCard = ({ match, index, onCreateTransaction, onAnalyze, isLoadingAI }) => {
            const getMatchColor = (score) => {
                if (score >= 80) return 'text-green-600 bg-green-100';
                if (score >= 60) return 'text-yellow-600 bg-yellow-100';
                return 'text-red-600 bg-red-100';
            };

            return (
                <div className="bg-white rounded-lg shadow-md p-6 border hover:shadow-lg transition-shadow">
                    <div className="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4">
                        <div className="flex items-center space-x-4 mb-4 lg:mb-0">
                            <div className="flex items-center space-x-2">
                                <span className={`text-2xl font-bold ${
                                    index === 0 ? 'text-yellow-500' : 
                                    index === 1 ? 'text-gray-400' : 
                                    index === 2 ? 'text-orange-400' : 'text-gray-600'
                                }`}>
                                    #{index + 1}
                                </span>
                                <div>
                                    <h3 className="text-xl font-semibold">{match.investor.naam}</h3>
                                    <p className="text-sm text-gray-600">{match.investor.bedrijf}</p>
                                </div>
                            </div>
                        </div>
                        <div className="flex items-center space-x-4">
                            <span className={`px-4 py-2 rounded-full text-lg font-bold ${getMatchColor(match.matchScore)}`}>
                                {match.matchScore}% match
                            </span>
                            {match.semanticScore > 0 && (
                                <span className="px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium">
                                    üî• +{match.semanticScore} semantic
                                </span>
                            )}
                            <button
                                onClick={() => onCreateTransaction(match.deal.id, match.investor.id)}
                                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
                            >
                                <span>üí∞</span>
                                <span>Start Deal</span>
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <h4 className="font-semibold mb-3">üî• Enhanced Match Analyse:</h4>
                            <div className="space-y-2">
                                {match.reasoning.map((reason, idx) => (
                                    <div key={idx} className="text-sm p-2 bg-gray-50 rounded">
                                        {reason}
                                    </div>
                                ))}
                                {match.semanticReasons && match.semanticReasons.length > 0 && (
                                    <div className="mt-3">
                                        <p className="text-sm font-medium text-purple-700 mb-2">ü§ñ Semantic Matches:</p>
                                        {match.semanticReasons.map((reason, idx) => (
                                            <div key={idx} className="text-sm p-2 bg-purple-50 rounded border border-purple-200">
                                                {reason}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div>
                            <h4 className="font-semibold mb-3">Investeerder Details:</h4>
                            <div className="space-y-2 text-sm">
                                {match.investor.bedrijf && <p>Bedrijf: {match.investor.bedrijf}</p>}
                                <p>Budget: ‚Ç¨{match.investor.minBudget?.toLocaleString() || '0'} - ‚Ç¨{match.investor.maxBudget?.toLocaleString() || '0'}</p>
                                <p>Gewenst rendement: {match.investor.gewenstRendement || '0'}%</p>
                                <p>Risicoprofiel: {match.investor.risicoprofiel}</p>
                                <p>Ervaring: {match.investor.ervaringLevel}</p>
                                <p>Beschikbaarheid: {match.investor.beschikbaarheid}</p>
                                {match.investor.locatieDetails && (
                                    <div className="mt-2 p-2 bg-blue-50 rounded border border-blue-200">
                                        <p className="font-medium text-blue-800">Locatie Details:</p>
                                        <p className="text-blue-700">{match.investor.locatieDetails}</p>
                                    </div>
                                )}
                                {match.investor.investmentMotivatie && (
                                    <div className="mt-2 p-2 bg-green-50 rounded border border-green-200">
                                        <p className="font-medium text-green-800">Investment Motivatie:</p>
                                        <p className="text-green-700">{match.investor.investmentMotivatie}</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="mt-6 flex flex-wrap gap-2">
                        <button
                            onClick={() => onAnalyze(match.deal.id, match.investor.id)}
                            disabled={isLoadingAI}
                            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2"
                        >
                            <span>ü§ñ</span>
                            <span>{isLoadingAI ? 'AI Analyseert...' : 'üî• Enhanced AI Analyse'}</span>
                        </button>
                        <button
                            onClick={() => window.open(`mailto:${match.investor.email}`)}
                            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2"
                        >
                            <span>üìß</span>
                            <span>Contact</span>
                        </button>
                    </div>
                </div>
            );
        };

        // üî• Transactions Tab Component
        const TransactionsTab = ({ transactions, deals, investors, getUserById, calculateCommissionSummary }) => {
            const summary = calculateCommissionSummary();
            
            return (
                <div>
                    <div className="mb-6">
                        <h2 className="text-2xl font-bold mb-4">Transacties & Commissies</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-white p-4 rounded-lg shadow border">
                                <h3 className="font-semibold text-gray-700">Totale Commissie</h3>
                                <p className="text-2xl font-bold text-green-600">
                                    ‚Ç¨{summary.totalCommission.toLocaleString()}
                                </p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border">
                                <h3 className="font-semibold text-gray-700">Afgeronde Deals</h3>
                                <p className="text-2xl font-bold text-blue-600">
                                    {summary.completedTransactions}
                                </p>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow border">
                                <h3 className="font-semibold text-gray-700">Pending Deals</h3>
                                <p className="text-2xl font-bold text-yellow-600">
                                    {summary.pendingTransactions}
                                </p>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-6">
                        {transactions.map(transaction => {
                            const deal = deals.find(d => d.id === transaction.deal_id);
                            const investor = investors.find(i => i.id === transaction.investor_id);
                            
                            return (
                                <div key={transaction.id} className="bg-white rounded-lg shadow-md p-6 border">
                                    <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4">
                                        <div>
                                            <h3 className="text-xl font-semibold mb-2">
                                                {deal?.titel || 'Onbekende Deal'}
                                            </h3>
                                            <div className="flex flex-wrap items-center gap-4 text-sm text-gray-600">
                                                <span>Investeerder: {investor?.naam || 'Onbekend'}</span>
                                                <span>Waarde: ‚Ç¨{transaction.transaction_amount?.toLocaleString() || '0'}</span>
                                                <span>Commissie: ‚Ç¨{transaction.total_commission?.toLocaleString() || '0'}</span>
                                            </div>
                                        </div>
                                        <div className="mt-4 lg:mt-0">
                                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                                                transaction.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                                            }`}>
                                                {transaction.status === 'completed' ? 'Afgerond' : 'Pending'}
                                            </span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div>
                                            <h4 className="font-semibold mb-3">Deal Details:</h4>
                                            <div className="space-y-2 text-sm">
                                                {deal?.bedrijfFonds && <p>Bedrijf/Fonds: {deal.bedrijfFonds}</p>}
                                                <p>Locatie: {deal?.locatie || 'Onbekend'}</p>
                                                <p>Type: {deal?.type || 'Onbekend'}</p>
                                                <p>Project: {deal?.projectType || 'Onbekend'}</p>
                                                <p>Verwacht rendement: {deal?.verwachtRendement || 0}%</p>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold mb-3">Commissie Verdeling:</h4>
                                            <div className="space-y-2">
                                                {/* Commission distribution would go here */}
                                                <div className="text-sm p-2 bg-gray-50 rounded">
                                                    Commissie details worden geladen...
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        
                        {transactions.length === 0 && (
                            <div className="text-center py-12">
                                <div className="text-4xl mb-4">üí∞</div>
                                <div className="space-y-2">
                                    <p className="text-gray-600 text-lg">Nog geen transacties</p>
                                    <p className="text-sm text-gray-500">Start deals om transacties en commissies te zien</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Initialize the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(VastgoedInvesteerderMatcher));

        console.log('üöÄ Vastgoed Matcher Pro AI - Enhanced Semantic + Broker Versie geladen!');
    </script>
</body>
</html>
